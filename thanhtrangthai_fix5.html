<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;800&display=swap');

/* =========================================================
   01) Biến chủ đề: Hoàng hôn (Tông màu thống nhất toàn trang)
   ========================================================= */
:root{
  /* Nền cơ sở (Nâu tím hoàng hôn → Đêm tối) */
  --bg-primary: #1a0e14;
  --bg-secondary: #12070b;

  /* Bảng/Thẻ: Kính màu ấm */
  --bg-card: rgba(44, 22, 18, 0.76);
  --bg-hover: rgba(60, 30, 22, 0.84);
  --bg-input: rgba(10, 4, 6, 0.35);

  /* Màu chủ đạo: Vàng cam hoàng hôn (Mượt mà hơn, không chói) */
  --gold-primary: #ffd2a2;
  --gold-secondary: #ffb05a;
  --gold-dark: #b56b2b;
  --gold-glow: rgba(255, 176, 90, 0.20);

  /* Ráng chiều: Cam + Hồng */
  --sunset-orange: #ff8746;
  --sunset-pink: #ff6b8f;

  /* Điểm nhấn: Đỏ son */
  --red-accent: #d85a47;
  --red-glow: rgba(216, 90, 71, 0.16);

  /* Điểm nhấn: Xanh ngọc hoàng hôn (Bền màu hơn) */
  --jade-green: #79b2a3;
  --jade-glow: rgba(121, 178, 163, 0.16);

  /* Văn bản: Hệ thống trắng ấm */
  --text-primary: #f4eadc;
  --text-secondary: #d7c3aa;
  --text-muted: #a48a74;

  /* Viền/Bóng đổ */
  --border-gold: rgba(255, 176, 90, 0.75);
  --border-inner: rgba(255, 210, 162, 0.10);
  --border-dark: rgba(170, 110, 75, 0.28);

  --shadow-deep: 0 12px 42px rgba(0, 0, 0, 0.45);
  --shadow-glow: 0 0 22px rgba(255, 176, 90, 0.12);

  /* Bo góc thống nhất */
  --radius-lg: 14px;
  --radius-md: 12px;
  --radius-sm: 10px;
}

/* =========================================================
   02) Cơ sở toàn cục
   ========================================================= */
*{ margin:0; padding:0; box-sizing:border-box; }

html, body{
  min-height: 100%;
}

body {
  font-family: 'Noto Serif', serif; /* Đã đổi sang phông hỗ trợ tiếng Việt */
  color: var(--text-primary);
  background-color: var(--bg-primary);

  /* Bầu trời hoàng hôn "đậm đà" hơn: Đĩa mặt trời rõ ràng + Mây ráng có lớp lang + Đường chân trời ổn định */
  background-image:
    /* Đĩa mặt trời (Sáng hơn, tập trung hơn) */
    radial-gradient(circle 360px at 50% 16%,
      rgba(255, 210, 162, 0.46) 0%,
      rgba(255, 135, 70, 0.38) 34%,
      rgba(255, 107, 143, 0.18) 56%,
      transparent 74%),

    /* Ánh sáng dịu rìa ngoài mặt trời */
    radial-gradient(circle 240px at 52% 18%,
      rgba(255, 235, 205, 0.12) 0%,
      transparent 68%),

    /* Dải mây ráng chính (Lớp trên) */
    radial-gradient(ellipse 140% 54% at 50% 20%,
      rgba(255, 135, 70, 0.22) 0%,
      rgba(255, 107, 143, 0.10) 42%,
      transparent 72%),

    /* Dải mây ráng phụ (Màu bổ sung hai bên) */
    radial-gradient(ellipse 160% 60% at 30% 14%,
      rgba(255, 107, 143, 0.12) 0%,
      transparent 64%),
    radial-gradient(ellipse 160% 60% at 70% 12%,
      rgba(255, 210, 162, 0.10) 0%,
      transparent 66%),

    /* Đường chân trời đến đêm tối (Hiệu ứng "Hoàng hôn → Đêm" rõ rệt hơn) */
    linear-gradient(180deg,
      rgba(64, 22, 30, 0.96) 0%,
      rgba(34, 16, 20, 1) 46%,
      rgba(14, 6, 10, 1) 100%),

    /* Góc tối bảo vệ mắt (Ổn định hơn một chút) */
    radial-gradient(ellipse at 50% 52%,
      transparent 30%,
      rgba(0,0,0,0.56) 100%);

  background-attachment: fixed;
}

/* Vân nhẹ (Giảm cảm giác "mảng màu thuần" cứng nhắc) */
body::before{
  content:"";
  position: fixed;
  inset: 0;
  pointer-events:none;
  z-index: 0;
  opacity: 0.12;
  background-image:
    repeating-linear-gradient(0deg,
      rgba(255,255,255,0.035) 0px,
      rgba(255,255,255,0.035) 1px,
      transparent 2px,
      transparent 4px),
    repeating-linear-gradient(90deg,
      rgba(0,0,0,0.050) 0px,
      rgba(0,0,0,0.050) 1px,
      transparent 2px,
      transparent 5px);
  mix-blend-mode: overlay;
}

.container{
  max-width: 800px;
  margin: 0 auto;
  padding: 12px;
  position: relative;
  z-index: 1;
  min-height: 100vh;   /* ⭐Quan trọng: Ngăn chiều cao không đủ bị cắt */
}

/* =========================================================
   02.5) Tăng cường quan trọng: "Bảng nền hoàng hôn + Núi xa ẩn hiện" cho nội dung (Không đổi cấu trúc, dùng phần tử giả)
   ========================================================= */
.container::before{
  content:"";
  position:absolute;
  inset: 6px;
  z-index: -1;
  pointer-events:none;
  border-radius: 22px;

  /* Bảng nền (Kính màu ấm đậm hơn) + Bóng núi xa (Ẩn hiện) */
  background:
    /* Ánh ráng bảng mặt (Phía trên) */
    radial-gradient(circle 620px at 50% -10%,
      rgba(255, 135, 70, 0.34) 0%,
      rgba(255, 107, 143, 0.16) 36%,
      rgba(0,0,0,0.00) 72%),

    /* Ánh sáng ấm thứ cấp (Giữa) */
    radial-gradient(circle 760px at 50% 32%,
      rgba(255, 210, 162, 0.14) 0%,
      rgba(0,0,0,0.00) 64%),

    /* Bóng núi xa (Ẩn hiện: Ba đoạn núi, đáy tối hơn) */
    radial-gradient(ellipse 300px 110px at 14% 102%,
      rgba(0,0,0,0.42) 0%,
      rgba(0,0,0,0.00) 72%),
    radial-gradient(ellipse 420px 150px at 48% 106%,
      rgba(0,0,0,0.46) 0%,
      rgba(0,0,0,0.00) 74%),
    radial-gradient(ellipse 320px 120px at 82% 102%,
      rgba(0,0,0,0.40) 0%,
      rgba(0,0,0,0.00) 72%),

    /* Nền bảng (Trên ấm dưới tối, nâng đỡ nội dung) */
    linear-gradient(180deg,
      rgba(96, 40, 26, 0.62) 0%,
      rgba(28, 12, 16, 0.74) 58%,
      rgba(10, 5, 8, 0.86) 100%),

    /* Góc tối nhẹ, làm nội dung tập trung hơn */
    radial-gradient(ellipse at 50% 52%,
      rgba(0,0,0,0.00) 30%,
      rgba(0,0,0,0.50) 100%);

  border: 1px solid rgba(255,176,90,0.26);
  box-shadow:
    0 26px 90px rgba(0,0,0,0.58),
    0 0 40px rgba(255,176,90,0.10);

  backdrop-filter: blur(10px);
}

.container::after{
  content:"";
  position:absolute;
  inset: 14px;
  z-index: -1;
  pointer-events:none;
  border-radius: 18px;

  /* Viền trong + Vân giấy cực nhẹ (Cảm giác "khung tranh/cuộn tranh" hơn) */
  border: 1px solid rgba(255,210,162,0.10);
  box-shadow:
    inset 0 0 0 1px rgba(0,0,0,0.28),
    inset 0 0 30px rgba(255,176,90,0.06);

  background-image:
    repeating-linear-gradient(0deg,
      rgba(255,255,255,0.018) 0px,
      rgba(255,255,255,0.018) 1px,
      transparent 2px,
      transparent 6px);
  opacity: 0.95;
}

/* Thích ứng điện thoại: Bảng nền khít hơn */
@media (max-width: 480px){
  .container::before{ inset: 4px; border-radius: 18px; }
  .container::after{ inset: 10px; border-radius: 14px; }
}

/* =========================================================
   03) Hiệu ứng động (Không đổi chức năng, chỉ đổi cảm quan)
   ========================================================= */
@keyframes glow{
  0%,100%{ box-shadow: var(--shadow-deep), 0 0 18px var(--gold-glow); }
  50%{ box-shadow: var(--shadow-deep), 0 0 30px var(--gold-glow), 0 0 52px rgba(255,135,70,0.12); }
}
@keyframes fadeIn{
  from{ opacity:0; transform: translateY(12px); }
  to{ opacity:1; transform: translateY(0); }
}

/* =========================================================
   04) Giao diện thống nhất Bảng/Thẻ (Giảm cạnh cứng)
   ========================================================= */
.header,
.nav-tabs,
.list-item,
.asset-card,
.profile-card,
.modal-content,
.guixin-panel,
.rule-block,
.tech-lock-notice,
.formula-item,
.storage-item,
.troop-card,
.profile-stat,
.reward-item,
.person-stat,
.output-box,
.delete-item{
  background: linear-gradient(180deg,
    rgba(76, 34, 24, 0.68) 0%,
    rgba(18, 8, 10, 0.66) 100%);
  border: 1px solid rgba(255, 176, 90, 0.22);
  box-shadow: var(--shadow-deep);
}

/* Bo góc thống nhất */
.header,
.nav-tabs,
.list-item,
.asset-card,
.profile-card,
.modal-content,
.guixin-panel{ border-radius: var(--radius-lg); }

/* =========================================================
   05) Đầu trang Header
   ========================================================= */
.header{
  text-align:center;
  padding: 20px 20px 16px;
  margin-bottom: 12px;
  position: relative;
  backdrop-filter: blur(12px);
  border-color: var(--border-gold);
  box-shadow: var(--shadow-deep), var(--shadow-glow);
}
.header::before{
  content:'';
  position:absolute;
  inset: 6px;
  border: 1px solid var(--border-inner);
  border-radius: calc(var(--radius-lg) - 4px);
  pointer-events:none;
}
.header::after{
  content:'';
  position:absolute;
  bottom:0;
  left:50%;
  transform: translateX(-50%);
  width: 62%;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--sunset-orange), var(--gold-primary), var(--sunset-orange), transparent);
  opacity: 0.7;
}

.header-title{
  font-size: 20px;
  font-weight: 700;
  color: var(--gold-primary);
  letter-spacing: 6px;
  text-shadow: 0 0 18px rgba(255, 176, 90, 0.20), 0 2px 6px rgba(0,0,0,0.40);
}

/* Chữ gradient: Chỉ bật khi hỗ trợ, tránh tương thích làm mất chữ */
@supports (-webkit-background-clip: text){
  .header-title{
    background: linear-gradient(180deg,
      #ffe9cf 0%,
      var(--gold-primary) 36%,
      var(--gold-secondary) 72%,
      rgba(255,107,143,0.92) 120%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
  }
}

.header-subtitle{
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 6px;
  letter-spacing: 3px;
  opacity: 0.88;
}

/* =========================================================
   06) Điều hướng đỉnh: Điều khiển phân đoạn trượt (Không sửa HTML/Chức năng)
   ========================================================= */
.nav-tabs{
  --tab-count: 5;
  --active-index: 0;
  display:flex;
  gap:0;
  align-items: stretch;
  justify-content: stretch;
  padding: 4px;
  margin-bottom: 16px;
  position: relative;
  overflow: hidden;
  backdrop-filter: blur(12px);
}

.nav-tabs::before{
  content:"";
  position:absolute;
  top: 4px; bottom: 4px; left: 4px;
  width: calc((100% - 8px) / var(--tab-count));
  transform: translateX(calc(var(--active-index) * 100%));
  border-radius: calc(var(--radius-lg) - 4px);
  background: linear-gradient(180deg, rgba(255,210,162,0.18), rgba(255,135,70,0.10));
  border: 1px solid rgba(255,210,162,0.16);
  box-shadow: 0 10px 22px rgba(0,0,0,0.32), 0 0 22px rgba(255,176,90,0.10);
  transition: transform .35s cubic-bezier(.2,.8,.2,1);
  pointer-events:none;
}

.nav-tab{
  flex:1;
  position: relative;
  padding: 12px 0;
  background: transparent;
  border: none;
  cursor: pointer;
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 1px;
  white-space: nowrap;
  color: rgba(215,195,170,0.80);
  transition: color .2s ease, background .2s ease, transform .2s ease;
  z-index: 1;
  border-radius: calc(var(--radius-lg) - 4px);
}
.nav-tab:hover{
  background: rgba(255,176,90,0.08);
  color: var(--gold-primary);
  transform: translateY(-1px);
}
.nav-tab.active{
  background: transparent;
  color: var(--gold-primary);
  text-shadow: 0 0 12px rgba(255,176,90,0.22);
}
.nav-tab.active::after{ display:none; }

/* Thích ứng điện thoại */
@media (max-width: 480px){
  .nav-tab{ padding: 11px 0; font-size: 12px; }
  .header-title{ font-size: 18px; letter-spacing: 5px; }
  .header-subtitle{ font-size: 10px; letter-spacing: 2px; }
}
@media (max-width: 360px){
  .nav-tab{ padding: 10px 0; font-size: 11px; letter-spacing: 0; }
}

/* =========================================================
   07) Container chuyển trang
   ========================================================= */
.page{ display:none; animation: fadeIn .35s ease; }
.page.active{ display:block; }

/* =========================================================
   08) Tiêu đề khối + Nút thao tác
   ========================================================= */
.section-title{
  font-size: 16px;
  color: var(--gold-primary);
  padding: 14px 20px;
  margin-bottom: 16px;
  letter-spacing: 2px;

  display:flex;
  justify-content: space-between;
  align-items:center;

  background: linear-gradient(90deg, rgba(86,38,26,0.74) 0%, rgba(22,10,12,0.38) 100%);
  backdrop-filter: blur(10px);
  border-left: 3px solid var(--sunset-orange);
  border-bottom: 1px solid var(--border-inner);
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
}
.section-btn{
  padding: 7px 14px;
  background: rgba(255,176,90,0.08);
  border: 1px solid rgba(255,176,90,0.60);
  color: var(--gold-primary);
  font-size: 11px;
  cursor: pointer;
  border-radius: 12px;
  font-family: inherit;
  letter-spacing: 1px;
  transition: transform .2s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
}
.section-btn:hover{
  background: linear-gradient(135deg, rgba(255,176,90,0.88), rgba(255,135,70,0.70));
  color: #1a0e14;
  box-shadow: 0 0 22px rgba(255,176,90,0.18);
  transform: translateY(-1px);
}

/* =========================================================
   09) Danh sách / Thẻ gấp
   ========================================================= */
.list-container{ display:flex; flex-direction:column; gap:10px; }

.list-item{
  overflow:hidden;
  transition: border-color .25s ease, box-shadow .25s ease, transform .25s ease;
}
.list-item:hover{
  border-color: rgba(255,176,90,0.46);
  box-shadow: var(--shadow-deep), 0 0 30px rgba(255,176,90,0.14);
}

.list-header{
  padding: 14px 18px;
  display:flex;
  justify-content: space-between;
  align-items:center;
  cursor:pointer;

  background: linear-gradient(90deg,
    rgba(255,135,70,0.14) 0%,
    rgba(255,107,143,0.06) 35%,
    transparent 100%);
  border-left: 2px solid transparent;
  transition: background .2s ease, border-left-color .2s ease;
}
.list-header:hover{ border-left-color: var(--sunset-orange); }

.list-name{
  font-size: 15px;
  color: var(--gold-primary);
  font-weight: 700;
  letter-spacing: 1px;
  text-shadow: 0 0 14px rgba(255,176,90,0.12);
}

.list-badge{
  font-size: 10px;
  padding: 4px 10px;
  border-radius: 10px;
  letter-spacing: 1px;
  background: linear-gradient(135deg, rgba(121,178,163,0.20) 0%, rgba(121,178,163,0.08) 100%);
  color: var(--jade-green);
  border: 1px solid rgba(121,178,163,0.60);
}
.list-badge.red{
  background: linear-gradient(135deg, rgba(216,90,71,0.20) 0%, rgba(216,90,71,0.08) 100%);
  color: #ffb2b2;
  border-color: rgba(216,90,71,0.80);
}
.list-badge.green{
  background: linear-gradient(135deg, rgba(121,178,163,0.20) 0%, rgba(121,178,163,0.08) 100%);
  color: #a9e6d8;
  border-color: rgba(121,178,163,0.70);
}

.expand-icon{
  color: var(--text-muted);
  font-size: 10px;
  transition: transform .35s ease, color .35s ease;
}
.list-item.expanded .expand-icon{
  transform: rotate(180deg);
  color: var(--gold-primary);
}

/* Nội dung gấp (Chức năng không đổi: vẫn dùng max-height) */
.list-content{
  max-height: 0;
  overflow: hidden;
  transition: max-height .5s ease;
  background: linear-gradient(180deg, rgba(14,6,10,0.70), rgba(8,3,6,0.78));
}
.list-item.expanded .list-content{ max-height: 3000px; }

.content-inner{
  padding: 20px;
  border-top: 1px solid var(--border-dark);
  opacity: 0;
  transform: translateY(-6px);
  transition: opacity .25s ease, transform .25s ease;
}
.list-item.expanded .content-inner{
  opacity: 1;
  transform: translateY(0);
}

/* Nhóm thông tin */
.info-group{ margin-bottom: 14px; }
.info-group:last-child{ margin-bottom: 0; }
.info-label{
  font-size: 11px;
  color: var(--text-secondary);
  margin-bottom: 6px;
  letter-spacing: 1px;
}
.info-value{
  font-size: 13px;
  color: var(--text-primary);
  line-height: 1.75;
  padding: 12px 14px;
  background: rgba(62,30,22,0.48);
  border-radius: 10px;
  border-left: 1px solid rgba(255,176,90,0.60);
}

/* =========================================================
   10) Thẻ quân đội / Tài sản / Lưu trữ
   ========================================================= */
.troop-card{
  padding: 14px 16px;
  border-radius: var(--radius-md);
  margin-bottom: 10px;
  transition: box-shadow .25s ease, border-color .25s ease;
}
.troop-card:last-child{ margin-bottom: 0; }
.troop-card:hover{
  border-color: rgba(121,178,163,0.62);
  box-shadow: 0 0 18px rgba(121,178,163,0.14);
}

.troop-name{
  color: var(--gold-primary);
  font-size: 14px;
  margin-bottom: 10px;
  font-weight: 700;
  letter-spacing: 1px;
}

.troop-stats{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  font-size: 11px;
}
.troop-stat{
  text-align:center;
  padding: 8px;
  background: rgba(0,0,0,0.18);
  border-radius: var(--radius-sm);
}
.troop-stat-label{ color: var(--text-muted); margin-bottom: 4px; font-size: 10px; }
.troop-stat-value{ color: var(--jade-green); font-weight: 700; }

/* Tài sản */
.asset-grid{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}
.asset-card{
  padding: 20px;
  text-align:center;
  transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
  position: relative;
  overflow: hidden;
  backdrop-filter: blur(10px);
}
/* Dải sáng mảnh trên đầu (Giữ hiệu ứng gốc) */
.asset-card::before{
  content:'';
  position:absolute;
  top:0; left:0; right:0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--sunset-orange), var(--gold-primary), transparent);
  opacity: 0;
  transition: opacity .25s ease;
}
/* Sáng trong: đặt vào ::after, tránh che mất ::before */
.asset-card::after{
  content:"";
  position:absolute;
  inset: 1px;
  border-radius: inherit;
  border: 1px solid rgba(255, 210, 162, 0.10);
  pointer-events:none;
}
.asset-card:hover{
  border-color: rgba(255,176,90,0.48);
  transform: translateY(-2px);
  box-shadow: var(--shadow-deep), 0 0 30px rgba(255,176,90,0.14);
}
.asset-card:hover::before{ opacity: 1; }

.asset-icon{ font-size: 24px; margin-bottom: 10px; filter: drop-shadow(0 0 8px rgba(255,176,90,0.18)); }
.asset-value{
  font-size: 24px;
  color: var(--gold-primary);
  font-weight: 800;
  text-shadow: 0 0 18px rgba(255,176,90,0.14);
}
.asset-label{ font-size: 11px; color: var(--text-secondary); margin-top: 6px; letter-spacing: 1px; }

/* Lưu trữ */
.storage-list{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
}
.storage-item{
  display:flex;
  justify-content: space-between;
  align-items:center;
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  transition: border-color .2s ease, box-shadow .2s ease;
}
.storage-item:hover{
  border-color: rgba(255,176,90,0.44);
  box-shadow: 0 0 14px rgba(255,176,90,0.08);
}
.storage-name{ color: var(--text-primary); font-size: 12px; }
.storage-count{ color: var(--gold-primary); font-weight: 800; font-size: 13px; }
.storage-count.zero{ color: var(--text-muted); }

/* =========================================================
   11) Thẻ thông tin cá nhân (Trang Kỷ yếu)
   ========================================================= */
.profile-card{
  padding: 24px;
  margin-bottom: 20px;
  backdrop-filter: blur(12px);
  border-color: var(--border-gold);
  box-shadow: var(--shadow-deep), var(--shadow-glow);
  position: relative;
}
.profile-card::before{
  content:'';
  position:absolute;
  inset: 8px;
  border: 1px solid var(--border-inner);
  border-radius: calc(var(--radius-lg) - 6px);
  pointer-events:none;
}
.profile-header{
  text-align:center;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--border-dark);
  margin-bottom: 20px;
}
.profile-identity{
  font-size: 20px;
  color: var(--gold-primary);
  font-weight: 800;
  letter-spacing: 3px;
  text-shadow: 0 0 16px rgba(255,176,90,0.14);
}
.profile-fame{
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 8px;
  letter-spacing: 1px;
}
.profile-stats{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}
.profile-stat{
  text-align:center;
  padding: 14px;
  border-radius: var(--radius-md);
}
.profile-stat-value{ font-size: 18px; color: var(--gold-primary); font-weight: 800; }
.profile-stat-label{ font-size: 10px; color: var(--text-secondary); margin-top: 6px; letter-spacing: 1px; }

/* =========================================================
   12) Bảng Quy Tâm
   ========================================================= */
.guixin-panel{
  border: 1px solid rgba(255,176,90,0.58);
  border-radius: 16px;
  padding: 30px;
  text-align:center;
  box-shadow: var(--shadow-deep), 0 0 34px rgba(255,176,90,0.12);
  position: relative;
  animation: glow 5s ease-in-out infinite;
  backdrop-filter: blur(12px);
}
.guixin-panel::before{
  content:'';
  position:absolute;
  inset: 10px;
  border: 1px solid var(--border-inner);
  border-radius: 12px;
  pointer-events:none;
}
.guixin-title{
  font-size: 16px;
  color: var(--gold-primary);
  letter-spacing: 3px;
  margin-bottom: 24px;
  text-shadow: 0 0 14px rgba(255,176,90,0.14);
}
.guixin-count{
  font-size: 56px;
  color: var(--gold-primary);
  font-weight: 900;
  line-height: 1;
  text-shadow: 0 0 30px rgba(255,176,90,0.16), 0 0 54px rgba(255,135,70,0.14);
}
.guixin-label{
  font-size: 14px;
  color: var(--text-secondary);
  letter-spacing: 2px;
  margin-top: 8px;
}
.guixin-divider{
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--sunset-orange), var(--gold-primary), var(--sunset-orange), transparent);
  margin: 28px 0;
}

.daily-rewards{ text-align:left; }
.daily-title{
  font-size: 14px;
  color: var(--gold-primary);
  letter-spacing: 1px;
  margin-bottom: 16px;
  text-align:center;
}
.reward-grid{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}
.reward-item{
  display:flex;
  justify-content: space-between;
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  transition: border-color .2s ease, box-shadow .2s ease;
}
.reward-item:hover{
  border-color: rgba(255,176,90,0.44);
  box-shadow: 0 0 14px rgba(255,176,90,0.08);
}
.reward-name{ color: var(--text-primary); font-size: 11px; }
.reward-amount{ color: var(--gold-primary); font-size: 11px; font-weight: 800; }

/* =========================================================
   13) Thông tin cơ bản nhân vật (Trong phần mở rộng Nhân mạch)
   ========================================================= */
.person-basic-info{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-bottom: 14px;
}
.person-stat{
  padding: 12px;
  border-radius: var(--radius-sm);
  text-align:center;
}
.person-stat-label{
  font-size: 10px;
  color: var(--text-muted);
  margin-bottom: 4px;
  letter-spacing: 1px;
}
.person-stat-value{
  font-size: 14px;
  color: var(--gold-primary);
  font-weight: 800;
}
.person-stat-value.positive{ color: var(--jade-green); }
.person-stat-value.negative{ color: #ffb2b2; }

/* =========================================================
   14) Trạng thái rỗng / Tiểu mục / Thẻ tag
   ========================================================= */
.empty-state{
  text-align:center;
  padding: 40px 20px;
  color: var(--text-muted);
}
.empty-state-icon{
  font-size: 40px;
  margin-bottom: 14px;
  opacity: 0.45;
}

.subsection{ margin-top: 20px; }
.subsection-title{
  font-size: 13px;
  color: var(--gold-primary);
  padding: 10px 14px;
  background: linear-gradient(90deg, rgba(255,135,70,0.12) 0%, transparent 100%);
  border-radius: var(--radius-sm);
  margin-bottom: 12px;
  letter-spacing: 1px;
  border-left: 2px solid var(--sunset-orange);
}

.tags-container{ display:flex; flex-wrap:wrap; gap:8px; }
.tag{
  padding: 6px 14px;
  background: rgba(62,30,22,0.48);
  border: 1px solid var(--border-dark);
  border-radius: 10px;
  font-size: 11px;
  color: var(--text-primary);
  transition: border-color .2s ease, box-shadow .2s ease, transform .2s ease;
}
.tag:hover{
  border-color: rgba(255,176,90,0.44);
  box-shadow: 0 0 12px rgba(255,176,90,0.10);
  transform: translateY(-1px);
}
.tag-empty{ color: var(--text-muted); font-style: italic; }

/* =========================================================
   15) Cửa sổ bật lên Modal
   ========================================================= */
.modal-overlay{
  display:none;
  position: fixed;
  inset: 0;
  background: rgba(10, 6, 8, 0.92);
  backdrop-filter: blur(7px);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 20px;
}
.modal-overlay.active{ display:flex; }

.modal-content{
  background: rgba(16, 7, 10, 0.90);
  border: 1px solid rgba(255,176,90,0.58);
  border-radius: 16px;
  max-width: 700px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  padding: 24px;
  position: relative;
  box-shadow: var(--shadow-deep), 0 0 46px rgba(255,176,90,0.12);
  animation: fadeIn .25s ease;
}
.modal-content::before{
  content:'';
  position:absolute;
  inset: 8px;
  border: 1px solid var(--border-inner);
  border-radius: 12px;
  pointer-events:none;
}

.modal-close{
  position:absolute;
  top: 14px;
  right: 14px;
  width: 32px;
  height: 32px;
  border-radius: 10px;

  background: rgba(0,0,0,0.25);
  border: 1px solid var(--border-dark);
  color: var(--text-muted);
  font-size: 18px;
  cursor:pointer;

  display:flex;
  align-items:center;
  justify-content:center;
  z-index: 10;
  transition: background .2s ease, border-color .2s ease, color .2s ease, transform .2s ease;
}
.modal-close:hover{
  color: var(--gold-primary);
  border-color: rgba(255,176,90,0.46);
  background: rgba(255,176,90,0.12);
  transform: translateY(-1px);
}

.modal-title{
  font-size: 18px;
  color: var(--gold-primary);
  margin-bottom: 20px;
  letter-spacing: 2px;
  text-align:center;
  text-shadow: 0 0 14px rgba(255,176,90,0.14);
}

/* =========================================================
   16) Tab trong Modal (Quy tâm/Nhân mạch/Đại thế): Phong cách thanh trượt phân đoạn
   ========================================================= */
.tab-switch{
  --tab-count: 2;
  --active-index: 0;

  display:flex;
  gap:0;
  justify-content: stretch;
  align-items: stretch;

  position: relative;
  padding: 4px;
  margin-bottom: 18px;

  border-radius: 12px;
  background: rgba(62,30,22,0.50);
  border: 1px solid rgba(255,176,90,0.24);
  overflow:hidden;
}
.tab-switch::before{
  content:"";
  position:absolute;
  top: 4px; bottom: 4px; left: 4px;
  width: calc((100% - 8px) / var(--tab-count));
  transform: translateX(calc(var(--active-index) * 100%));
  border-radius: 10px;
  background: linear-gradient(180deg, rgba(255,210,162,0.18), rgba(255,135,70,0.10));
  border: 1px solid rgba(255,210,162,0.16);
  box-shadow: 0 10px 20px rgba(0,0,0,0.28), 0 0 22px rgba(255,176,90,0.10);
  transition: transform .35s cubic-bezier(.2,.8,.2,1);
  pointer-events:none;
}

.tab-btn{
  flex:1;
  padding: 10px 10px;
  background: transparent;
  border: none;
  cursor:pointer;
  font-family: inherit;
  font-size: 11px;
  border-radius: 10px;
  letter-spacing: 1px;
  color: rgba(215,195,170,0.80);
  transition: color .2s ease, background .2s ease;
  z-index: 1;
}
.tab-btn:hover{
  background: rgba(255,176,90,0.08);
  color: var(--gold-primary);
}
.tab-btn.active{
  background: transparent;
  color: var(--gold-primary);
  text-shadow: 0 0 12px rgba(255,176,90,0.20);
}

/* Giữ chức năng "chỉ hiển thị panel active" ban đầu */
.tab-panel{ display:none; }
.tab-panel.active{ display:block; }

/* =========================================================
   17) Cột mốc / Quy tắc / Khóa kỹ thuật
   ========================================================= */
.milestone-list{ display:flex; flex-direction:column; gap:12px; }
.milestone-item{
  display:flex;
  align-items:center;
  padding: 14px 16px;
  border-radius: var(--radius-md);
  transition: box-shadow .25s ease, border-color .25s ease;
}
.milestone-item.unlocked{
  border-color: rgba(121,178,163,0.70);
  box-shadow: 0 0 18px rgba(121,178,163,0.14);
}
.milestone-item.locked{ opacity: 0.55; }
.milestone-threshold{ min-width: 80px; font-size: 16px; color: var(--gold-primary); font-weight: 900; }
.milestone-reward{ flex:1; font-size: 12px; color: var(--text-primary); padding: 0 12px; }
.milestone-status{
  font-size: 10px;
  padding: 5px 10px;
  border-radius: 10px;
  letter-spacing: 1px;
}
.milestone-status.unlocked{
  background: linear-gradient(135deg, rgba(121,178,163,0.98), rgba(121,178,163,0.60));
  color: #fff;
}
.milestone-status.locked{
  background: rgba(170,110,75,0.28);
  color: var(--text-muted);
}

.rule-block{
  border-radius: var(--radius-md);
  padding: 16px;
  margin-bottom: 14px;
}
.rule-block-title{
  font-size: 13px;
  color: var(--gold-primary);
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border-dark);
  letter-spacing: 1px;
}
.rule-list{ list-style:none; padding:0; margin:0; }
.rule-list li{
  padding: 6px 0;
  font-size: 11px;
  color: var(--text-primary);
  display:flex;
  align-items:flex-start;
  gap: 8px;
}
.rule-list li::before{
  content: '✓';
  color: var(--jade-green);
  font-weight: 900;
  flex-shrink:0;
}
.rule-list.exclude li::before{
  content: '✗';
  color: #ffb2b2;
}

.tech-lock-notice{
  border-radius: var(--radius-md);
  padding: 16px;
  margin-bottom: 20px;
  border-color: rgba(216,90,71,0.62);
}
.tech-lock-title{
  font-size: 13px;
  color: #ffb2b2;
  margin-bottom: 10px;
  display:flex;
  align-items:center;
  gap: 8px;
}
.tech-lock-content{ font-size: 11px; color: var(--text-primary); line-height: 1.6; }
.tech-allowed{ color: var(--jade-green); }
.tech-forbidden{ color: #ffb2b2; }

/* =========================================================
   18) Khối công thức / Biểu mẫu / Đầu ra / Xóa
   ========================================================= */
.formula-grid{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}
.formula-item{
  padding: 12px;
  border-radius: var(--radius-sm);
  font-size: 11px;
}
.formula-name{ color: var(--text-secondary); margin-bottom: 5px; }
.formula-calc{ color: var(--text-primary); }

.form-group{ margin-bottom: 14px; }
.form-label{
  display:block;
  font-size: 11px;
  color: var(--gold-primary);
  margin-bottom: 6px;
  letter-spacing: 1px;
}
.form-input, .form-select, .form-textarea{
  width:100%;
  padding: 10px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border-dark);
  border-radius: 10px;
  color: var(--text-primary);
  font-family: inherit;
  font-size: 12px;
  transition: border-color .2s ease, box-shadow .2s ease;
}
.form-input:focus, .form-select:focus, .form-textarea:focus{
  outline:none;
  border-color: rgba(255,176,90,0.66);
  box-shadow: 0 0 16px rgba(255,176,90,0.14);
}
.form-textarea{ min-height: 80px; resize: vertical; }
.form-row{ display:grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
.form-row-3{ display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }

.btn-group{ display:flex; gap: 10px; margin-top: 20px; justify-content:center; }
.btn{
  padding: 10px 24px;
  border: 1px solid rgba(255,176,90,0.60);
  background: rgba(255,176,90,0.08);
  color: var(--gold-primary);
  font-family: inherit;
  font-size: 12px;
  cursor:pointer;
  border-radius: 12px;
  transition: transform .2s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
  letter-spacing: 1px;
}
.btn:hover{
  background: linear-gradient(135deg, rgba(255,176,90,0.90), rgba(255,135,70,0.70));
  color: #1a0e14;
  box-shadow: 0 0 22px rgba(255,176,90,0.18);
  transform: translateY(-1px);
}
.btn-danger{
  border-color: rgba(216,90,71,0.80);
  color: #ffb2b2;
}
.btn-danger:hover{
  background: rgba(216,90,71,0.92);
  color: #fff;
  box-shadow: 0 0 18px rgba(216,90,71,0.16);
}

.output-box{
  background: rgba(0,0,0,0.26);
  border: 1px solid rgba(255,176,90,0.46);
  border-radius: var(--radius-md);
  padding: 14px;
  margin-top: 20px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  font-size: 11px;
  color: var(--text-primary);
  white-space: pre-wrap;
  word-break: break-all;
  max-height: 250px;
  overflow-y: auto;
}
.output-hint{
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 10px;
  text-align:center;
}

.delete-list{ display:flex; flex-direction:column; gap: 8px; margin-bottom: 16px; }
.delete-item{
  display:flex;
  justify-content: space-between;
  align-items:center;
  padding: 12px 14px;
  border-radius: var(--radius-sm);
}
.delete-item-name{ color: var(--text-primary); }
.delete-item-btn{
  padding: 6px 12px;
  background: rgba(216,90,71,0.92);
  border: none;
  color: #fff;
  font-size: 10px;
  cursor:pointer;
  border-radius: 12px;
  transition: box-shadow .2s ease, transform .2s ease, filter .2s ease;
}
.delete-item-btn:hover{
  box-shadow: 0 0 14px rgba(216,90,71,0.18);
  transform: translateY(-1px);
  filter: brightness(1.03);
}

/* =========================================================
   19) Khu vực Phòng the (Giữ cấu trúc, không đổi chức năng)
   ========================================================= */
.sese-section{
  margin-top: 16px;
  padding: 16px;
  background: linear-gradient(135deg, rgba(216,90,71,0.18) 0%, rgba(216,90,71,0.08) 100%);
  border-radius: var(--radius-md);
  border: 1px solid rgba(216,90,71,0.60);
}
.sese-title{
  font-size: 12px;
  color: #ffb2b2;
  margin-bottom: 14px;
  letter-spacing: 1px;
}
.sese-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
.sese-item{
  display:flex;
  justify-content: space-between;
  padding: 8px 12px;
  background: rgba(0,0,0,0.18);
  border-radius: var(--radius-sm);
  font-size: 11px;
}
.sese-item-label{ color: var(--text-muted); }
.sese-item-value{ color: #ffb2b2; }

/* =========================================================
   20) Thanh cuộn
   ========================================================= */
::-webkit-scrollbar{ width: 6px; height: 6px; }
::-webkit-scrollbar-track{ background: rgba(16,7,10,0.75); }
::-webkit-scrollbar-thumb{ background: var(--gold-dark); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover{ background: var(--gold-secondary); }

/* =========================================================
   21) Ưu tiên hiệu ứng động: Giảm hiệu ứng (Bảo vệ mắt)
   ========================================================= */
@media (prefers-reduced-motion: reduce){
  .guixin-panel{ animation: none !important; }
  .page{ animation: none !important; }
}
/* =========================================================
   [Mới thêm] Nhân mạch: Hàng danh sách + Dàn trang chi tiết nhân vật
   ========================================================= */
.renmai-row{
  cursor: pointer;
}
.renmai-row-inner{
  padding: 14px 18px;
  display:flex;
  justify-content: space-between;
  align-items:center;
  gap: 12px;

  background: linear-gradient(90deg,
    rgba(255,135,70,0.14) 0%,
    rgba(255,107,143,0.06) 35%,
    transparent 100%);
  border-left: 2px solid transparent;
  transition: background .2s ease, border-left-color .2s ease, transform .2s ease;
}
.renmai-row:hover .renmai-row-inner{
  border-left-color: var(--sunset-orange);
  transform: translateY(-1px);
}

.renmai-row-left{
  min-width: 0;
}
.renmai-row-name{
  font-size: 15px;
  color: var(--gold-primary);
  font-weight: 800;
  letter-spacing: 1px;
  text-shadow: 0 0 14px rgba(255,176,90,0.12);

  /* Quan trọng: Cho phép hiển thị nhiều dòng, tối đa 2 dòng */
  white-space: normal;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;

  /* Tránh tiếng Anh/ký tự siêu dài phá vỡ khung */
  word-break: break-word;
}
.renmai-row-sub{
  margin-top: 6px;
  font-size: 11px;
  color: var(--text-muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.renmai-row-right{
  flex-shrink: 0;
  display:flex;
  align-items:center;
  gap: 8px;
}
/* Bên phải gọn hơn, cho phép xuống dòng, không chiếm cố định 1 dòng */
.renmai-row-right{
  flex-shrink: 0;
  display:flex;
  align-items:center;
  gap: 6px;
  flex-wrap: wrap;
  justify-content: flex-end;
  max-width: 46%; /* Để lại không gian cho tên bên trái, có thể chỉnh 40~55% */
}

/* Chỉ thu nhỏ badge trong "hàng danh sách nhân mạch", không ảnh hưởng list-badge khác */
.renmai-row-right .list-badge{
  font-size: 9px;
  padding: 3px 8px;
  border-radius: 9px;
  letter-spacing: 0.5px;
}

/* Thu nhỏ chỉ số mini bên phải */
.renmai-mini{
  font-size: 9px;
  padding: 3px 7px;
  border-radius: 9px;
}
.renmai-mini{
  font-size: 10px;
  color: var(--text-secondary);
  padding: 4px 8px;
  border-radius: 10px;
  border: 1px solid rgba(255, 210, 162, 0.12);
  background: rgba(0,0,0,0.14);
}

.renmai-mini.positive{ color: #a9e6d8; border-color: rgba(121,178,163,0.45); }
.renmai-mini.negative{ color: #ffb2b2; border-color: rgba(216,90,71,0.45); }
.renmai-mini.lust{ color: #ffb2b2; border-color: rgba(255,107,143,0.45); }

.renmai-profile .info-value{
  white-space: pre-wrap; /* Cho phép mô tả nhân vật xuống dòng */
}
.renmai-profile-header{
  text-align:center;
  padding-bottom: 16px;
  margin-bottom: 16px;
  border-bottom: 1px solid var(--border-dark);
}
.renmai-profile-title{
  font-size: 20px;
  color: var(--gold-primary);
  font-weight: 900;
  letter-spacing: 2px;
  text-shadow: 0 0 16px rgba(255,176,90,0.14);
}
.renmai-profile-badges{
  margin-top: 10px;
  display:flex;
  justify-content:center;
  gap: 8px;
  flex-wrap: wrap;
}
.renmai-profile-actions{
  margin-top: 18px;
}


/* Bảng tổng quan */
.zhengfu-overview{
  padding: 14px;
  border-radius: var(--radius-lg);
  background: linear-gradient(180deg, rgba(76, 34, 24, 0.68) 0%, rgba(18, 8, 10, 0.66) 100%);
  border: 1px solid rgba(255, 176, 90, 0.26);
  box-shadow: var(--shadow-deep);
  display: grid;
  grid-template-columns: repeat(6, minmax(0, 1fr));
  gap: 10px;
  backdrop-filter: blur(10px);
}

@media (max-width: 720px){
  .zhengfu-overview{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
}
@media (max-width: 420px){
  .zhengfu-overview{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}

.zhengfu-metric{
  padding: 10px 10px;
  border-radius: var(--radius-md);
  background: rgba(0,0,0,0.16);
  border: 1px solid rgba(255, 210, 162, 0.08);
  text-align: center;
}
.zhengfu-metric-label{
  font-size: 10px;
  color: var(--text-muted);
  letter-spacing: 1px;
  margin-bottom: 6px;
}
.zhengfu-metric-value{
  font-size: 16px;
  color: var(--gold-primary);
  font-weight: 900;
}


/* Làm cho khối chinh phục hover linh hoạt hơn một chút */
#page-zhengfu .list-item:hover{
  transform: translateY(-1px);
}
#page-zhengfu .list-item{
  transition: transform .2s ease, border-color .25s ease, box-shadow .25s ease;
}
/* =========================================================
   [Thêm mới/Ghi đè] Trang chinh phục: Thẻ mô-đun + Nội dung ẩn + Hiển thị cửa sổ bật lên
   ========================================================= */

/* Ghi đè grid trang chinh phục cũ (nếu bạn đã thêm display:grid trước đó) */
#page-zhengfu.page.active{ display:block; }

.zhengfu-modules{
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 12px;
  margin-top: 12px;
}
@media (max-width: 720px){
  .zhengfu-modules{ grid-template-columns: 1fr; }
}

.zhengfu-module-card{
  position: relative;
  padding: 16px 16px 14px;
  border-radius: var(--radius-lg);
  cursor: pointer;
  overflow: hidden;

  background: linear-gradient(180deg,
    rgba(76, 34, 24, 0.68) 0%,
    rgba(18, 8, 10, 0.66) 100%);
  border: 1px solid rgba(255, 176, 90, 0.22);
  box-shadow: var(--shadow-deep);
  backdrop-filter: blur(10px);

  transition: transform .2s ease, border-color .25s ease, box-shadow .25s ease;
}
.zhengfu-module-card::before{
  content:"";
  position:absolute;
  top:0; left:0; right:0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--sunset-orange), var(--gold-primary), transparent);
  opacity: 0;
  transition: opacity .25s ease;
}
.zhengfu-module-card:hover{
  transform: translateY(-2px);
  border-color: rgba(255,176,90,0.48);
  box-shadow: var(--shadow-deep), 0 0 30px rgba(255,176,90,0.14);
}
.zhengfu-module-card:hover::before{ opacity: 1; }

.zhengfu-module-title{
  font-size: 15px;
  color: var(--gold-primary);
  font-weight: 900;
  letter-spacing: 1px;
  margin-bottom: 8px;
  text-shadow: 0 0 14px rgba(255,176,90,0.12);
}
.zhengfu-module-sub{
  font-size: 11px;
  color: var(--text-muted);
  line-height: 1.6;
  padding-right: 84px; /* Chừa chỗ cho badge góc trên bên phải */
}

.zhengfu-module-badge{
  position:absolute;
  top: 12px;
  right: 12px;
  font-size: 10px;
  padding: 5px 10px;
  border-radius: 10px;
  letter-spacing: 1px;

  background: rgba(0,0,0,0.18);
  border: 1px solid rgba(255, 176, 90, 0.42);
  color: var(--gold-primary);
  max-width: 55%;           /* Giới hạn chiều rộng tối đa (để không đè vào tiêu đề) */
  white-space: nowrap;      /* Bắt buộc chữ nằm trên 1 dòng */
  overflow: hidden;         /* Ẩn phần chữ bị thừa ra */
  text-overflow: ellipsis;  /* Hiện dấu ... ở cuối nếu chữ quá dài */
  z-index: 2;               /* Đảm bảo nó nổi lên trên */
}
.zhengfu-module-badge.green{
  border-color: rgba(121,178,163,0.70);
  color: #a9e6d8;
}
.zhengfu-module-badge.red{
  border-color: rgba(216,90,71,0.70);
  color: #ffb2b2;
}

.zhengfu-hidden{ display:none; }

/* Nội dung trong cửa sổ bật lên: Cho một chút khoảng cách trên dưới thoải mái hơn */
#zhengfu-module-body{
  margin-top: 8px;
}
/* =========================
   [Thêm mới] Nút ghim nhân mạch + Hiệu ứng ghim
   ========================= */
.renmai-pin-btn{
  width: 28px;
  height: 24px;
  border-radius: 10px;
  border: 1px solid rgba(255, 210, 162, 0.18);
  background: rgba(0,0,0,0.16);
  color: rgba(215,195,170,0.85);
  cursor: pointer;
  font-family: inherit;
  font-size: 14px;
  line-height: 1;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: transform .15s ease, border-color .2s ease, background .2s ease, color .2s ease;
}
.renmai-pin-btn:hover{
  transform: translateY(-1px);
  border-color: rgba(255, 176, 90, 0.50);
  background: rgba(255,176,90,0.08);
  color: var(--gold-primary);
}
.renmai-pin-btn.pinned{
  border-color: rgba(255, 107, 143, 0.55);
  background: rgba(255, 107, 143, 0.12);
  color: #ffb2d6;
  box-shadow: 0 0 18px rgba(255, 107, 143, 0.12);
}

/* Hiệu ứng ghim cả hàng: Viền trái sáng hơn + Hào quang vàng hồng nhẹ */
.renmai-row.pinned .renmai-row-inner{
  border-left-color: rgba(255, 107, 143, 0.85);
  background: linear-gradient(90deg,
    rgba(255,107,143,0.14) 0%,
    rgba(255,135,70,0.08) 35%,
    transparent 100%);
  box-shadow: 0 0 26px rgba(255, 107, 143, 0.10);
}
/* =========================
   [Thêm mới] Trứng phục sinh khi nhấp vào tiêu đề: Chữ nhỏ màu hồng trôi nổi
   ========================= */
.header-title{ cursor: pointer; }

.easter-tip{
  position: fixed; /* Phối hợp với #easter-layer, luôn phủ lên lớp trên cùng */
  left: var(--x);
  top: var(--y);
  transform: translate(-50%, -50%);
  pointer-events: none;
  z-index: 999;

  /* "Chữ nhãn dán dễ thương" hiện đại hơn */
  font-family: 'Noto Sans SC', system-ui, -apple-system, 'PingFang SC', 'Microsoft YaHei', sans-serif;
  font-weight: 800;
  font-size: 14px;
  letter-spacing: 0.4px;

  /* Bong bóng nhãn dán: Nền hồng + Viền nhạt (Ít quê mùa hơn chữ gradient, rõ ràng hơn) */
  color: rgba(255, 245, 250, 0.96);
  padding: 8px 12px;
  border-radius: 999px;
  background: linear-gradient(180deg, rgba(255,107,143,0.30), rgba(255,107,143,0.16));
  border: 1px solid rgba(255, 107, 143, 0.45);

  box-shadow:
    0 10px 22px rgba(0,0,0,0.28),
    0 0 22px rgba(255,107,143,0.16);

  /* Tăng cảm giác rõ nét (Không làm mờ) */
  text-shadow: 0 1px 0 rgba(0,0,0,0.35);

  animation: tipFloat 2.15s cubic-bezier(.2,.85,.2,1) forwards;
}

@keyframes tipFloat{
  0%{
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.85);
  }
  12%{
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.02);
  }
  78%{
    opacity: 1;
  }
  100%{
    opacity: 0;
    transform:
      translate(calc(-50% + var(--dx, 0px)),
                calc(-50% + var(--dy, 70px)))
      rotate(var(--rot, -6deg))
      scale(1.00);
  }
}
/* =========================
   [Thêm mới] Hạt hồng dễ thương: Nổ tung khi nhấp vào tiêu đề
   ========================= */
.easter-particle{
  position: fixed; /* Phối hợp với #easter-layer */
  left: var(--x);
  top: var(--y);
  transform: translate(-50%, -50%);
  pointer-events: none;
  z-index: 999;

  /* Hạt dùng font không chân sạch sẽ hơn, ký hiệu "lấp lánh" hơn */
  font-family: 'Noto Sans SC', system-ui, sans-serif;
  font-weight: 800;

  font-size: var(--fs, 14px);
  color: var(--c, #ff6b8f);
  opacity: 0;

  /* Phát sáng thanh thoát hơn, không dùng bóng đổ nặng gây "quê" và mờ viền */
  text-shadow:
    0 0 10px rgba(255, 107, 143, 0.22),
    0 0 18px rgba(255, 210, 226, 0.12);

  animation: particleBurst var(--dur, 1400ms) cubic-bezier(.16,.85,.2,1) forwards;
  will-change: transform, opacity;
}
@keyframes particleBurst{
  0%{
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.65);
  }
  18%{
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.05);
  }
  82%{
    opacity: 1;
  }
  100%{
    opacity: 0;
    transform:
      translate(calc(-50% + var(--dx, 0px)),
                calc(-50% + var(--dy, 110px)))
      rotate(var(--rot, 0deg))
      scale(var(--s, 1));
  }
}

/* Bổ sung: Một "vòng gợn sóng" hồng nhạt */
.easter-ring{
  position: absolute;
  left: var(--x);
  top: var(--y);
  width: 14px;
  height: 14px;
  border-radius: 999px;
  transform: translate(-50%, -50%) scale(0.5);
  pointer-events: none;
  z-index: 5;

  border: 1px solid rgba(255,107,143,0.45);
  box-shadow: 0 0 16px rgba(255,107,143,0.14);
  opacity: 0;

  animation: ringPop 520ms ease-out forwards;
}

@keyframes ringPop{
  0%{ opacity: 0; transform: translate(-50%, -50%) scale(0.55); }
  20%{ opacity: 1; }
  100%{ opacity: 0; transform: translate(-50%, -50%) scale(2.9); }
}

/* Ưu tiên chuyển động: Khi giảm chuyển động, tắt hạt/gợn sóng (giữ nhấp chuột không ảnh hưởng chức năng) */
@media (prefers-reduced-motion: reduce){
  .easter-particle, .easter-ring{ animation: none !important; display:none !important; }
}
/* Lớp trứng phục sinh toàn màn hình: Luôn ở trên nội dung (nhưng mặc định vẫn dưới modal) */
#easter-layer{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 2000; /* modal-overlay của bạn là 1000, nên cái này sẽ ở dưới cửa sổ bật lên; nếu muốn che cửa sổ bật lên thì đổi thành 2000 */
}
/* =========================
   [Thêm mới] Trang tài sản: Bốn tiểu mục có thể gập lại
   Giải thích: Chỉ tác dụng với #page-zichan, tránh ảnh hưởng subsection-title của trang khác
   ========================= */
#page-zichan .subsection[data-collapsible="1"] > .subsection-title.is-collapsible{
  cursor: pointer;
  user-select: none;

  /* Không sửa nền/viền gốc của bạn, chỉ đổi tiêu đề thành bố cục "Trái tiêu đề + Phải mũi tên" */
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

#page-zichan .subsection[data-collapsible="1"] > .subsection-title.is-collapsible::after{
  content: "▼";
  font-size: 10px;
  color: var(--text-muted);
  opacity: 0.85;
  transform: rotate(0deg);
  transition: transform .18s ease, opacity .18s ease;
}

/* Khi thu gọn mũi tên hướng sang trái */
#page-zichan .subsection[data-collapsible="1"].collapsed > .subsection-title.is-collapsible::after{
  transform: rotate(-90deg);
  opacity: 0.65;
}

/* Khi thu gọn: Ẩn tất cả nội dung bên dưới tiêu đề (áp dụng chung cho cả bốn khối) */
#page-zichan .subsection[data-collapsible="1"].collapsed > :not(.subsection-title){
  display: none !important;
}
/* Quy tâm: Nút nhỏ gọn hơn */
.guixin-mini-btn{
  padding: 6px 10px;
  font-size: 10px;
  border-radius: 10px;
  letter-spacing: 1px;
}

/* Trạng thái thu gọn: Ẩn cấu thành dân số/sản lượng hàng ngày */
#guixin-panel.details-collapsed #guixin-details{
  display: none;
}
/* Quy tâm: Ẩn cấu thành dân số/sản lượng hàng ngày khi thu gọn chi tiết */
.guixin-panel.details-collapsed .guixin-details{
  display: none;
}
/* =========================
   [Ghi đè] Điều hướng đỉnh: 10 nút hai hàng (5×2)
   Giải thích: Bố cục hai hàng không dùng thanh trượt ::before nữa
   ========================= */
.nav-tabs{
  display: grid;
  grid-template-columns: repeat(5, minmax(0, 1fr));
  grid-auto-rows: 44px;           /* Chiều cao mỗi nút */
  gap: 8px;                       /* Khe hở giữa các nút */
  padding: 8px;
  margin-bottom: 16px;
  position: relative;
  overflow: visible;              /* Hai hàng không cần cắt xén */
  backdrop-filter: blur(12px);
}

/* Vô hiệu hóa phần tử giả thanh trượt ban đầu */
.nav-tabs::before{ display: none !important; }

.nav-tab{
  width: 100%;
  height: 44px;
  padding: 0;                     /* Trong grid dùng chiều cao để kiểm soát */
  display: flex;
  align-items: center;
  justify-content: center;

  border-radius: 12px;
  border: 1px solid rgba(255, 176, 90, 0.22);
  background: rgba(0,0,0,0.14);

  font-size: 12px;
  font-weight: 800;
  letter-spacing: 1px;

  color: rgba(215,195,170,0.82);
  transition: transform .15s ease, border-color .2s ease, background .2s ease, color .2s ease, box-shadow .2s ease;
}

.nav-tab:hover{
  transform: translateY(-1px);
  border-color: rgba(255,176,90,0.46);
  background: rgba(255,176,90,0.08);
  color: var(--gold-primary);
  box-shadow: 0 0 18px rgba(255,176,90,0.10);
}

/* active Cao sáng: Thay thế thanh trượt cũ */
.nav-tab.active{
  color: var(--gold-primary);
  border-color: rgba(255,176,90,0.62);
  background: linear-gradient(180deg, rgba(255,210,162,0.16), rgba(255,135,70,0.08));
  box-shadow: 0 10px 22px rgba(0,0,0,0.32), 0 0 22px rgba(255,176,90,0.10);
  text-shadow: 0 0 12px rgba(255,176,90,0.18);
}

/* Màn hình nhỏ tiếp tục thu chữ, đảm bảo hai hàng vẫn đủ 5 cột */
@media (max-width: 420px){
  .nav-tabs{ gap: 6px; padding: 6px; grid-auto-rows: 40px; }
  .nav-tab{ height: 40px; font-size: 11px; letter-spacing: 0; }
}
/* Tài chính: Màu số dư (Tái sử dụng cấu trúc metric, chỉ đổi màu) */
.metric-positive{ color: var(--jade-green) !important; }
.metric-negative{ color: #ffb2b2 !important; }
</style>
  <script type="module">
  // --- HÀM MỚI: Xử lý hiển thị (Biến _ thành dấu cách) ---
  function fmt(text) {
    if (typeof text !== 'string') return text;
    // Thay thế tất cả dấu _ bằng dấu cách
    return text.replace(/_/g, ' ');
  }
  
 const wushuangModuleMap = {
  body:  { title: '💪 Tố chất cơ thể', srcId: 'wushuang-body' },
  equip: { title: '🧰 Trang bị cá nhân', srcId: 'wushuang-equip' },
  skill: { title: '🥋 Võ kỹ',     srcId: 'wushuang-skill' },
  kill:  { title: '⚔ Ghi chép trảm tướng',   srcId: 'wushuang-kill' },
};

function openWushuangModule(key){
  const meta = wushuangModuleMap[key];
  if (!meta) return;

  const src = document.getElementById(meta.srcId);
  const titleEl = document.getElementById('wushuang-module-title');
  const bodyEl  = document.getElementById('wushuang-module-body');

  if (titleEl) titleEl.textContent = meta.title;
  if (bodyEl) bodyEl.innerHTML = (src && src.innerHTML.trim())
    ? src.innerHTML
    : '<div class="empty-state">Tạm thời không có nội dung</div>';

  openModal('modal-wushuang-module');
} 
  
  function bindZichanCollapsibleSubsections(){
  const page = document.getElementById('page-zichan');
  if (!page) return;

  const sections = page.querySelectorAll('.subsection[data-collapsible="1"]');
  sections.forEach(sec => {
    const title = sec.querySelector(':scope > .subsection-title');
    if (!title) return;

    // Chống buộc lặp lại
    if (title.dataset.boundCollapse === '1') return;
    title.dataset.boundCollapse = '1';

    title.classList.add('is-collapsible');
    title.setAttribute('role', 'button');
    title.setAttribute('tabindex', '0');
    title.setAttribute('aria-expanded', sec.classList.contains('collapsed') ? 'false' : 'true');

    const toggle = () => {
      const collapsed = sec.classList.toggle('collapsed');
      title.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
    };

    title.addEventListener('click', (e) => {
      e.preventDefault();
      toggle();
    });

    // Bàn phím (Enter/Space) cũng có thể gập
    title.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggle();
      }
    });
  });
}

function switchPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  const targetPage = document.getElementById(pageId);
  const targetTab = document.querySelector(`.nav-tab[data-page="${pageId}"]`);
  if (targetPage) targetPage.classList.add('active');
  if (targetTab) targetTab.classList.add('active');

  // Chỉ dùng để làm đẹp: Cập nhật vị trí thanh trượt điều hướng (không ảnh hưởng chức năng)

}

// Tùy chọn: Chuyển số thành từ mô tả
function getMinxinDesc(val) {
  if (val >= 80) return 'Dân tâm sở hướng';
  if (val >= 60) return 'An cư lạc nghiệp';
  if (val >= 40) return 'Lòng người dao động';
  if (val >= 20) return 'Oán thán đầy đường';
  return 'Dân không lẽ sống';
}

function getShiqiDesc(val) {
  if (val >= 80) return 'Sĩ khí dâng cao';
  if (val >= 60) return 'Quân tâm ổn định';
  if (val >= 40) return 'Quân tâm dao động';
  if (val >= 20) return 'Sĩ khí thấp kém';
  return 'Sắp sửa binh biến';
}


const GUIXIN_COLLAPSE_KEY = 'wmqx_guixin_details_collapsed_v1';

function bindGuixinDetailsToggle(){
  const btn = document.getElementById('guixin-toggle-details');
  const panel = document.getElementById('guixin-panel');
  const details = document.getElementById('guixin-details');
  if (!btn || !panel || !details) return;

  if (btn.dataset.bound === '1') return;
  btn.dataset.bound = '1';

  const applyText = () => {
    const collapsed = panel.classList.contains('details-collapsed');
    btn.textContent = collapsed ? 'Chi tiết thu nhập' : 'Thu gọn chi tiết';
  };

  // Khôi phục trạng thái (mặc định: mở; nếu bạn muốn mặc định đóng, sửa thành true)
  const collapsed = localStorage.getItem(GUIXIN_COLLAPSE_KEY) === '1';
  if (collapsed) panel.classList.add('details-collapsed');
  applyText();

  btn.addEventListener('click', () => {
    panel.classList.toggle('details-collapsed');
    const now = panel.classList.contains('details-collapsed');
    applyText();
    try{ localStorage.setItem(GUIXIN_COLLAPSE_KEY, now ? '1' : '0'); }catch(e){}
  });
}

  // Khu vực trứng phục sinh
function bindHeaderEasterEgg(){
  const title = document.querySelector('.header-title');
  const layer = document.getElementById('easter-layer') || document.body;
  if (!title || !layer) return;

  if (title.dataset.eggBound === '1') return;
  title.dataset.eggBound = '1';

// Văn bản trứng phục sinh: Phân cấp theo độ hiếm (xác suất giảm dần)
const tipsByRarity = {
  common: [  // Xác suất 70%
    'Độ hảo cảm +1',
    'Cố lên~',
    '(≧∇≦)/',
    '⊹꙳ ˶˙ᵕ˙˶ ⊹꙳',
    '˃ 𖥦 ˂ ',
    'Hôm nay vất vả rồi~',
    'Sẽ thắng mà!',
    'Hét to Dao Quang đại nhân có bất ngờ~',
    'Mệt quá đi',
    'Dao Quang đại nhân xuất phẩm',
    'Lương thảo +1',
    'Nhân lực +1',
    'Lưu trữ thành công～',
    'Ha a～',
    'Hây a hây a',
    'Hôm nay cũng phải dính lấy nhau',
    'Xoa xoa đầu～',
    'Cọ cọ♡',
    'Ôm ôm!',
    'Hôn một cái～',
    'Đầu ngứa quá sắp mọc não rồi',
    'Đừng chọc nữa mà!',
    'Bạn không mỏi tay sao',
    'Bị bạn phát hiện rồi～',
    'Hi hi bị sờ rồi',
    'Ciallo(∠・ω< )⌒☆',
    'Ư… thoải mái quá',
    'Không được đi!',
    'Đồ ngốc♡',
    'Hừm…',
    'Đỏ mặt rồi…',
    'Tim đập nhanh',
    'Đã động lòng',
    'Hôm nay ăn gì',
    'Buồn ngủ quá…',
    'Đang lười biếng',
    'Không muốn ngủ',
    'Tôi gà quá đi',
    'A a a a',
    'Sắp muộn rồi!',
    'Ngủ ngon♡',
    'Chào buổi sáng☀',
    'Nên uống nước rồi',
    'Vươn vai cái nào～',
    'Ngáp một cái',
    'Chán quá',
    'Lại là tràn trề năng lượng… mới lạ',
    'Rất không vui lòng phục vụ ngài',
    'Cắn bạn(｡•﹃•｡)',
    '˙ᵕ˙˶ ',
    '꒰ ˶• ༝ - ˶꒱',
    'Dao Quang đại nhân tuyệt nhất!',
    '( ˶°ㅁ°) ',
    '૮₍ ˶•⤙•˶ ₎ა',
    '˃̵ᴗ˂̵',
    '(´｡• ᵕ •｡`)',
    '(◍•ᴗ•◍)✧*。',
    '( ˶ˆ꒳ˆ˵ )',
    '⸜(｡˃ ᵕ ˂ )⸝♡',
    '(◕ᴗ◕✿)',
    '(｡•́︿•̀｡)',
    '(╥﹏╥)',
    '(ง •̀_•́)ง',
    '(๑•̀ㅂ•́)و✧',
    '(๑´ㅂ`๑)',
    '(｡>‿‿<｡ )',
    '(｡•̀ᴗ-)و ̑̑✧',
    '(˶˃ ᵕ ˂˶)',
    '(｡•́‿•̀｡)',
    '(๑>◡<๑)',
    'Hây a～',
    'Hừ hừ～',
    'Hôm nay thời tiết thật tốt',
    'Lại muốn lười biếng rồi…',
    'Gù gù gù～',
    'Có muốn uống tách trà không?',
    'Mắt mỏi quá…',
    'Mai nói tiếp nhé (Chuồn',
    'A a chưa lưu!',
    'Thời gian trôi nhanh quá',
    'Chớp mắt đã tối rồi',
    'Sao lại đến thứ hai rồi',
    'Không muốn đi học…',
    'Thi cử toang rồi',
    'Cho tôi gù gù',
  ],
  
  uncommon: [  // Xác suất 20%
    'Tôi là chó của Elysia',
    'Ham muốn +1',
    'Bắc phạt hao tổn quốc lực...',
    'Chu Công nhả cơm...',
    'Nhân tài thiên hạ...',
    'Mãn chiêu tổn...',
    'Khiêm được lợi...',
    'Chỗ này không được đâu～',
    'Sắp hỏng mất rồi～',
    'Y thuật cao siêu～',
    'Người thành công đều dựa vào bản thân...',
    'Ngựa trắng?',
    'Tướng quân mời đi lối nhỏ này',
    '80 vs 60',
    'Đất Từ Châu...',
    'Bắc phạt! Bắc phạt!',
    'Meo meo meo?',
    'Sắp ra rồi～',
    'Ha a♥',
    'Ưu thế ở bạn!',
    'Chỗ này… không đượcっ',
    'Sắp ra rồi～っ',
    'Đại trượng phu sống giữa trời đất...',
    ' ⸝⸝⸝ ╸▵╺⸝⸝⸝',
    ' ˃̶͈ ꇴ ˂̶͈ ',
    'Xã bảo xã bảo!',
    'Luân hãm rồi…',
    'Muốn bị Nha 1 ngược',
    'Khấu bạo Kỳ 0',
    'Hu hu đừng dừngっ',
    'Sắp tan chảy rồi♥',
    'Hi～ nhớ tôi chưa～',
    'Lại lần nữa đi mà～',
    'Đừng dừng lại♡',
    'Gợi tình quá♡',
    'Biến thái… mới không phải',
    'Muốn bị Ellie đẩy ngã',
    'Nghĩ bậy rồi chứ gì',
  ],
  
  rare: [  // Xác suất 8%
    '1w＞5w',
    '100＞5w',
    '8＞5w',
    '100＞175',
  ],
  
  epic: [  // Xác suất 2% (Sử thi màu tím)
    'Nhấn nữa là khóc đấy!',
    'Phát hiện trứng phục sinh ẩn rồi',
    'Xác suất thấp nhất!',
    'Vận may bùng nổ!',
  ]
};

// Ghi lại chữ nhỏ vừa rút: Đảm bảo "3 lần gần nhất" không trùng
const recentTips = [];
const RECENT_LIMIT = 3;

// Chọn ngẫu nhiên một dòng chữ theo xác suất (không trùng trong 3 lần gần nhất)
function getRandomTip() {
  const rand = Math.random() * 100;
  let pool;

  if (rand < 70) {
    pool = tipsByRarity.common;      // 70%
  } else if (rand < 90) {
    pool = tipsByRarity.uncommon;    // 20%
  } else if (rand < 98) {
    pool = tipsByRarity.rare;        // 8%
  } else {
    pool = tipsByRarity.epic;        // 2%
  }

  // Lọc bỏ những chữ đã xuất hiện trong 3 lần gần nhất
  const recentSet = new Set(recentTips);
  let candidates = pool.filter(t => !recentSet.has(t));

  // Dự phòng: Nếu danh sách ứng cử viên trống (về lý thuyết kho của bạn rất lớn nên khó xảy ra), thì cho phép trùng, tránh không rút được
  if (candidates.length === 0) candidates = pool;

  const tip = candidates[Math.floor(Math.random() * candidates.length)];

  // Ghi vào "lịch sử gần đây" (chỉ giữ 3 dòng gần nhất)
  recentTips.push(tip);
  if (recentTips.length > RECENT_LIMIT) recentTips.splice(0, recentTips.length - RECENT_LIMIT);

  return tip;
}

  /* Ký hiệu "không quê mùa" hơn: Thiên về lấp lánh/hoa nhỏ/chấm nhỏ, ít dùng trái tim dày */
  const particleChars = ['✦','✧','⟡','⋆','·','•','❀','✿','❥'];

  /* Hồng dễ thương cao cấp: Thiên về hồng kem, hồng hoa anh đào, hồng đào nhạt */
  const colors = [
    '#ff5f93', // Hồng anh đào
    '#ff86b2', // Hồng sáng
    '#ffb3cf', // Hồng kem
    '#ffd1e6', // Hồng anh đào nhạt
    '#ffe1f0', // Hồng rất nhạt
    '#ffd2a2', // Vàng kem hoàng hôn (điểm xuyết)
    '#ffc2a8'  // Hồng đào
  ];

  function spawnRing(x, y){
    const ring = document.createElement('div');
    ring.className = 'easter-ring';
    ring.style.setProperty('--x', x + 'px');
    ring.style.setProperty('--y', y + 'px');
    layer.appendChild(ring);
    ring.addEventListener('animationend', () => ring.remove());
  }
  function spawnParticles(x, y){
    const isMobile = window.matchMedia && window.matchMedia('(max-width: 480px)').matches;
    const count = isMobile ? 10 : 16;

    for (let i = 0; i < count; i++){
      const p = document.createElement('span');
      p.className = 'easter-particle';
      p.textContent = particleChars[Math.floor(Math.random() * particleChars.length)];

      const c = colors[Math.floor(Math.random() * colors.length)];
      const fs = (11 + Math.random() * 8).toFixed(0) + 'px';

      // Rơi xuống: Tản ra hai bên + Bay xuống
      const dx = (Math.random() * 190 - 95).toFixed(0) + 'px';
      const dy = (70 + Math.random() * 170).toFixed(0) + 'px';

      const rot = (Math.random() * 70 - 35).toFixed(1) + 'deg';
      const s = (0.90 + Math.random() * 0.75).toFixed(2);
      const dur = (1500 + Math.random() * 1200).toFixed(0) + 'ms';

      p.style.setProperty('--x', x + 'px');
      p.style.setProperty('--y', y + 'px');
      p.style.setProperty('--c', c);
      p.style.setProperty('--fs', fs);
      p.style.setProperty('--dx', dx);
      p.style.setProperty('--dy', dy);
      p.style.setProperty('--rot', rot);
      p.style.setProperty('--s', s);
      p.style.setProperty('--dur', dur);

      layer.appendChild(p);
      p.addEventListener('animationend', () => p.remove());
    }
  }

function spawnTip(x, y){
  const el = document.createElement('div');
  el.className = 'easter-tip';
  el.textContent = getRandomTip();  // ← Đổi sang dùng hàm mới

    const dx = (Math.random() * 120 - 60).toFixed(0) + 'px';
    const dy = (70 + Math.random() * 90).toFixed(0) + 'px';
    const rot = (Math.random() * 12 - 6).toFixed(1) + 'deg';

    el.style.setProperty('--x', x + 'px');
    el.style.setProperty('--y', y + 'px');
    el.style.setProperty('--dx', dx);
    el.style.setProperty('--dy', dy);
    el.style.setProperty('--rot', rot);

    layer.appendChild(el);
    el.addEventListener('animationend', () => el.remove());
  }

  title.addEventListener('click', (ev) => {
    if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches){
      spawnTip(ev.clientX, ev.clientY);
      return;
    }
    let x = ev.clientX;
    let y = ev.clientY;

    // Chống dính biên
    x = Math.max(18, Math.min(window.innerWidth - 18, x));
    y = Math.max(18, Math.min(window.innerHeight - 18, y));

    spawnRing(x, y);
    spawnParticles(x, y);
    spawnTip(x, y);
  });
}

    function toggleExpand(element) {
      const listItem = element.closest('.list-item');
      if (listItem) listItem.classList.toggle('expanded');
    }

function openQuanshuEdit(tabId){
  populateQuanshuEditDefaults();
  populateQuanshuDeleteLists();
  openModal('modal-quanshu');
  if (tabId) switchTab('quanshu-edit-tabs', tabId);
}
function openTianmingEdit(tabId){
  populateTianmingEditDefaults();
  populateTianmingDeleteLists();
  openModal('modal-tianming');
  if (tabId) switchTab('tianming-edit-tabs', tabId);
}

function populateQuanshuEditDefaults(){
  const qs = window.__quanshuCache || {};
  const office = _.get(qs,'Quan_Chức',{}) || {};
  const set = (id, v) => { const el=document.getElementById(id); if(el) el.value = (v ?? ''); };

  set('qs-office-name', _.get(office,'Quan_Chức_Hiện_Tại','Không'));
  set('qs-office-rank', _.get(office,'Phẩm_Cấp','Không'));
  set('qs-office-scope', _.get(office,'Phạm_Vi_Thực_Quyền','Không'));
}

function populateTianmingEditDefaults(){
  const tm = window.__tianmingCache || {};
  const set = (id, v) => { const el=document.getElementById(id); if(el) el.value = (v ?? ''); };

  set('tm-value', Number(_.get(tm,'Giá_Trị_Thiên_Mệnh',0)) || 0);

  const cd = _.get(tm,'Điều_Kiện_Xưng_Đế',{}) || {};
  set('tm-cd-zhou', Number(_.get(cd,'Số_Châu_Chiếm_Đóng',0)) || 0);
  set('tm-cd-10k', _.get(cd,'Sở_Hữu_Vạn_Binh',false) ? 1 : 0);
  set('tm-cd-ready', _.get(cd,'Văn_Võ_Bá_Quan_Đầy_Đủ',false) ? 1 : 0);
  set('tm-cd-endorse', _.get(cd,'Thiên_Mệnh_Điềm_Lành_Ủng_Hộ',false) ? 1 : 0);
  set('tm-cd-urge', _.get(cd,'Được_Dâng_Sớ_Mời_Lên_Ngôi',false) ? 1 : 0);
  set('tm-cd-eval', _.get(cd,'Đánh_Giá_Tổng_Hợp','Chờ khởi tạo'));

  const nh = _.get(tm,'Niên_Hiệu_Và_Quốc_Hiệu',{}) || {};
  set('tm-nh-guo', _.get(nh,'Quốc_Hiệu_Dự_Định','Chờ khởi tạo'));
  set('tm-nh-nian', _.get(nh,'Niên_Hiệu_Dự_Định','Chờ khởi tạo'));
}

function populateQuanshuDeleteLists(){
  const qs = window.__quanshuCache || {};
  const fill = (id, keys, mkBtn) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = keys.length ? keys.map(mkBtn).join('') : `<div style="color:var(--text-muted);">Tạm không có</div>`;
  };

  fill('qs-paixi-delete', Object.keys(_.get(qs,'Quan_Hệ_Phe_Phái',{})||{}).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')),
    (k)=>`<div class="delete-item"><span class="delete-item-name">${k}</span><button class="delete-item-btn" onclick="generateQsPaixiDeletePatch('${k}');autoFillToChat('qs-output')">Xóa</button></div>`
  );
  fill('qs-chouma-delete', Object.keys(_.get(qs,'Kho_Chiêu_Bài',{})||{}).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')),
    (k)=>`<div class="delete-item"><span class="delete-item-name">${k}</span><button class="delete-item-btn" onclick="generateQsChoumaDeletePatch('${k}');autoFillToChat('qs-output')">Xóa</button></div>`
  );
  fill('qs-min-delete', Object.keys(_.get(qs,'Chính_Sách_Với_Dân',{})||{}).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')),
    (k)=>`<div class="delete-item"><span class="delete-item-name">${k}</span><button class="delete-item-btn" onclick="generateQsMinDeletePatch('${k}');autoFillToChat('qs-output')">Xóa</button></div>`
  );
  fill('qs-jun-delete', Object.keys(_.get(qs,'Chính_Sách_Với_Quân',{})||{}).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')),
    (k)=>`<div class="delete-item"><span class="delete-item-name">${k}</span><button class="delete-item-btn" onclick="generateQsJunDeletePatch('${k}');autoFillToChat('qs-output')">Xóa</button></div>`
  );
  fill('qs-mimou-delete', Object.keys(_.get(qs,'Mật_Mưu',{})||{}).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')),
    (k)=>`<div class="delete-item"><span class="delete-item-name">${k}</span><button class="delete-item-btn" onclick="generateQsMimouDeletePatch('${k}');autoFillToChat('qs-output')">Xóa</button></div>`
  );
}

function populateTianmingDeleteLists(){
  const tm = window.__tianmingCache || {};
  const fill = (id, keys, mkBtn) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = keys.length ? keys.map(mkBtn).join('') : `<div style="color:var(--text-muted);">Tạm không có</div>`;
  };

  fill('tm-xc-delete', Object.keys(_.get(tm,'Tuyên_Bố_Chủ_Quyền',{})||{}).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')),
    (k)=>`<div class="delete-item"><span class="delete-item-name">${k}</span><button class="delete-item-btn" onclick="generateTmXuanchengDeletePatch('${k}');autoFillToChat('tm-output')">Xóa</button></div>`
  );
  fill('tm-xr-delete', Object.keys(_.get(tm,'Điềm_Lành_Và_Điềm_Dữ',{})||{}).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')),
    (k)=>`<div class="delete-item"><span class="delete-item-name">${k}</span><button class="delete-item-btn" onclick="generateTmXiangruiDeletePatch('${k}');autoFillToChat('tm-output')">Xóa</button></div>`
  );
  fill('tm-cs-delete', Object.keys(_.get(tm,'Truyền_Thuyết_Dân_Gian',{})||{}).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')),
    (k)=>`<div class="delete-item"><span class="delete-item-name">${k}</span><button class="delete-item-btn" onclick="generateTmChuanshuoDeletePatch('${k}');autoFillToChat('tm-output')">Xóa</button></div>`
  );

  const extra = _.get(tm,'Điều_Kiện_Xưng_Đế.Điều_Kiện_Bổ_Sung',{}) || {};
  fill('tm-cd-extra-delete', Object.keys(extra).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')),
    (k)=>`<div class="delete-item"><span class="delete-item-name">${k}</span><button class="delete-item-btn" onclick="generateTmExtraDeletePatch('${k}');autoFillToChat('tm-output')">Xóa</button></div>`
  );
}

const quanshuModuleMap = {
  office: { title: '🏛 Quan chức', srcId: 'quanshu-office', editTab: 'qs-edit-office' },
  paixi:  { title: '🧩 Quan hệ phe phái', srcId: 'quanshu-paixi', editTab: 'qs-edit-paixi' },
  chouma: { title: '🪙 Kho chiêu bài', srcId: 'quanshu-chouma', editTab: 'qs-edit-chouma' },
  min:    { title: '📜 Chính sách với dân', srcId: 'quanshu-min', editTab: 'qs-edit-min' },
  jun:    { title: '⚔ Chính sách với quân', srcId: 'quanshu-jun', editTab: 'qs-edit-jun' },
  mimou:  { title: '🕯 Mật mưu', srcId: 'quanshu-mimou', editTab: 'qs-edit-mimou' },
};

function openQuanshuModule(key){
  const meta = quanshuModuleMap[key];
  if (!meta) return;

  const src = document.getElementById(meta.srcId);
  document.getElementById('quanshu-module-title').textContent = meta.title;
  document.getElementById('quanshu-module-body').innerHTML =
    (src && src.innerHTML.trim()) ? src.innerHTML : '<div class="empty-state">Tạm thời không có nội dung</div>';

  const editBtn = document.getElementById('quanshu-module-edit-btn');
  if (editBtn){
    editBtn.onclick = () => { closeModal('modal-quanshu-module'); openQuanshuEdit(meta.editTab); };
  }
  openModal('modal-quanshu-module');
}

const tianmingModuleMap = {
  value:     { title: '🌟 Giá trị thiên mệnh', srcId: 'tianming-value', editTab: 'tm-edit-value' },
  xuancheng: { title: '📣 Tuyên bố chủ quyền', srcId: 'tianming-xuancheng', editTab: 'tm-edit-xuancheng' },
  xiangrui:  { title: '🪶 Điềm lành và điềm dữ', srcId: 'tianming-xiangrui', editTab: 'tm-edit-xiangrui' },
  chuanshuo: { title: '📖 Truyền thuyết dân gian', srcId: 'tianming-chuanshuo', editTab: 'tm-edit-chuanshuo' },
  chengdi:   { title: '👑 Điều kiện xưng đế', srcId: 'tianming-chengdi', editTab: 'tm-edit-chengdi' },
  nianhao:   { title: '🏷 Niên hiệu và quốc hiệu', srcId: 'tianming-nianhao', editTab: 'tm-edit-nianhao' },
};

function openTianmingModule(key){
  const meta = tianmingModuleMap[key];
  if (!meta) return;

  const src = document.getElementById(meta.srcId);
  document.getElementById('tianming-module-title').textContent = meta.title;
  document.getElementById('tianming-module-body').innerHTML =
    (src && src.innerHTML.trim()) ? src.innerHTML : '<div class="empty-state">Tạm thời không có nội dung</div>';

  const editBtn = document.getElementById('tianming-module-edit-btn');
  if (editBtn){
    editBtn.onclick = () => { closeModal('modal-tianming-module'); openTianmingEdit(meta.editTab); };
  }
  openModal('modal-tianming-module');
}

function openWushuangModal(){
  populateWushuangEditDefaults();
  populateWushuangDeleteLists();
  openModal('modal-wushuang');
}

function populateWushuangEditDefaults(){
  const ws = window.__wushuangCache || {};
  const body = _.get(ws,'Tố_Chất_Cơ_Thể',{}) || {};
  const eq = _.get(ws,'Trang_Bị_Cá_Nhân',{}) || {};

  const setVal = (id, v) => { const el=document.getElementById(id); if(el) el.value = (v ?? ''); };

  setVal('ws-edit-power', _.get(body,'Sức_Mạnh',''));
  setVal('ws-edit-speed', _.get(body,'Tốc_Độ',''));
  setVal('ws-edit-stamina', _.get(body,'Bền_Bỉ',''));
  setVal('ws-edit-injury', _.get(body,'Thương_Bệnh','Không'));

  setVal('ws-eq-main', _.get(eq,'Vũ_Khí_Chính','Không'));
  setVal('ws-eq-sub', _.get(eq,'Vũ_Khí_Phụ','Không'));
  setVal('ws-eq-armor', _.get(eq,'Giáp_Trụ','Không'));
  setVal('ws-eq-mount', _.get(eq,'Thú_Cưỡi','Không'));
}

function populateWushuangDeleteLists(){
  const ws = window.__wushuangCache || {};
  const skills = _.get(ws,'Võ_Kỹ',{}) || {};
  const kills = _.get(ws,'Ghi_Chép_Trảm_Tướng',{}) || {};

  const sEl = document.getElementById('ws-skill-delete-list');
  if (sEl){
    const keys = Object.keys(skills);
    sEl.innerHTML = keys.length ? keys.sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')).map(k=>`
      <div class="delete-item">
        <span class="delete-item-name">${k}</span>
        <button class="delete-item-btn" onclick="generateWsSkillDeletePatch('${k}');autoFillToChat('ws-output')">Xóa</button>
      </div>
    `).join('') : `<div style="color:var(--text-muted);">Tạm không có võ kỹ</div>`;
  }

  const kEl = document.getElementById('ws-kill-delete-list');
  if (kEl){
    const keys = Object.keys(kills);
    kEl.innerHTML = keys.length ? keys.sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')).map(k=>`
      <div class="delete-item">
        <span class="delete-item-name">${k}</span>
        <button class="delete-item-btn" onclick="generateWsKillDeletePatch('${k}');autoFillToChat('ws-output')">Xóa</button>
      </div>
    `).join('') : `<div style="color:var(--text-muted);">Tạm không có ghi chép</div>`;
  }
}

function setWsOutput(patch){
  const el = document.getElementById('ws-output');
  if (el) el.textContent = JSON.stringify(patch, null, 2);
}

function setJsonOutput(elId, patch){
  const el = document.getElementById(elId);
  if (el) el.textContent = JSON.stringify(patch, null, 2);
}

/* ===== Patch Quyền Thuật ===== */
function generateQsOfficePatch(){
  const name = (document.getElementById('qs-office-name')?.value || '').trim() || 'Không';
  const rank = (document.getElementById('qs-office-rank')?.value || '').trim() || 'Không';
  const scope = (document.getElementById('qs-office-scope')?.value || '').trim() || 'Không';
  setJsonOutput('qs-output', [
    { op:'insert', path:'/Quyền_Thuật/Quan_Chức/Quan_Chức_Hiện_Tại', value: name },
    { op:'insert', path:'/Quyền_Thuật/Quan_Chức/Phẩm_Cấp', value: rank },
    { op:'insert', path:'/Quyền_Thuật/Quan_Chức/Phạm_Vi_Thực_Quyền', value: scope },
  ]);
}

function generateQsPaixiPatch(){
  const name = (document.getElementById('qs-paixi-name')?.value || '').trim();
  if (!name) return alert('Vui lòng điền tên phe phái');
  const att = parseInt(document.getElementById('qs-paixi-att')?.value || '0', 10) || 0;
  const obj = {
    Thái_Độ: att,
    Tranh_Chấp_Lợi_Ích: (document.getElementById('qs-paixi-link')?.value || '').trim() || 'Chờ khởi tạo',
    Nhân_Vật_Then_Chốt: (document.getElementById('qs-paixi-key')?.value || '').trim() || 'Chờ khởi tạo',
  };
  setJsonOutput('qs-output', [{ op:'insert', path:`/Quyền_Thuật/Quan_Hệ_Phe_Phái/${name}`, value: obj }]);
}
function generateQsPaixiDeletePatch(name){
  setJsonOutput('qs-output', [{ op:'remove', path:`/Quyền_Thuật/Quan_Hệ_Phe_Phái/${name}` }]);
}

function generateQsChoumaPatch(){
  const name = (document.getElementById('qs-chouma-name')?.value || '').trim();
  if (!name) return alert('Vui lòng điền tên chiêu bài');
  const obj = {
    Loại: (document.getElementById('qs-chouma-type')?.value || '').trim() || 'Chờ khởi tạo',
    Nhân_Vật_Liên_Quan: (document.getElementById('qs-chouma-people')?.value || '').trim() || 'Chờ khởi tạo',
    Giá_Trị: (document.getElementById('qs-chouma-value')?.value || '').trim() || 'Chờ khởi tạo',
    Trạng_Thái: (document.getElementById('qs-chouma-status')?.value || '').trim() || 'Chưa sử dụng',
  };
  setJsonOutput('qs-output', [{ op:'insert', path:`/Quyền_Thuật/Kho_Chiêu_Bài/${name}`, value: obj }]);
}
function generateQsChoumaDeletePatch(name){
  setJsonOutput('qs-output', [{ op:'remove', path:`/Quyền_Thuật/Kho_Chiêu_Bài/${name}` }]);
}

function generateQsMinPatch(){
  const name = (document.getElementById('qs-min-name')?.value || '').trim();
  if (!name) return alert('Vui lòng điền tên chính sách');
  const obj = {
    Nội_Dung: (document.getElementById('qs-min-content')?.value || '').trim() || 'Chờ khởi tạo',
    Hiệu_Quả: (document.getElementById('qs-min-effect')?.value || '').trim() || 'Chờ khởi tạo',
    Ảnh_Hưởng_Lòng_Dân: (document.getElementById('qs-min-heart')?.value || '').trim() || 'Chờ khởi tạo',
  };
  setJsonOutput('qs-output', [{ op:'insert', path:`/Quyền_Thuật/Chính_Sách_Với_Dân/${name}`, value: obj }]);
}
function generateQsMinDeletePatch(name){
  setJsonOutput('qs-output', [{ op:'remove', path:`/Quyền_Thuật/Chính_Sách_Với_Dân/${name}` }]);
}

function generateQsJunPatch(){
  const name = (document.getElementById('qs-jun-name')?.value || '').trim();
  if (!name) return alert('Vui lòng điền tên chính sách');
  const obj = {
    Nội_Dung: (document.getElementById('qs-jun-content')?.value || '').trim() || 'Chờ khởi tạo',
    Hiệu_Quả: (document.getElementById('qs-jun-effect')?.value || '').trim() || 'Chờ khởi tạo',
    Ảnh_Hưởng_Lòng_Quân: (document.getElementById('qs-jun-morale')?.value || '').trim() || 'Chờ khởi tạo',
  };
  setJsonOutput('qs-output', [{ op:'insert', path:`/Quyền_Thuật/Chính_Sách_Với_Quân/${name}`, value: obj }]);
}
function generateQsJunDeletePatch(name){
  setJsonOutput('qs-output', [{ op:'remove', path:`/Quyền_Thuật/Chính_Sách_Với_Quân/${name}` }]);
}

function generateQsMimouPatch(){
  const name = (document.getElementById('qs-mimou-name')?.value || '').trim();
  if (!name) return alert('Vui lòng điền tên mật mưu');
  const obj = {
    Mục_Tiêu: (document.getElementById('qs-mimou-target')?.value || '').trim() || 'Chờ khởi tạo',
    Người_Tham_Gia: (document.getElementById('qs-mimou-people')?.value || '').trim() || 'Chờ khởi tạo',
    Tiến_Độ: (document.getElementById('qs-mimou-progress')?.value || '').trim() || 'Chờ khởi tạo',
    Rủi_Ro: (document.getElementById('qs-mimou-risk')?.value || '').trim() || 'Chờ khởi tạo',
  };
  setJsonOutput('qs-output', [{ op:'insert', path:`/Quyền_Thuật/Mật_Mưu/${name}`, value: obj }]);
}
function generateQsMimouDeletePatch(name){
  setJsonOutput('qs-output', [{ op:'remove', path:`/Quyền_Thuật/Mật_Mưu/${name}` }]);
}

/* ===== Patch Thiên Mệnh ===== */
function generateTmValuePatch(){
  const v = parseInt(document.getElementById('tm-value')?.value || '0', 10) || 0;
  setJsonOutput('tm-output', [{ op:'insert', path:'/Thiên_Mệnh/Giá_Trị_Thiên_Mệnh', value: v }]);
}

function generateTmXuanchengPatch(){
  const name = (document.getElementById('tm-xc-name')?.value || '').trim();
  if (!name) return alert('Vui lòng điền tên tuyên bố');
  const obj = {
    Mục_Tiêu: (document.getElementById('tm-xc-target')?.value || '').trim() || 'Chờ khởi tạo',
    Căn_Cứ: (document.getElementById('tm-xc-basis')?.value || '').trim() || 'Chờ khởi tạo',
    Độ_Chấp_Nhận: (document.getElementById('tm-xc-ack')?.value || '').trim() || 'Không ai công nhận',
    Trạng_Thái: (document.getElementById('tm-xc-status')?.value || '').trim() || 'Tiềm năng',
  };
  setJsonOutput('tm-output', [{ op:'insert', path:`/Thiên_Mệnh/Tuyên_Bố_Chủ_Quyền/${name}`, value: obj }]);
}
function generateTmXuanchengDeletePatch(name){
  setJsonOutput('tm-output', [{ op:'remove', path:`/Thiên_Mệnh/Tuyên_Bố_Chủ_Quyền/${name}` }]);
}

function generateTmXiangruiPatch(){
  const name = (document.getElementById('tm-xr-name')?.value || '').trim();
  if (!name) return alert('Vui lòng điền tên sự kiện');
  const obj = {
    Thời_Gian: (document.getElementById('tm-xr-time')?.value || '').trim() || 'Chờ khởi tạo',
    Nội_Dung: (document.getElementById('tm-xr-content')?.value || '').trim() || 'Chờ khởi tạo',
    Tính_Chất: (document.getElementById('tm-xr-type')?.value || '').trim() || 'Chờ khởi tạo',
    Phạm_Vi_Lan_Truyền: (document.getElementById('tm-xr-range')?.value || '').trim() || 'Chờ khởi tạo',
    Có_Phải_Do_Người_Làm: (parseInt(document.getElementById('tm-xr-human')?.value || '0', 10) || 0) === 1,
  };
  setJsonOutput('tm-output', [{ op:'insert', path:`/Thiên_Mệnh/Điềm_Lành_Và_Điềm_Dữ/${name}`, value: obj }]);
}
function generateTmXiangruiDeletePatch(name){
  setJsonOutput('tm-output', [{ op:'remove', path:`/Thiên_Mệnh/Điềm_Lành_Và_Điềm_Dữ/${name}` }]);
}

function generateTmChuanshuoPatch(){
  const name = (document.getElementById('tm-cs-name')?.value || '').trim();
  if (!name) return alert('Vui lòng điền tên truyền thuyết');
  const obj = {
    Nội_Dung: (document.getElementById('tm-cs-content')?.value || '').trim() || 'Chờ khởi tạo',
    Nguồn_Gốc: (document.getElementById('tm-cs-from')?.value || '').trim() || 'Chờ khởi tạo',
    Sức_Ảnh_Hưởng: (document.getElementById('tm-cs-power')?.value || '').trim() || 'Chờ khởi tạo',
  };
  setJsonOutput('tm-output', [{ op:'insert', path:`/Thiên_Mệnh/Truyền_Thuyết_Dân_Gian/${name}`, value: obj }]);
}
function generateTmChuanshuoDeletePatch(name){
  setJsonOutput('tm-output', [{ op:'remove', path:`/Thiên_Mệnh/Truyền_Thuyết_Dân_Gian/${name}` }]);
}

function generateTmChengdiPatch(){
  const zhou = parseInt(document.getElementById('tm-cd-zhou')?.value || '0', 10) || 0;
  const b10k = (parseInt(document.getElementById('tm-cd-10k')?.value || '0', 10) || 0) === 1;
  const ready = (parseInt(document.getElementById('tm-cd-ready')?.value || '0', 10) || 0) === 1;
  const endorse = (parseInt(document.getElementById('tm-cd-endorse')?.value || '0', 10) || 0) === 1;
  const urge = (parseInt(document.getElementById('tm-cd-urge')?.value || '0', 10) || 0) === 1;
  const evalTxt = (document.getElementById('tm-cd-eval')?.value || '').trim() || 'Chờ khởi tạo';

  const extraName = (document.getElementById('tm-cd-extra-name')?.value || '').trim();
  const extraOk = (parseInt(document.getElementById('tm-cd-extra-ok')?.value || '0', 10) || 0) === 1;

  const patch = [
    { op:'insert', path:'/Thiên_Mệnh/Điều_Kiện_Xưng_Đế/Số_Châu_Chiếm_Đóng', value: zhou },
    { op:'insert', path:'/Thiên_Mệnh/Điều_Kiện_Xưng_Đế/Sở_Hữu_Vạn_Binh', value: b10k },
    { op:'insert', path:'/Thiên_Mệnh/Điều_Kiện_Xưng_Đế/Văn_Võ_Bá_Quan_Đầy_Đủ', value: ready },
    { op:'insert', path:'/Thiên_Mệnh/Điều_Kiện_Xưng_Đế/Thiên_Mệnh_Điềm_Lành_Ủng_Hộ', value: endorse },
    { op:'insert', path:'/Thiên_Mệnh/Điều_Kiện_Xưng_Đế/Được_Dâng_Sớ_Mời_Lên_Ngôi', value: urge },
    { op:'insert', path:'/Thiên_Mệnh/Điều_Kiện_Xưng_Đế/Đánh_Giá_Tổng_Hợp', value: evalTxt },
  ];

  if (extraName){
    patch.push({ op:'insert', path:`/Thiên_Mệnh/Điều_Kiện_Xưng_Đế/Điều_Kiện_Bổ_Sung/${extraName}`, value: extraOk });
  }
  setJsonOutput('tm-output', patch);
}

function generateTmExtraDeletePatch(name){
  setJsonOutput('tm-output', [{ op:'remove', path:`/Thiên_Mệnh/Điều_Kiện_Xưng_Đế/Điều_Kiện_Bổ_Sung/${name}` }]);
}

function generateTmNianhaoPatch(){
  const guo = (document.getElementById('tm-nh-guo')?.value || '').trim() || 'Chờ khởi tạo';
  const nian = (document.getElementById('tm-nh-nian')?.value || '').trim() || 'Chờ khởi tạo';
  setJsonOutput('tm-output', [
    { op:'insert', path:'/Thiên_Mệnh/Niên_Hiệu_Và_Quốc_Hiệu/Quốc_Hiệu_Dự_Định', value: guo },
    { op:'insert', path:'/Thiên_Mệnh/Niên_Hiệu_Và_Quốc_Hiệu/Niên_Hiệu_Dự_Định', value: nian },
  ]);
}

function generateWsBodyPatch(){
  const power = (document.getElementById('ws-edit-power')?.value || '').trim() || 'Chờ khởi tạo';
  const speed = (document.getElementById('ws-edit-speed')?.value || '').trim() || 'Chờ khởi tạo';
  const stamina = (document.getElementById('ws-edit-stamina')?.value || '').trim() || 'Chờ khởi tạo';
  const injury = (document.getElementById('ws-edit-injury')?.value || '').trim() || 'Không';

  const patch = [
    { op:'insert', path:'/Vô_Song/Tố_Chất_Cơ_Thể/Sức_Mạnh', value: power },
    { op:'insert', path:'/Vô_Song/Tố_Chất_Cơ_Thể/Tốc_Độ', value: speed },
    { op:'insert', path:'/Vô_Song/Tố_Chất_Cơ_Thể/Bền_Bỉ', value: stamina },
    { op:'insert', path:'/Vô_Song/Tố_Chất_Cơ_Thể/Thương_Bệnh', value: injury },
  ];
  setWsOutput(patch);
}

function generateWsEquipPatch(){
  const main = (document.getElementById('ws-eq-main')?.value || '').trim() || 'Không';
  const sub = (document.getElementById('ws-eq-sub')?.value || '').trim() || 'Không';
  const armor = (document.getElementById('ws-eq-armor')?.value || '').trim() || 'Không';
  const mount = (document.getElementById('ws-eq-mount')?.value || '').trim() || 'Không';

  const patch = [
    { op:'insert', path:'/Vô_Song/Trang_Bị_Cá_Nhân/Vũ_Khí_Chính', value: main },
    { op:'insert', path:'/Vô_Song/Trang_Bị_Cá_Nhân/Vũ_Khí_Phụ', value: sub },
    { op:'insert', path:'/Vô_Song/Trang_Bị_Cá_Nhân/Giáp_Trụ', value: armor },
    { op:'insert', path:'/Vô_Song/Trang_Bị_Cá_Nhân/Thú_Cưỡi', value: mount },
  ];
  setWsOutput(patch);
}

function generateWsSkillPatch(){
  const name = (document.getElementById('ws-skill-name')?.value || '').trim();
  if (!name) { alert('Vui lòng điền tên võ kỹ'); return; }

  const obj = {
    Loại: (document.getElementById('ws-skill-type')?.value || '').trim() || 'Chờ khởi tạo',
    Độ_Thành_Thục: (document.getElementById('ws-skill-prof')?.value || '').trim() || 'Sơ nhập',
    Thuyết_Minh: (document.getElementById('ws-skill-desc')?.value || '').trim() || 'Chờ khởi tạo',
  };
  setWsOutput([{ op:'insert', path:`/Vô_Song/Võ_Kỹ/${name}`, value: obj }]);
}
function generateWsSkillDeletePatch(name){
  setWsOutput([{ op:'remove', path:`/Vô_Song/Võ_Kỹ/${name}` }]);
}

function generateWsKillPatch(){
  const name = (document.getElementById('ws-kill-name')?.value || '').trim();
  if (!name) { alert('Vui lòng điền tên ghi chép'); return; }

  const obj = {
    Thời_Gian: (document.getElementById('ws-kill-time')?.value || '').trim() || 'Chờ khởi tạo',
    Đối_Thủ: (document.getElementById('ws-kill-foe')?.value || '').trim() || 'Chờ khởi tạo',
    Kết_Quả: (document.getElementById('ws-kill-result')?.value || '').trim() || 'Chờ khởi tạo',
  };
  setWsOutput([{ op:'insert', path:`/Vô_Song/Ghi_Chép_Trảm_Tướng/${name}`, value: obj }]);
}
function generateWsKillDeletePatch(name){
  setWsOutput([{ op:'remove', path:`/Vô_Song/Ghi_Chép_Trảm_Tướng/${name}` }]);
}

function openCaizhengModal(){
  populateCaizhengEditDefaults();
  populateCaizhengDeleteLists();
  openModal('modal-caizheng');
}

function populateCaizhengEditDefaults(){
  const cz = window.__caizhengCache || {};
  const silver = Number(_.get(cz, 'Phủ_Kho.Ngân_Lượng', 0)) || 0;
  const copper = Number(_.get(cz, 'Phủ_Kho.Quan_Tiền', 0)) || 0;

  const sEl = document.getElementById('cz-edit-silver');
  const cEl = document.getElementById('cz-edit-copper');
  if (sEl) sEl.value = silver;
  if (cEl) cEl.value = copper;
}

function populateCaizhengDeleteLists(){
  const cz = window.__caizhengCache || {};
  const income = _.get(cz, 'Chi_Tiết_Thu_Nhập', {}) || {};
  const expense = _.get(cz, 'Chi_Tiết_Chi_Tiêu', {}) || {};
  const routes = _.get(cz, 'Thương_Lộ', {}) || {};
  const caravans = _.get(cz, 'Thương_Đội', {}) || {};
  const inds = _.get(cz, 'Sản_Nghiệp', {}) || {};

  // Xóa thu chi
  const ledgerEl = document.getElementById('cz-ledger-delete-list');
  if (ledgerEl){
    let html = '';

    const incKeys = Object.keys(income);
    if (incKeys.length){
      html += `<div class="subsection-title">Thu nhập</div>`;
      html += incKeys.sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')).map(k=>`
        <div class="delete-item">
          <span class="delete-item-name">${k}（${Number(income[k])||0}）</span>
          <button class="delete-item-btn" onclick="generateCzIncomeDeletePatch('${k}');autoFillToChat('cz-output')">Xóa</button>
        </div>
      `).join('');
    }

    const expKeys = Object.keys(expense);
    if (expKeys.length){
      html += `<div class="subsection-title">Chi tiêu</div>`;
      html += expKeys.sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')).map(k=>`
        <div class="delete-item">
          <span class="delete-item-name">${k}（${Number(expense[k])||0}）</span>
          <button class="delete-item-btn" onclick="generateCzExpenseDeletePatch('${k}');autoFillToChat('cz-output')">Xóa</button>
        </div>
      `).join('');
    }

    ledgerEl.innerHTML = html || `<div style="color:var(--text-muted);">Tạm không có mục nào để xóa</div>`;
  }

  // Xóa thương lộ
  const routeDelEl = document.getElementById('cz-route-delete-list');
  if (routeDelEl){
    const keys = Object.keys(routes);
    routeDelEl.innerHTML = keys.length ? keys.sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')).map(k=>`
      <div class="delete-item">
        <span class="delete-item-name">${k}</span>
        <button class="delete-item-btn" onclick="generateCzRouteDeletePatch('${k}');autoFillToChat('cz-output')">Xóa</button>
      </div>
    `).join('') : `<div style="color:var(--text-muted);">Tạm không có thương lộ</div>`;
  }

  // Xóa thương đội
  const caravanDelEl = document.getElementById('cz-caravan-delete-list');
  if (caravanDelEl){
    const keys = Object.keys(caravans);
    caravanDelEl.innerHTML = keys.length ? keys.sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')).map(k=>`
      <div class="delete-item">
        <span class="delete-item-name">${k}</span>
        <button class="delete-item-btn" onclick="generateCzCaravanDeletePatch('${k}');autoFillToChat('cz-output')">Xóa</button>
      </div>
    `).join('') : `<div style="color:var(--text-muted);">Tạm không có thương đội</div>`;
  }

  // Xóa sản nghiệp
  const indDelEl = document.getElementById('cz-industry-delete-list');
  if (indDelEl){
    const keys = Object.keys(inds);
    indDelEl.innerHTML = keys.length ? keys.sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')).map(k=>`
      <div class="delete-item">
        <span class="delete-item-name">${k}</span>
        <button class="delete-item-btn" onclick="generateCzIndustryDeletePatch('${k}');autoFillToChat('cz-output')">Xóa</button>
      </div>
    `).join('') : `<div style="color:var(--text-muted);">Tạm không có sản nghiệp</div>`;
  }
}

function setCzOutput(patch){
  const el = document.getElementById('cz-output');
  if (el) el.textContent = JSON.stringify(patch, null, 2);
}

function generateCzTreasuryPatch(){
  const silver = parseInt(document.getElementById('cz-edit-silver')?.value || '0', 10) || 0;
  const copper = parseInt(document.getElementById('cz-edit-copper')?.value || '0', 10) || 0;

  const patch = [
    { op: 'insert', path: `/Tài_Chính/Phủ_Khố/Ngân_Lượng`, value: silver },
    { op: 'insert', path: `/Tài_Chính/Phủ_Khố/Quan_Tiền`, value: copper },
  ];
  setCzOutput(patch);
}

function generateCzIncomePatch(){
  const name = (document.getElementById('cz-income-name')?.value || '').trim();
  const amt = parseInt(document.getElementById('cz-income-amt')?.value || '0', 10) || 0;
  if (!name) { alert('Vui lòng điền nguồn thu nhập'); return; }

  const patch = (amt <= 0)
    ? [{ op:'remove', path:`/Tài_Chính/Chi_Tiết_Thu_Nhập/${name}` }]
    : [{ op:'insert', path:`/Tài_Chính/Chi_Tiết_Thu_Nhập/${name}`, value: amt }];

  setCzOutput(patch);
}
function generateCzExpensePatch(){
  const name = (document.getElementById('cz-expense-name')?.value || '').trim();
  const amt = parseInt(document.getElementById('cz-expense-amt')?.value || '0', 10) || 0;
  if (!name) { alert('Vui lòng điền nơi chi tiêu'); return; }

  const patch = (amt <= 0)
    ? [{ op:'remove', path:`/Tài_Chính/Chi_Tiết_Chi_Tiêu/${name}` }]
    : [{ op:'insert', path:`/Tài_Chính/Chi_Tiết_Chi_Tiêu/${name}`, value: amt }];

  setCzOutput(patch);
}

function generateCzIncomeDeletePatch(name){
  setCzOutput([{ op:'remove', path:`/Tài_Chính/Chi_Tiết_Thu_Nhập/${name}` }]);
}
function generateCzExpenseDeletePatch(name){
  setCzOutput([{ op:'remove', path:`/Tài_Chính/Chi_Tiết_Chi_Tiêu/${name}` }]);
}
function generateCzRoutePatch(){
  const name = (document.getElementById('cz-route-name')?.value || '').trim();
  if (!name) { alert('Vui lòng điền tên thương lộ'); return; }

  const obj = {
    Điểm_Khởi_Đầu: (document.getElementById('cz-route-from')?.value || '').trim() || 'Chờ khởi tạo',
    Điểm_Kết_Thúc: (document.getElementById('cz-route-to')?.value || '').trim() || 'Chờ khởi tạo',
    Độ_An_Toàn: (document.getElementById('cz-route-safe')?.value || '').trim() || 'Chờ khởi tạo',
    Hàng_Hóa_Chính: (document.getElementById('cz-route-goods')?.value || '').trim() || 'Chờ khởi tạo',
    Lợi_Nhuận_Dự_Kiến: (document.getElementById('cz-route-profit')?.value || '').trim() || 'Chờ khởi tạo',
  };

  setCzOutput([{ op:'insert', path:`/Tài_Chính/Thương_Lộ/${name}`, value: obj }]);
}
function generateCzRouteDeletePatch(name){
  setCzOutput([{ op:'remove', path:`/Tài_Chính/Thương_Lộ/${name}` }]);
}

function generateCzCaravanPatch(){
  const name = (document.getElementById('cz-caravan-name')?.value || '').trim();
  if (!name) { alert('Vui lòng điền tên thương đội'); return; }

  const goodName = (document.getElementById('cz-good-name')?.value || '').trim();
  const qty = parseInt(document.getElementById('cz-good-qty')?.value || '0', 10) || 0;
  const cost = parseInt(document.getElementById('cz-good-cost')?.value || '0', 10) || 0;

  const goods = {};
  if (goodName){
    goods[goodName] = { Số_Lượng: qty, Giá_Nhập: cost };
  }

  const obj = {
    Số_Lượng_Người: parseInt(document.getElementById('cz-caravan-people')?.value || '0', 10) || 0,
    Hộ_Vệ: parseInt(document.getElementById('cz-caravan-guards')?.value || '0', 10) || 0,
    Hàng_Hóa: goods,
    Vị_Trí_Hiện_Tại: (document.getElementById('cz-caravan-loc')?.value || '').trim() || 'Chờ khởi tạo',
    Điểm_Đến: (document.getElementById('cz-caravan-dst')?.value || '').trim() || 'Chờ khởi tạo',
    Trạng_Thái: (document.getElementById('cz-caravan-status')?.value || '').trim() || 'Chờ khởi tạo',
  };

  setCzOutput([{ op:'insert', path:`/Tài_Chính/Thương_Đội/${name}`, value: obj }]);
}
function generateCzCaravanDeletePatch(name){
  setCzOutput([{ op:'remove', path:`/Tài_Chính/Thương_Đội/${name}` }]);
}

function generateCzIndustryPatch(){
  const name = (document.getElementById('cz-ind-name')?.value || '').trim();
  if (!name) { alert('Vui lòng điền tên sản nghiệp'); return; }

  const obj = {
    Loại: (document.getElementById('cz-ind-type')?.value || '').trim() || 'Chờ khởi tạo',
    Vị_Trí: (document.getElementById('cz-ind-pos')?.value || '').trim() || 'Chờ khởi tạo',
    Sản_Lượng_Hàng_Tháng: parseInt(document.getElementById('cz-ind-out')?.value || '0', 10) || 0,
    Chi_Phí_Vận_Hành: parseInt(document.getElementById('cz-ind-cost')?.value || '0', 10) || 0,
    Mô_Tả: (document.getElementById('cz-ind-desc')?.value || '').trim() || 'Chờ khởi tạo',
  };

  setCzOutput([{ op:'insert', path:`/Tài_Chính/Sản_Nghiệp/${name}`, value: obj }]);
}
function generateCzIndustryDeletePatch(name){
  setCzOutput([{ op:'remove', path:`/Tài_Chính/Sản_Nghiệp/${name}` }]);
}

    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

function populateDiscardOptions(){
  const zichan = window.__zichanCache || {};
  const xitong = _.get(zichan, 'Không_Gian_Hệ_Thống', {});
  const mingmian = _.get(zichan, 'Tài_Sản_Công_Khai', {});
  const books = _.get(xitong, 'Sách_Đã_Nhận', {});

  // Không gian hệ thống: Ưu tiên mấy cái cố định bạn hiển thị
  const preferred = ['Gạo_Thượng_Hạng', 'Thịt_Tươi', 'Muối_Tinh_Thượng_Hạng', 'Dầu_Ăn_Nguyên_Chất', 'Vải_Thô_Bền', 'Lụa_Thượng_Hạng', 'Thức_Ăn_Chăn_Nuôi_Thượng_Hạng', 'Than_Củi_Không_Khói'];

  const systemSel = document.getElementById('discard-system-item');
  if (systemSel){
    const keys = Array.from(new Set([
      ...preferred,
      ...Object.keys(xitong).filter(k => k !== 'Sách_Đã_Nhận')
    ]));

    systemSel.innerHTML = keys.map(k => {
      const c = Number(_.get(xitong, k, 0)) || 0;
      return `<option value="${k}">${k} (Hiện có: ${c})</option>`;
    }).join('');
  }

  const mingSel = document.getElementById('discard-mingmian-item');
  if (mingSel){
    const keys = Object.keys(mingmian);
    mingSel.innerHTML = keys.length
      ? keys.map(k => {
          const c = _.get(mingmian, `${k}.Số_Lượng`, 0);
          return `<option value="${k}">${k} (Số lượng: ${c})</option>`;
        }).join('')
      : `<option value="" disabled selected>Tạm không có tài sản công khai</option>`;
  }

  const bookSel = document.getElementById('discard-book-item');
  if (bookSel){
    const keys = Object.keys(books || {});
    bookSel.innerHTML = keys.length
      ? keys.map(k => `<option value="${k}">${k}</option>`).join('')
      : `<option value="" disabled selected>Tạm không có sách</option>`;
  }
}

function generateDiscardSystemPatch(){
  const item = document.getElementById('discard-system-item')?.value;
  const amt = Math.max(1, parseInt(document.getElementById('discard-system-amount')?.value) || 1);
  if (!item) { alert('Vui lòng chọn vật phẩm'); return; }

  const zichan = window.__zichanCache || {};
  const cur = Number(_.get(zichan, ['Không_Gian_Hệ_Thống', item], 0)) || 0;
  const next = Math.max(0, cur - amt);

  const patch = (next <= 0)
    ? [{ op: 'remove', path: `/Tài_Sản/Không_Gian_Hệ_Thống/${item}` }]
    : [{ op: 'insert', path: `/Tài_Sản/Không_Gian_Hệ_Thống/${item}`, value: next }];

  document.getElementById('discard-output-system').textContent = JSON.stringify(patch, null, 2);
}

function generateDiscardMingmianPatch(){
  const item = document.getElementById('discard-mingmian-item')?.value;
  const amt = Math.max(1, parseInt(document.getElementById('discard-mingmian-amount')?.value) || 1);
  if (!item) { alert('Vui lòng chọn mục tài sản công khai'); return; }

  const zichan = window.__zichanCache || {};
  const cur = Number(_.get(zichan, ['Tài_Sản_Công_Khai', item, 'Số_Lượng'], 0)) || 0;
  const next = Math.max(0, cur - amt);

  const patch = (next <= 0)
    ? [{ op: 'remove', path: `/Tài_Sản/Tài_Sản_Công_Khai/${item}` }]
    : [{ op: 'insert', path: `/Tài_Sản/Tài_Sản_Công_Khai/${item}/Số_Lượng`, value: next }];

  document.getElementById('discard-output-mingmian').textContent = JSON.stringify(patch, null, 2);
}

function generateDiscardBookPatch(){
  const book = document.getElementById('discard-book-item')?.value;
  if (!book) { alert('Vui lòng chọn sách'); return; }

  const patch = [
    { op: 'remove', path: `/Tài_Sản/Không_Gian_Hệ_Thống/Sách_Đã_Nhận/${book}` }
  ];
  document.getElementById('discard-output-book').textContent = JSON.stringify(patch, null, 2);
}

function switchTab(tabGroup, tabId) {
  const groupEl = document.querySelector(`.${tabGroup}`);
  if (!groupEl) return;

  // Giới hạn "phạm vi" trong cửa sổ bật lên (modal) hiện tại, tránh ảnh hưởng đến các cửa sổ/trang khác
  const scope = groupEl.closest('.modal-content') || document;

  // 1) Nút: Chỉ xử lý các nút của nhóm tab hiện tại
  const btns = Array.from(scope.querySelectorAll(`.${tabGroup} .tab-btn`));
  btns.forEach(b => b.classList.remove('active'));

  // 2) Bảng điều khiển: Chỉ ẩn "bảng tương ứng với các nút của nhóm tab này", đảm bảo sau khi chuyển đổi các nội dung khác đều biến mất
  const panelIds = btns.map(b => b.dataset.tab).filter(Boolean);
  panelIds.forEach(id => {
    const panel = scope.querySelector(`#${id}`);
    if (panel) panel.classList.remove('active');
  });

  // 3) Kích hoạt nút hiện tại + bảng hiện tại
  const activeBtn = scope.querySelector(`.${tabGroup} .tab-btn[data-tab="${tabId}"]`);
  const activePanel = scope.querySelector(`#${tabId}`);
  if (activeBtn) activeBtn.classList.add('active');
  if (activePanel) activePanel.classList.add('active');

  // 4) Chỉ dùng để làm đẹp: Cập nhật vị trí thanh trượt tab (không ảnh hưởng chức năng)
  const idx = btns.findIndex(b => b.dataset.tab === tabId);
  if (idx >= 0) {
    groupEl.style.setProperty('--tab-count', btns.length);
    groupEl.style.setProperty('--active-index', idx);
  }
}

const zhengfuModuleMap = {
  jundui:   { title: '⚔ Biên chế quân đội', contentId: 'zhengfu-jundui' },
  sanbing:  { title: '🪖 Trại lính lẻ',   contentId: 'zhengfu-sanbing' },
  jiangling:{ title: '🎖 Danh sách tướng lĩnh',   contentId: 'zhengfu-jiangling' },
  junbei:   { title: '🛡 Kho quân bị',   contentId: 'zhengfu-junbei' },
  xunlian:  { title: '📋 Sổ sách huấn luyện', contentId: 'zhengfu-xunlian' },
  fulu:     { title: '⛓ Trại tù binh',   contentId: 'zhengfu-fulu' },
  zhanyi:   { title: '📜 Nhật ký chiến dịch',   contentId: 'zhengfu-zhanyi' }
};

function openZhengfuModule(key){
  const meta = zhengfuModuleMap[key];
  if (!meta) return;

  const src = document.getElementById(meta.contentId);
  const titleEl = document.getElementById('zhengfu-module-title');
  const bodyEl = document.getElementById('zhengfu-module-body');

  if (titleEl) titleEl.textContent = meta.title;
  if (bodyEl) bodyEl.innerHTML = (src && src.innerHTML.trim())
    ? src.innerHTML
    : '<div class="empty-state"><div class="empty-state-icon">📄</div>Tạm không có nội dung</div>';

  openModal('modal-zhengfu-module');
}

const RENMAI_PIN_KEY = 'wmqx_renmai_pins_v1';

function getRenmaiPinSet(){
  try{
    const raw = localStorage.getItem(RENMAI_PIN_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return new Set(Array.isArray(arr) ? arr : []);
  }catch(e){
    return new Set();
  }
}
function saveRenmaiPinSet(set){
  try{
    localStorage.setItem(RENMAI_PIN_KEY, JSON.stringify(Array.from(set)));
  }catch(e){}
}

/* encodedName đã qua encodeURIComponent */
function toggleRenmaiPinned(encodedName, ev){
  if (ev){
    ev.stopPropagation();
    ev.preventDefault();
  }
  const name = decodeURIComponent(encodedName);
  const pins = getRenmaiPinSet();
  if (pins.has(name)) pins.delete(name);
  else pins.add(name);
  saveRenmaiPinSet(pins);

  // Render lại trực tiếp (ổn định nhất, một lần xong)
  populateCharacterData();
}

function populateHongyanList(){
  const renmai = window.__renmaiCache || {};
  const listEl = document.getElementById('hongyan-list');
  if (!listEl) return;

  const entries = Object.entries(renmai).filter(([name, data]) => {
    return !!_.get(data, 'Thông_Tin_Cơ_Bản.Hồng_Nhan_Tri_Kỷ', false);
  });

  if (entries.length === 0){
    listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🌸</div>Tạm không có hồng nhan tri kỷ</div>';
    return;
  }

  entries.sort((a,b)=> a[0].localeCompare(b[0], 'zh-Hans-CN'));

  listEl.innerHTML = entries.map(([name, data])=>{
    const baseInfo = _.get(data,'Thông_Tin_Cơ_Bản',{});
    const gender = _.get(baseInfo,'Giới_Tính','Chưa rõ');
    const age = _.get(baseInfo,'Tuổi','Chưa rõ');
    const identity = _.get(baseInfo,'Thân_Phận','Chưa rõ');
    const rating = _.get(baseInfo,'Hệ_Thống_Đánh_Giá','N/A');
    const safeName = encodeURIComponent(name);

    let badgeClass = '';
    if (String(rating).includes('S')) badgeClass = 'red';
    else if (String(rating).includes('A')) badgeClass = 'green';

    return `
      <div class="list-item renmai-row" onclick="closeModal('modal-hongyan');openRenmaiProfile('${safeName}')">
        <div class="renmai-row-inner">
          <div class="renmai-row-left">
            <div class="renmai-row-name">${fmt(name)}</div>
            <div class="renmai-row-sub">${gender}/${age}</div>
          </div>
          <div class="renmai-row-right">
            <span class="list-badge ${badgeClass}">${fmt(identity)}</span>
            <span class="list-badge" style="border-color:#ff86b2;color:#ff86b2;">Hồng nhan</span>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function openHongyanModal(){
  populateHongyanList();
  openModal('modal-hongyan');
}

function openRenmaiProfile(encodedName){
  const name = decodeURIComponent(encodedName);

  const renmai = window.__renmaiCache || {};
  const data = renmai[name];
  if (!data) { alert('Không tìm thấy dữ liệu nhân vật này: ' + name); return; }

  const baseInfo = _.get(data, 'Thông_Tin_Cơ_Bản', {});
  const gender = _.get(baseInfo, 'Giới_Tính', 'Chưa rõ');
  const age = _.get(baseInfo, 'Tuổi', 'Chưa rõ');
  const identity = _.get(baseInfo, 'Thân_Phận', 'Chưa rõ');
  const personality = _.get(baseInfo, 'Tính_Cách', 'Chưa rõ');
  const rating = _.get(baseInfo, 'Hệ_Thống_Đánh_Giá', 'N/A');
  const favor = _.get(baseInfo, 'Độ_Hảo_Cảm', 0);
  const depend = _.get(baseInfo, 'Độ_Lệ_Thuộc', 0);
  const lust = _.get(baseInfo, 'Độ_Ham_Muốn', 0);
  const thought = _.get(baseInfo, 'Suy_Nghĩ_Hiện_Tại', 'Chưa rõ');
  const location = _.get(baseInfo, 'Vị_Trí_Hiện_Tại', 'Chưa rõ');
  const health = _.get(baseInfo, 'Trạng_Thai_Sức_Khỏe', 'Bình thường');
  const belongTag = _.get(baseInfo, 'Nhân_Trực_Thuộc', 'Không trực thuộc');
  const countHead = _.get(baseInfo, 'Tính_Vào_Đầu_Người', false);

  const skills = _.get(data, 'Kỹ_Năng_Sở_Trường', 'Chưa rõ');
  const clothing = _.get(data, 'Trang_Phục', 'Chưa rõ');
  const appearance = _.get(data, 'Dung_Mạo', 'Chưa rõ');
  const bodyData = _.get(data, 'Số_Đo_Cơ_Thể', 'Không áp dụng');
  const privateData = _.get(data, 'Hồ_Sơ_Riêng_Tư', 'Không áp dụng');
  const seseData = _.get(data, 'Hồ_Sơ_Phòng_The', {});

  const isFemale = gender === 'Nữ';

  const favorClass = favor >= 0 ? 'positive' : 'negative';
  const dependClass = depend >= 0 ? 'positive' : 'negative';

  // Màu huy hiệu đánh giá (giữ nguyên logic gốc của bạn)
  let badgeClass = '';
  if (String(rating).includes('S')) badgeClass = 'red';
  else if (String(rating).includes('A')) badgeClass = 'green';

  let seseHtml = '';
  if (isFemale && seseData && _.get(seseData, 'Tổng_Số_Lần_Kinh_Nghiệm', 0) !== 'Không áp dụng') {
    seseHtml = `
      <div class="sese-section">
        <div class="sese-title">▸ Hồ sơ phòng the</div>
        <div class="sese-grid">
          <div class="sese-item"><span class="sese-item-label">Tổng số lần kinh nghiệm</span><span class="sese-item-value">${_.get(seseData, 'Tổng_Số_Lần_Kinh_Nghiệm', 0)}</span></div>
          <div class="sese-item"><span class="sese-item-label">Quan hệ bằng miệng</span><span class="sese-item-value">${_.get(seseData, 'Quan_Hệ_Bằng_Miệng.Số_Lần', 0)} lần</span></div>
          <div class="sese-item"><span class="sese-item-label">Quan hệ bằng ngực</span><span class="sese-item-value">${_.get(seseData, 'Quan_Hệ_Bằng_Ngực.Số_Lần', 0)} lần</span></div>
<div class="sese-item"><span class="sese-item-label">Quan hệ bằng chân</span><span class="sese-item-value">${_.get(seseData, 'Quan_Hệ_Bằng_Chân.Số_Lần', 0)} lần</span></div>
          <div class="sese-item"><span class="sese-item-label">Âm đạo</span><span class="sese-item-value">${_.get(seseData, 'Âm_Đạo.Số_Lần', 0)} lần</span></div>
          <div class="sese-item"><span class="sese-item-label">Bắn vào miệng</span><span class="sese-item-value">${_.get(seseData, 'Bắn_Vào_Miệng.Số_Lần', 0)} lần</span></div>
          <div class="sese-item"><span class="sese-item-label">Bắn vào trong</span><span class="sese-item-value">${_.get(seseData, 'Bắn_Vào_Trong.Số_Lần', 0)} lần</span></div>
          <div class="sese-item"><span class="sese-item-label">Bắn vào mặt</span><span class="sese-item-value">${_.get(seseData, 'Bắn_Vào_Mặt.Số_Lần', 0)} lần</span></div>
        </div>
      </div>
    `;
  }

  const html = `
    <div class="renmai-profile-header">
      <div class="renmai-profile-title">${fmt(name)}</div>
      <div class="renmai-profile-badges">
        <span class="list-badge ${badgeClass}">${identity}</span>
        <span class="list-badge">${rating}</span>
        <span class="list-badge green">${belongTag}</span>
        <span class="list-badge ${countHead ? 'green' : ''}">${countHead ? 'Tính vào đầu người' : 'Không tính vào đầu người'}</span>
      </div>
    </div>

    <div class="person-basic-info" style="margin-bottom: 14px;">
      <div class="person-stat"><div class="person-stat-label">Độ hảo cảm</div><div class="person-stat-value ${favorClass}">${favor}</div></div>
      <div class="person-stat"><div class="person-stat-label">Độ lệ thuộc</div><div class="person-stat-value ${dependClass}">${depend}</div></div>
      <div class="person-stat"><div class="person-stat-label">Giới tính/Tuổi</div><div class="person-stat-value">${gender}/${age}</div></div>
      ${isFemale ? `<div class="person-stat"><div class="person-stat-label">Độ ham muốn</div><div class="person-stat-value" style="color:#e88080;">${lust}</div></div>` : `
        <div class="person-stat"><div class="person-stat-label">Độ ham muốn</div><div class="person-stat-value" style="color:var(--text-muted);">Không áp dụng</div></div>
      `}
      <div class="person-stat"><div class="person-stat-label">Vị trí hiện tại</div><div class="person-stat-value" style="font-size:12px;">${location}</div></div>
      <div class="person-stat"><div class="person-stat-label">Trạng thái sức khỏe</div><div class="person-stat-value" style="color:${health === 'Bình thường' ? 'var(--jade-green)' : '#ffb2b2'};">${health}</div></div>
    </div>

    <div class="info-group"><div class="info-label">▸ Tính cách</div><div class="info-value">${personality}</div></div>
    <div class="info-group"><div class="info-label">▸ Kỹ năng sở trường</div><div class="info-value">${skills}</div></div>
    <div class="info-group"><div class="info-label">▸ Suy nghĩ hiện tại</div><div class="info-value">${thought}</div></div>
    <div class="info-group"><div class="info-label">▸ Dung mạo</div><div class="info-value">${appearance}</div></div>
    <div class="info-group"><div class="info-label">▸ Trang phục</div><div class="info-value">${clothing}</div></div>

    ${isFemale && bodyData !== 'Không áp dụng' ? `<div class="info-group"><div class="info-label">▸ Số đo cơ thể</div><div class="info-value">${bodyData}</div></div>` : ''}
    ${isFemale && privateData !== 'Không áp dụng' ? `<div class="info-group"><div class="info-label">▸ Hồ sơ riêng tư</div><div class="info-value">${privateData}</div></div>` : ''}

    ${seseHtml}
  `;

  document.getElementById('renmai-profile-modal-title').textContent = `${fmt(name)} · Hồ sơ nhân vật`;
  document.getElementById('renmai-profile-content').innerHTML = html;

  openModal('modal-renmai-profile');
}

    function generateRenmaiPatch() {
      const gender = document.getElementById('npc-gender').value;
      const name = document.getElementById('npc-name').value.trim();
      if (!name) { alert('Vui lòng điền tên nhân vật'); return; }

      const isFemale = gender === 'Nữ';

      const newNpc = {
        Thông_Tin_Cơ_Bản: {
          Giới_Tính: gender,
          Tính_Cách: document.getElementById('npc-personality').value.trim() || 'Chưa rõ',
          Thân_Phận: document.getElementById('npc-identity').value.trim() || 'Chưa rõ',
          Hồng_Nhan_Tri_Kỷ: (document.getElementById('npc-hongyan')?.value === '1'),
          Hệ_Thống_Đánh_Giá: document.getElementById('npc-rating').value.trim() || 'N/A',
          Độ_Hảo_Cảm: parseInt(document.getElementById('npc-favor').value) || 0,
          Độ_Lệ_Thuộc: parseInt(document.getElementById('npc-depend').value) || 0,
          Độ_Ham_Muốn: parseInt(document.getElementById('npc-lust').value) || 0,
          Suy_Nghĩ_Hiện_Tại: document.getElementById('npc-thought').value.trim() || 'Chưa rõ'
        },
        Trang_Phục: document.getElementById('npc-clothing').value.trim() || 'Chưa rõ',
        Dung_Mạo: document.getElementById('npc-appearance').value.trim() || 'Chưa rõ',
        Số_Đo_Cơ_Thể: isFemale ? (document.getElementById('npc-body').value.trim() || 'Chưa mô tả') : 'Không áp dụng',
        Hồ_Sơ_Riêng_Tư: isFemale ? (document.getElementById('npc-private').value.trim() || 'Chưa mô tả') : 'Không áp dụng',
        Hồ_Sơ_Phòng_The: isFemale ? {
          Tổng_Số_Lần_Kinh_Nghiệm: 0,
          Quan_Hệ_Bằng_Miệng: { Số_Lần: 0, Mô_Tả: 'Không' },
          Quan_Hệ_Bằng_Ngực: { Số_Lần: 0, Mô_Tả: 'Không' },
          Quan_Hệ_Bằng_Chân: { Số_Lần: 0, Mô_Tả: 'Không' },
          Âm_Đạo: { Số_Lần: 0, Mô_Tả: 'Không' },
          Bắn_Vào_Miệng: { Số_Lần: 0, Mô_Tả: 'Không' },
          Bắn_Vào_Trong: { Số_Lần: 0, Mô_Tả: 'Không' },
          Bắn_Vào_Mặt: { Số_Lần: 0, Mô_Tả: 'Không' }
        } : {
          Tổng_Số_Lần_Kinh_Nghiệm: 0,
          Quan_Hệ_Bằng_Miệng: { Số_Lần: 0, Mô_Tả: 'Không áp dụng' },
          Quan_Hệ_Bằng_Ngực: { Số_Lần: 0, Mô_Tả: 'Không áp dụng' },
          Quan_Hệ_Bằng_Chân: { Số_Lần: 0, Mô_Tả: 'Không áp dụng' },
          Âm_Đạo: { Số_Lần: 0, Mô_Tả: 'Không áp dụng' },
          Bắn_Vào_Miệng: { Số_Lần: 0, Mô_Tả: 'Không áp dụng' },
          Bắn_Vào_Trong: { Số_Lần: 0, Mô_Tả: 'Không áp dụng' },
          Bắn_Vào_Mặt: { Số_Lần: 0, Mô_Tả: 'Không áp dụng' }
        }
      };

      const patch = [
        { op: 'insert', path: `/Nhân_Mạch/${name}`, value: newNpc }
      ];

      document.getElementById('renmai-output').textContent = JSON.stringify(patch, null, 2);
    }

    function generateRenmaiDeletePatch(name) {
      const patch = [
        { op: 'remove', path: `/Nhân_Mạch/${name}` }
      ];
      document.getElementById('renmai-delete-output').textContent = JSON.stringify(patch, null, 2);
    }

function generateDashiPatch() {
  const name = document.getElementById('dashi-name').value.trim();
  if (!name) { alert('Vui lòng điền tên thế lực'); return; }

  const newDashi = {
    Khái_Quát: document.getElementById('dashi-gaikuang').value.trim() || 'Tạm không có thông tin',
    Binh_Lực: {},
    Lương_Thảo: parseInt(document.getElementById('dashi-liangcao').value) || 0,
    Sự_Kiện_Tiêu_Điểm: document.getElementById('dashi-jiaodian').value.trim() || 'Tạm không có'
  };

  const troopName = document.getElementById('dashi-troop-name').value.trim();
  if (troopName) {
    newDashi.Binh_Lực[troopName] = {
      Số_Lượng: parseInt(document.getElementById('dashi-troop-count').value) || 0,
      Độ_Huấn_Luyện: document.getElementById('dashi-troop-training').value.trim() || 'Chưa rõ',
      Trang_Bị: document.getElementById('dashi-troop-equip').value.trim() || 'Chưa rõ'
    };
  }

  const patch = [
    { op: 'insert', path: `/Đại_Thế/Động_Thái_Thế_Lực/${name}`, value: newDashi }
  ];

  document.getElementById('dashi-output').textContent = JSON.stringify(patch, null, 2);
}

function generateDashiDeletePatch(name) {
  const patch = [
    { op: 'remove', path: `/Đại_Thế/Động_Thái_Thế_Lực/${name}` }
  ];
  document.getElementById('dashi-delete-output').textContent = JSON.stringify(patch, null, 2);
}

    function populateCharacterData() {
      const all_variables = getAllVariables();

      // ===== Thời Gian =====
      const shijian = _.get(all_variables, 'stat_data.Thời_Gian', {});
      const dangqianRiqi = _.get(shijian, 'Ngày_Hiện_Tại', 'Thuận An năm thứ 83');
      const dangqianShichen = _.get(shijian, 'Giờ_Hiện_Tại', '');
      document.getElementById('header-date').textContent = dangqianShichen ? `${fmt(dangqianRiqi)} · ${fmt(dangqianShichen)}` : fmt(dangqianRiqi);

      // ===== Đại Thế =====
const dashi = _.get(all_variables, 'stat_data.Đại_Thế', {});

// Tin đồn (Hỗ trợ hiển thị phân cách nhiều tin)
const xiaodaoRaw = _.get(dashi, 'Tin_Đồn', 'Tạm không có tin tức');

// Giả sử nhiều tin dùng ký tự xuống dòng \n, hoặc | hoặc ； để phân cách
// Ở đây thống nhất xử lý: Tách theo xuống dòng, | hoặc dấu chấm phẩy tiếng Trung
const xiaodaoArr = xiaodaoRaw
  .split(/[\n|；]/)
  .map(s => s.trim())
  .filter(s => s.length > 0);

let xiaodaoHtml = '';
if (xiaodaoArr.length === 0) {
  xiaodaoHtml = 'Tạm không có tin tức';
} else if (xiaodaoArr.length === 1) {
  xiaodaoHtml = fmt(xiaodaoArr[0]);
} else {
  // Nhiều tin, dùng kiểu danh sách hiển thị
  xiaodaoHtml = xiaodaoArr.map((msg, idx) => `
    <div style="padding: 10px 14px; margin-bottom: 8px; background: rgba(0,0,0,0.15); border-radius: 8px; border-left: 2px solid var(--sunset-orange); font-size: 12px; line-height: 1.6;">
      <span style="color: var(--text-muted); font-size: 10px; margin-right: 6px;">【${idx + 1}】</span>${fmt(msg)}
    </div>
  `).join('');
}

document.getElementById('dashi-xiaodao').innerHTML = xiaodaoHtml;

// Động thái thế lực
const shiliDongtai = _.get(dashi, 'Động_Thái_Thế_Lực', {});
let dashiHtml = '';
let dashiDeleteHtml = '';

if (Object.keys(shiliDongtai).length === 0) {
  dashiHtml = '<div class="empty-state"><div class="empty-state-icon">🏴</div>Tạm không có tình báo thế lực</div>';
} else {
  Object.entries(shiliDongtai).forEach(([name, data]) => {
    const gaikuang = _.get(data, 'Khái_Quát', 'Tạm không có thông tin');
    const lingxiu = _.get(data, 'Lãnh_Đạo', 'Chưa rõ');
    const guanxi = _.get(data, 'Quan_Hệ_Với_Nhân_Vật_Chính', 'Trung lập');

    const bingli = _.get(data, 'Binh_Lực', {});
    const liangcao = _.get(data, 'Lương_Thảo', 'Chưa rõ');
    const jiaodian = _.get(data, 'Sự_Kiện_Tiêu_Điểm', 'Tạm không');

          let bingliHtml = '';
          Object.entries(bingli).forEach(([troopName, troopData]) => {
            const count = _.get(troopData, 'Số_Lượng', 0);
            const training = _.get(troopData, 'Độ_Huấn_Luyện', 'Chưa rõ');
            const equipment = _.get(troopData, 'Trang_Bị', 'Chưa rõ');
            bingliHtml += `
              <div class="troop-card">
                <div class="troop-name">${fmt(troopName)}</div>
                <div class="troop-stats">
                  <div class="troop-stat"><div class="troop-stat-label">Binh lực</div><div class="troop-stat-value">${typeof count === 'number' ? count.toLocaleString() : count}</div></div>
                  <div class="troop-stat"><div class="troop-stat-label">Độ huấn luyện</div><div class="troop-stat-value">${fmt(training)}</div></div>
                  <div class="troop-stat"><div class="troop-stat-label">Trang bị</div><div class="troop-stat-value">${fmt(equipment)}</div></div>
                </div>
              </div>
            `;
          });

          if (!bingliHtml) bingliHtml = '<div style="color: var(--text-muted); padding: 10px;">Tạm không có thông tin binh lực</div>';

          // Màu quan hệ
          let guanxiClass = '';
          if (guanxi === 'Thù địch') guanxiClass = 'red';
          else if (guanxi === 'Hữu hảo' || guanxi === 'Trực thuộc') guanxiClass = 'green';

          dashiHtml += `
            <div class="list-item">
              <div class="list-header" onclick="toggleExpand(this)">
                <div class="list-name">${fmt(name)}</div>
                <div style="display: flex; align-items: center; gap: 10px;">
                  <span class="list-badge ${guanxiClass}">${fmt(guanxi)}</span>
                  <span class="expand-icon">▼</span>
                </div>
              </div>
              <div class="list-content">
                <div class="content-inner">
                  <div class="person-basic-info" style="grid-template-columns: repeat(2, 1fr); margin-bottom: 14px;">
                    <div class="person-stat"><div class="person-stat-label">Lãnh đạo</div><div class="person-stat-value">${fmt(lingxiu)}</div></div>
                    <div class="person-stat"><div class="person-stat-label">Lương thảo</div><div class="person-stat-value">${fmt(typeof liangcao === 'number' ? liangcao.toLocaleString() : liangcao)}</div></div>
                  </div>
                  <div class="info-group"><div class="info-label">▸ Khái quát</div><div class="info-value">${fmt(gaikuang)}</div></div>
                  <div class="info-group"><div class="info-label">▸ Cấu thành binh lực</div>${bingliHtml}</div>
                  <div class="info-group"><div class="info-label">▸ Sự kiện tiêu điểm</div><div class="info-value">${fmt(jiaodian)}</div></div>
                </div>
              </div>
            </div>
          `;

          dashiDeleteHtml += `
            <div class="delete-item">
              <span class="delete-item-name">${fmt(name)}</span>
              <button class="delete-item-btn" onclick="generateDashiDeletePatch('${name}');autoFillToChat('dashi-delete-output')">Xóa</button>
            </div>
          `;
        });
      }
const dashiListEl = document.getElementById('dashi-list');
if (dashiListEl) dashiListEl.innerHTML = dashiHtml;

const dashiDeleteListEl = document.getElementById('dashi-delete-list');
if (dashiDeleteListEl) {
  dashiDeleteListEl.innerHTML =
    dashiDeleteHtml || '<div style="color: var(--text-muted);">Tạm không có thế lực để xóa</div>';
}

const renmai = _.get(all_variables, 'stat_data.Nhân_Mạch', {});
window.__renmaiCache = renmai; // Cho cửa sổ chi tiết nhân vật dùng

const pinSet = getRenmaiPinSet();

let renmaiHtml = '';
let renmaiDeleteHtml = '';

if (Object.keys(renmai).length === 0) {
  renmaiHtml = '<div class="empty-state"><div class="empty-state-icon">👤</div>Chưa kết giao hào kiệt thiên hạ</div>';
} else {
  const entries = Object.entries(renmai).sort((a, b) => {
    const ap = pinSet.has(a[0]);
    const bp = pinSet.has(b[0]);
    if (ap !== bp) return ap ? -1 : 1;
    return a[0].localeCompare(b[0], 'zh-Hans-CN');
  });

  entries.forEach(([name, data]) => {
    const baseInfo = _.get(data, 'Thông_Tin_Cơ_Bản', {});
    const gender = _.get(baseInfo, 'Giới_Tính', 'Chưa rõ');
    const age = _.get(baseInfo, 'Tuổi', 'Chưa rõ');
    const personality = _.get(baseInfo, 'Tính_Cách', 'Chưa rõ');
    const identity = _.get(baseInfo, 'Thân_Phận', 'Chưa rõ');
    const rating = _.get(baseInfo, 'Hệ_Thống_Đánh_Giá', 'N/A');
    const favor = _.get(baseInfo, 'Độ_Hảo_Cảm', 0);
    const depend = _.get(baseInfo, 'Độ_Lệ_Thuộc', 0);
    const lust = _.get(baseInfo, 'Độ_Ham_Muốn', 0);

    const isFemale = gender === 'Nữ';
    const favorClass = favor >= 0 ? 'positive' : 'negative';
    const dependClass = depend >= 0 ? 'positive' : 'negative';

    let badgeClass = '';
    if (String(rating).includes('S')) badgeClass = 'red';
    else if (String(rating).includes('A')) badgeClass = 'green';

    const safeName = encodeURIComponent(name);
    const pinned = pinSet.has(name);

    renmaiHtml += `
      <div class="list-item renmai-row ${pinned ? 'pinned' : ''}" onclick="openRenmaiProfile('${safeName}')">
        <div class="renmai-row-inner">
          <div class="renmai-row-left">
            <div class="renmai-row-name">${pinned ? '★ ' : ''}${fmt(name)}</div>
            <div class="renmai-row-sub">${fmt(gender)}/${age} · ${fmt(personality)}</div>
          </div>
          <div class="renmai-row-right">
            <button type="button"
              class="renmai-pin-btn ${pinned ? 'pinned' : ''}"
              onclick="toggleRenmaiPinned('${safeName}', event)"
              title="${pinned ? 'Bỏ ghim' : 'Ghim'}"
            >${pinned ? '★' : '☆'}</button>

            <span class="list-badge ${badgeClass}">${fmt(identity)}</span>
            <span class="renmai-mini ${favorClass}">Hảo cảm ${favor}</span>
            <span class="renmai-mini ${dependClass}">Lệ thuộc ${depend}</span>
            ${isFemale ? `<span class="renmai-mini lust">Dục ${lust}</span>` : ``}
          </div>
        </div>
      </div>
    `;

    renmaiDeleteHtml += `
      <div class="delete-item">
        <span class="delete-item-name">${fmt(name)}（${fmt(gender)}）</span>
        <button class="delete-item-btn" onclick="generateRenmaiDeletePatch('${name}');autoFillToChat('renmai-delete-output')">Xóa</button>
      </div>
    `;
  });
}
const renmaiListEl = document.getElementById('renmai-list');
if (renmaiListEl) renmaiListEl.innerHTML = renmaiHtml;

const renmaiDeleteListEl = document.getElementById('renmai-delete-list');
if (renmaiDeleteListEl) {
  renmaiDeleteListEl.innerHTML =
    renmaiDeleteHtml || '<div style="color: var(--text-muted);">Tạm không có nhân vật để xóa</div>';
}

      const zichan = _.get(all_variables, 'stat_data.Tài_Sản', {});
      window.__zichanCache = zichan;
      document.getElementById('asset-silver').textContent = _.get(zichan, 'Ngân_Lượng', 0);
      document.getElementById('asset-copper').textContent = _.get(zichan, 'Quan_Tiền', 0);

      const mingmian = _.get(zichan, 'Tài_Sản_Công_Khai', {});
      let mingmianHtml = '';
      Object.entries(mingmian).forEach(([itemName, itemData]) => {
        const count = _.get(itemData, 'Số_Lượng', 0);
        const desc = _.get(itemData, 'Mô_Tả', 'Không');
        mingmianHtml += `
          <div class="list-item">
            <div class="list-header" onclick="toggleExpand(this)">
              <div class="list-name">${fmt(itemName)}</div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span class="list-badge">${count}</span>
                <span class="expand-icon">▼</span>
              </div>
            </div>
            <div class="list-content"><div class="content-inner"><div class="info-value">${fmt(desc)}</div></div></div>
          </div>
        `;
      });
      document.getElementById('mingmian-list').innerHTML = mingmianHtml || '<div class="empty-state">Tạm không có tài sản công khai</div>';

      const xitong = _.get(zichan, 'Không_Gian_Hệ_Thống', {});
      let xitongHtml = '';
      ['Gạo_Thượng_Hạng', 'Thịt_Tươi', 'Muối_Tinh_Thượng_Hạng', 'Dầu_Ăn_Nguyên_Chất', 'Vải_Thô_Bền', 'Lụa_Thượng_Hạng', 'Thức_Ăn_Chăn_Nuôi_Thượng_Hạng', 'Than_Củi_Không_Khói'].forEach(item => {
        const count = _.get(xitong, item, 0);
        xitongHtml += `<div class="storage-item"><span class="storage-name">${fmt(item)}</span><span class="storage-count ${count === 0 ? 'zero' : ''}">${count}</span></div>`;
      });
      document.getElementById('xitong-storage').innerHTML = xitongHtml;

      const books = _.get(xitong, 'Sách_Đã_Nhận', {});
      let booksHtml = Object.keys(books).length > 0 ? Object.keys(books).map(b => `<span class="tag">${fmt(b)}</span>`).join('') : '<span class="tag tag-empty">Tạm không có sách</span>';
      document.getElementById('books-list').innerHTML = booksHtml;
      populateDiscardOptions();

      const budongchan = _.get(zichan, 'Điền_Sản', {});
      let budongchanHtml = '';
      Object.entries(budongchan).forEach(([propName, propData]) => {
        budongchanHtml += `
          <div class="list-item">
            <div class="list-header" onclick="toggleExpand(this)">
              <div class="list-name">${fmt(propName)}</div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span class="list-badge green">${_.get(propData, 'Loại', 'Chưa rõ')}</span>
                <span class="expand-icon">▼</span>
              </div>
            </div>
            <div class="list-content">
              <div class="content-inner">
                <div class="info-group"><div class="info-label">▸ Vị trí</div><div class="info-value">${fmt(_.get(propData, 'Vị_Trí', 'Chưa rõ'))}</div></div>
                <div class="info-group"><div class="info-label">▸ Mô tả</div><div class="info-value">${fmt(_.get(propData, 'Mô_Tả', 'Không'))}</div></div>
              </div>
            </div>
          </div>
        `;
      });
      document.getElementById('budongchan-list').innerHTML = budongchanHtml || '<div class="empty-state">Tạm không có điền sản</div>';

// Trang Tài sản "Quân đội dưới trướng" sửa thành hiển thị: Chinh Phục -> Biên chế quân đội
const zhengfuForAsset = _.get(all_variables, 'stat_data.Chinh_Phục', {});
const bianzhiMap = _.get(zhengfuForAsset, 'Biên_Chế_Quân_Đội', {});
let junduiHtml = '';

if (Object.keys(bianzhiMap || {}).length === 0){
  junduiHtml = '<div class="empty-state"><div class="empty-state-icon">⚔</div>Chưa có quân đoàn dưới trướng</div>';
} else {
  Object.entries(bianzhiMap).forEach(([juntuan, data]) => {
    const shiqi = _.get(data, 'Sĩ_Khí', 50);
    const zhudi = _.get(data, 'Doanh_Trại', 'Chưa rõ');
    const tongshuai = _.get(data, 'Thống_Soái', 'Không');
    const fujiang = _.get(data, 'Phó_Tướng', 'Không');

    // Quân số thực tế: Ưu tiên dùng _Quân_Số_Thực_Tế của transform schema, nếu không thì tính tổng tại chỗ
    let actual = Number(_.get(data, '_Quân_Số_Thực_Tế', NaN));
    if (!Number.isFinite(actual)){
      actual = 0;
      const bz = _.get(data, 'Biên_Chế', {});
      Object.values(bz || {}).forEach(info => actual += (Number(_.get(info, 'Số_Lượng', 0)) || 0));
    }

    junduiHtml += `
      <div class="troop-card">
        <div class="troop-name">${fmt(juntuan)}</div>
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">
          Thống soái：${fmt(tongshuai)}${fujiang && fujiang !== 'Không' ? ` · Phó tướng：${fmt(fujiang)}` : ''} · Doanh trại：${fmt(zhudi)}
        </div>
        <div class="troop-stats">
          <div class="troop-stat"><div class="troop-stat-label">Binh lực</div><div class="troop-stat-value">${actual.toLocaleString()}</div></div>
          <div class="troop-stat"><div class="troop-stat-label">Sĩ khí</div><div class="troop-stat-value">${shiqi} (${fmt(getShiqiDesc(shiqi))})</div></div>
          <div class="troop-stat"><div class="troop-stat-label">Trạng thái</div><div class="troop-stat-value">${fmt(_.get(data, 'Trạng_Thái_Hiện_Tại', 'Chưa rõ'))}</div></div>
        </div>
      </div>
    `;
  });
}

document.getElementById('jundui-list').innerHTML = junduiHtml;

const jiyao = _.get(all_variables, 'stat_data.Kỷ_Yếu', {});
const guixinForJiyao = _.get(all_variables, 'stat_data.Quy_Tâm', {});
const zhiliMap = _.get(guixinForJiyao, 'Cai_Trị', {});
const _jy_qs = _.get(all_variables, 'stat_data.Quyền_Thuật', {});
const zhengfuForJiyao = _.get(all_variables, 'stat_data.Chinh_Phục', {});

// Cơ sở kỷ yếu (giữ lại schema mới)
document.getElementById('jiyao-identity').textContent = fmt(_.get(jiyao, 'Thân_Phận', 'Chưa rõ'));
document.getElementById('jiyao-fame').textContent = fmt(_.get(jiyao, 'Danh_Vọng', 'Vô danh tiểu tốt'));
document.getElementById('jiyao-location').textContent = fmt(_.get(jiyao, 'Vị_Trí_Hiện_Tại', 'Chưa rõ'));

const jiyaoHealth = fmt(_.get(jiyao, 'Trạng_Thái_Sức_Khỏe', 'Bình thường'));
const jiyaoHealthEl = document.getElementById('jiyao-health');
jiyaoHealthEl.textContent = jiyaoHealth;
jiyaoHealthEl.style.color = (jiyaoHealth === 'Bình thường' || jiyaoHealth === 'Khỏe mạnh') ? 'var(--jade-green)' : '#ffb2b2';

document.getElementById('jiyao-faction').textContent = fmt(_.get(jiyao, 'Thế_Lực_Trực_Thuộc', 'Độc lập'));

// Phương án B: Chức vụ quan phương ← Quyền Thuật.Quan Chức
const _jy_office = _.get(_jy_qs, 'Quan_Chức.Quan_Chức_Hiện_Tại', 'Không');
const _jy_pinji  = _.get(_jy_qs, 'Quan_Chức.Phẩm_Cấp', 'Không');
document.getElementById('jiyao-office').textContent =
  (_jy_office && _jy_office !== 'Không')
    ? `${fmt(_jy_office)}${(_jy_pinji && _jy_pinji !== 'Không') ? `（${fmt(_jy_pinji)}）` : ''}`
    : 'Không';

// Phương án B: Số quân sở hữu ← Tổng hợp chinh phục
const overview = _.get(zhengfuForJiyao, '_Tổng_Quan_Quân_Đội', null);
let troopTotal = 0;
if (overview){
  troopTotal =
    (Number(_.get(overview, 'Tổng_Số_Bộ_Binh', 0)) || 0) +
    (Number(_.get(overview, 'Tổng_Số_Kỵ_Binh', 0)) || 0) +
    (Number(_.get(overview, 'Tổng_Số_Cung_Binh', 0)) || 0) +
    (Number(_.get(overview, 'Tổng_Số_Giáo_Binh', 0)) || 0);
} else {
  const bianzhi = _.get(zhengfuForJiyao, 'Biên_Chế_Quân_Đội', {});
  Object.values(bianzhi || {}).forEach(group => {
    const bz = _.get(group, 'Biên_Chế', {});
    Object.values(bz || {}).forEach(info => {
      troopTotal += (Number(_.get(info, 'Số_Lượng', 0)) || 0);
    });
  });
}
document.getElementById('jiyao-troops').textContent = troopTotal.toLocaleString();

// Phương án B: Tình hình cai trị ← Quy Tâm.Cai Trị
const zhiliNames = Object.keys(zhiliMap || {});
document.getElementById('jiyao-governance').textContent =
  zhiliNames.length === 0
    ? 'Tạm không có lãnh địa'
    : (zhiliNames.length <= 3 ? fmt(zhiliNames.join('、')) : `${zhiliNames.length} nơi：${fmt(zhiliNames.slice(0,3).join('、'))}…`);

// Phương án B: Lòng dân ← Trung bình cộng Lòng Dân Cai Trị các lãnh địa
const minxinVals = zhiliNames.map(n => Number(_.get(zhiliMap, [n, 'Chỉ_Số_Dân_Sinh', 'Lòng_Dân_Cai_Trị'], NaN)))
  .filter(v => Number.isFinite(v));

if (minxinVals.length > 0){
  const avg = Math.round(minxinVals.reduce((a,b)=>a+b,0) / minxinVals.length);
  document.getElementById('jiyao-hearts').textContent = `${avg} (${fmt(getMinxinDesc(avg))})`;
} else {
  document.getElementById('jiyao-hearts').textContent = `-- (Tạm không có lãnh địa)`;
}

// Danh hiệu (Vẫn lấy từ Kỷ Yếu.Danh Hiệu)
const titles = _.get(jiyao, 'Danh_Hiệu', {});
document.getElementById('jiyao-titles').innerHTML =
  Object.keys(titles).length > 0
    ? Object.entries(titles).map(([t, d]) => `<span class="tag" title="${fmt(d)}">${fmt(t)}</span>`).join('')
    : '<span class="tag tag-empty">Chưa có danh hiệu</span>';


const guixin = _.get(all_variables, 'stat_data.Quy_Tâm', {});
const population = Number(_.get(guixin, 'Số_Đầu_Người_Hiện_Tại', 1)) || 0;
document.getElementById('guixin-count').textContent = population;

// Chi tiết cấu thành dân số (Có bảo vệ giá trị rỗng)
const renkouGoucheng = _.get(guixin, 'Cấu_Thành_Dân_Số', {});
const guixinZhujue = document.getElementById('guixin-zhujue');
const guixinJiajuan = document.getElementById('guixin-jiajuan');
const guixinPucong = document.getElementById('guixin-pucong');
const guixinHuwei = document.getElementById('guixin-huwei');
const guixinLingmin = document.getElementById('guixin-lingmin');

if (guixinZhujue) guixinZhujue.textContent = _.get(renkouGoucheng, 'Nhân_Vật_Chính', 1);
if (guixinJiajuan) guixinJiajuan.textContent = _.get(renkouGoucheng, 'Gia_Quyến', 0);
if (guixinPucong) guixinPucong.textContent = _.get(renkouGoucheng, 'Kẻ_Hầu', 0);
if (guixinHuwei) guixinHuwei.textContent = _.get(renkouGoucheng, 'Hộ_Vệ', 0);
if (guixinLingmin) guixinLingmin.textContent = _.get(renkouGoucheng, 'Lãnh_Dân', 0);

const n = population;

// Gạo Thượng Hạng: n>=1 ? n*2 : 0
document.getElementById('reward-rice').textContent =
  (n >= 1 ? (n * 2) : 0) + ' Cân';

// Thịt Tươi: n>=2 ? round(n/2) : 0
document.getElementById('reward-meat').textContent =
  (n >= 2 ? Math.round(n / 2) : 0) + ' Cân';

// Muối Tinh Thượng Hạng: n>=5 ? round(n/5) : 0
document.getElementById('reward-salt').textContent =
  (n >= 5 ? Math.round(n / 5) : 0) + ' Lạng';

// Dầu Ăn Nguyên Chất: n>=10 ? round(n/10) : 0
document.getElementById('reward-oil').textContent =
  (n >= 10 ? Math.round(n / 10) : 0) + ' Lạng';

// Vải Thô Bền: n>=50 ? round(n/50)*10 : 0
document.getElementById('reward-cloth').textContent =
  (n >= 50 ? (Math.round(n / 50) * 10) : 0) + ' Thước';

// Lụa Thượng Hạng: n>=100 ? round(n/100)*5 : 0
document.getElementById('reward-silk').textContent =
  (n >= 100 ? (Math.round(n / 100) * 5) : 0) + ' Thước';

// Thức Ăn Chăn Nuôi Thượng Hạng: n>=200 ? round(n/200) : 0
document.getElementById('reward-fodder').textContent =
  (n >= 200 ? Math.round(n / 200) : 0) + ' Phần';

// Than Củi Không Khói: n>=500 ? round(n/500)*50 : 0
document.getElementById('reward-charcoal').textContent =
  (n >= 500 ? (Math.round(n / 500) * 50) : 0) + ' Cân';

      const milestones = [
        { threshold: 50, reward: 'Hạt giống khoai lang năng suất cao × 100 cân', type: 'Giống loài nông nghiệp', effect: 'Chịu hạn chịu đất nghèo, sản lượng cực cao, thần khí giải quyết nạn đói', unlocked: population >= 50 },
        { threshold: 100, reward: '《Tề Dân Yếu Thuật · Bản Tăng Bổ》', type: 'Sách kỹ thuật', effect: 'Bao gồm kỹ thuật nông canh, ghép cây, chọn giống và thủy lợi tưới tiêu tiên tiến nhất thời cổ đại', unlocked: population >= 100 },
        { threshold: 300, reward: '《Thiên Công Khai Vật · Thiên Khám Quặng》', type: 'Sách kỹ thuật', effect: 'Ghi chép chi tiết kỹ thuật khám dư tìm kiếm mỏ quặng thông qua thảm thực vật địa biểu, thủy văn, thổ nhưỡng', unlocked: population >= 300 },
        { threshold: 1000, reward: '《Đại Toàn Công Nghệ Luyện Kim Truyền Thống》', type: 'Sách kỹ thuật', effect: 'Ghi chép phương pháp tưới thép, xào thép, thép trăm luyện... kỹ thuật luyện sắt đỉnh cao thời cổ đại', unlocked: population >= 1000 },
        { threshold: 3000, reward: '《Võ Bị Chí · Thiên Giáp Trụ Binh Khí》', type: 'Sách kỹ thuật', effect: 'Bao gồm bản đồ rèn đúc trang bị đỉnh cao binh khí lạnh như Bộ Nhân Giáp, Minh Quang Khải, Thần Tý Nỗ', unlocked: population >= 3000 },
        { threshold: 5000, reward: '《Doanh Tạo Pháp Thức · Thiên Thành Phòng》', type: 'Sách kỹ thuật', effect: 'Kỹ thuật xây dựng tiêu chuẩn hóa tường thành, ung thành, tháp canh thời cổ đại', unlocked: population >= 5000 },
        { threshold: 10000, reward: '《Bản Thảo Cương Mục · Thiên Phòng Dịch Vệ Sinh》', type: 'Sách kỹ thuật', effect: 'Hệ thống phòng dịch Trung y cổ đại, bao gồm phương pháp cách ly, thuật cấy đậu mùa...', unlocked: population >= 10000 }
      ];

      let milestoneHtml = milestones.map(m => `
        <div class="milestone-item ${m.unlocked ? 'unlocked' : 'locked'}">
          <div class="milestone-threshold">${m.threshold} người</div>
          <div class="milestone-reward">
            <div style="color: var(--gold-primary); margin-bottom: 3px;">${m.reward}</div>
            <div style="font-size: 10px; color: var(--text-muted);">${m.effect}</div>
          </div>
          <div class="milestone-status ${m.unlocked ? 'unlocked' : 'locked'}">${m.unlocked ? 'Đã mở khóa' : 'Chưa mở khóa'}</div>
        </div>
      `).join('');

// ===== [Thêm mới] Trang Quy Tâm · Cai Trị =====
(function(){
const el = document.getElementById('guixin-zhili-list');
if (!el) return;

  const zhili = _.get(guixin, 'Cai_Trị', {});
  const names = Object.keys(zhili || {});

  if (names.length === 0){
    el.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🏯</div>Tạm không có lãnh địa cai trị</div>';
    return;
  }

  const html = names.sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')).map(name => {
    const data = zhili[name] || {};
    const pos = _.get(data, 'Vị_Trí', 'Chưa rõ');
    const scale = _.get(data, 'Quy_Mô', 'Chưa rõ');
    const gaikuang = _.get(data, 'Khái_Quát', 'Tạm không');

    const pop = _.get(data, 'Phân_Chia_Dân_Số', {});
    const infra = _.get(data, 'Cơ_Sở_Hạ_Tầng', {});
    const ms = _.get(data, 'Chỉ_Số_Dân_Sinh', {});
    const out = _.get(data, 'Sản_Lượng_Địa_Phương', {});

    const minxin = _.get(ms, 'Lòng_Dân_Cai_Trị', 50);
    const wenbao = _.get(ms, 'Độ_No_Đủ', 'Chưa rõ');
    const zhiAn = _.get(ms, 'Trị_An', 'Chưa rõ');
    const weisheng = _.get(ms, 'Vệ_Sinh', 'Chưa rõ');

    const infraTags = Object.keys(infra || {}).length
      ? Object.entries(infra).map(([k,v]) => `<span class="tag" title="${fmt(v)}">${fmt(k)}</span>`).join('')
      : '<span class="tag tag-empty">Tạm không có cơ sở</span>';

    const outTags = Object.keys(out || {}).length
      ? Object.entries(out).map(([k,v]) => `<span class="tag">${fmt(k)} ×${Number(v)||0}</span>`).join('')
      : '<span class="tag tag-empty">Tạm không có sản lượng</span>';

    return `
      <div class="list-item">
        <div class="list-header" onclick="toggleExpand(this)">
          <div class="list-name">${fmt(name)}</div>
          <div style="display:flex; align-items:center; gap:10px;">
            <span class="list-badge green">${fmt(scale)}</span>
            <span class="list-badge">${minxin} Lòng dân</span>
            <span class="expand-icon">▼</span>
          </div>
        </div>
        <div class="list-content">
          <div class="content-inner">
            <div class="person-basic-info" style="grid-template-columns: repeat(2, 1fr); margin-bottom: 14px;">
              <div class="person-stat"><div class="person-stat-label">Vị trí</div><div class="person-stat-value">${fmt(pos)}</div></div>
              <div class="person-stat"><div class="person-stat-label">Lòng dân cai trị</div><div class="person-stat-value">${minxin} (${fmt(getMinxinDesc(minxin))})</div></div>
              <div class="person-stat"><div class="person-stat-label">Độ no đủ</div><div class="person-stat-value">${fmt(wenbao)}</div></div>
              <div class="person-stat"><div class="person-stat-label">Trị an/Vệ sinh</div><div class="person-stat-value">${fmt(zhiAn)} / ${fmt(weisheng)}</div></div>
            </div>

            <div class="info-group"><div class="info-label">▸ Khái quát</div><div class="info-value">${fmt(gaikuang)}</div></div>

            <div class="info-group">
              <div class="info-label">▸ Phân chia dân số</div>
              <div class="info-value" style="line-height:1.9;">
                Nông hộ：${_.get(pop,'Nông_Hộ',0)}；
                Thợ thủ công：${_.get(pop,'Thợ_Thủ_Công',0)}；
                Thương nhân：${_.get(pop,'Thương_Nhân',0)}；
                Trai tráng：${_.get(pop,'Trai_Tráng',0)}；
                Già trẻ phụ nữ：${_.get(pop,'Già_Trẻ_Phụ_Nữ',0)}
              </div>
            </div>

            <div class="info-group"><div class="info-label">▸ Cơ sở hạ tầng</div><div class="tags-container" style="margin-top:6px;">${infraTags}</div></div>
            <div class="info-group"><div class="info-label">▸ Sản lượng địa phương</div><div class="tags-container" style="margin-top:6px;">${outTags}</div></div>
          </div>
        </div>
      </div>
    `;
  }).join('');

  el.innerHTML = html;
})();

// ===== Hệ thống Chinh phục (Thích ứng cấu trúc mới) =====
const zhengfu = _.get(all_variables, 'stat_data.Chinh_Phục', {});

// ---------- Công cụ: Số/Màu an toàn ----------
const asNum = (v, d=0) => {
  const n = Number(v);
  return Number.isFinite(n) ? n : d;
};
const clamp01 = (n) => Math.max(0, Math.min(100, n));

// ========== 1) Biên chế quân đội ==========
const junduiBianzhi = _.get(zhengfu, 'Biên_Chế_Quân_Đội', {});
let junduiBianzhiHtml = '';

if (Object.keys(junduiBianzhi).length === 0) {
  junduiBianzhiHtml = '<div style="color: var(--text-muted);">Tạm không có biên chế quân đội</div>';
} else {
  Object.entries(junduiBianzhi).forEach(([juntuan, data]) => {
    const shiqi = asNum(_.get(data, 'Sĩ_Khí', 50), 50);
    const zhudi = _.get(data, 'Doanh_Trại', 'Chưa rõ');
    const zhuangtai = _.get(data, 'Trạng_Thái_Hiện_Tại', 'Chưa rõ');

    const tongshuai = _.get(data, 'Thống_Soái', 'Không');
    const fujiang = _.get(data, 'Phó_Tướng', 'Không');
    const texing = _.get(data, 'Đặc_Tính_Quân_Đoàn', 'Chờ khởi tạo');

    const manbian = asNum(_.get(data, 'Quân_Số_Đầy_Đủ', 0), 0);

    // Quân số thực tế: Ưu tiên _Quân_Số_Thực_Tế, nếu không thì tính tổng tại chỗ
    let shiji = asNum(_.get(data, '_Quân_Số_Thực_Tế', NaN), NaN);
    if (!Number.isFinite(shiji)) {
      shiji = 0;
      const bz0 = _.get(data, 'Biên_Chế', {});
      Object.values(bz0 || {}).forEach(info => { shiji += asNum(_.get(info, 'Số_Lượng', 0), 0); });
    }

    // Biên chế: Hiển thị theo thẻ binh chủng
    const bianzhi = _.get(data, 'Biên_Chế', {});
    let bingzhongHtml = '';
    Object.entries(bianzhi).forEach(([bingzhong, info]) => {
      bingzhongHtml += `
        <div class="troop-card">
          <div class="troop-name">${fmt(bingzhong)}</div>
          <div class="troop-stats">
            <div class="troop-stat"><div class="troop-stat-label">Số lượng</div><div class="troop-stat-value">${asNum(_.get(info,'Số_Lượng',0),0).toLocaleString()}</div></div>
            <div class="troop-stat"><div class="troop-stat-label">Độ huấn luyện</div><div class="troop-stat-value">${fmt(_.get(info,'Độ_Huấn_Luyện','Chưa rõ'))}</div></div>
            <div class="troop-stat"><div class="troop-stat-label">Trang bị</div><div class="troop-stat-value">${fmt(_.get(info,'Cấp_Độ_Trang_Bị','Chưa rõ'))}</div></div>
          </div>
        </div>
      `;
    });
    if (!bingzhongHtml) bingzhongHtml = '<div style="color: var(--text-muted); padding: 8px 4px;">Tạm không có binh chủng</div>';

    // Hậu cần
    const liangcaoDays = asNum(_.get(data, 'Hậu_Cần.Số_Ngày_Dự_Trữ_Lương_Thảo', 0), 0);
    const zhuangbeiOk = _.get(data, 'Hậu_Cần.Tỷ_Lệ_Hoàn_Hảo_Trang_Bị', 'Chờ khởi tạo');

    // Ghi chép tham chiến (danh sách tag)
    const canzhan = _.get(data, 'Ghi_Chép_Tham_Chiến', {});
    const canzhanTags = Object.keys(canzhan || {}).length
      ? Object.entries(canzhan).map(([k,v]) => `<span class="tag" title="${fmt(v)}">${fmt(k)}</span>`).join('')
      : '<span class="tag tag-empty">Tạm không có</span>';

    // Màu trạng thái lương bổng (tiếp tục logic cũ)
    const liangxiangZhuangtai = _.get(data, 'Trạng_Thái_Lương_Bổng', 'Đủ ngạch');
    let liangxiangColor = 'var(--jade-green)';
    if (String(liangxiangZhuangtai).includes('Nợ')) {
      if (String(liangxiangZhuangtai).includes('3') || String(liangxiangZhuangtai).includes('+')) liangxiangColor = '#ffb2b2';
      else liangxiangColor = 'var(--gold-primary)';
    }

    // Tỷ lệ quân số đầy đủ
    const fillRate = manbian > 0 ? Math.round((shiji / manbian) * 100) : null;

    junduiBianzhiHtml += `
      <div style="margin-bottom: 16px; padding: 14px; background: rgba(0,0,0,0.15); border-radius: 10px; border-left: 2px solid var(--sunset-orange);">
        <div style="font-size: 15px; color: var(--gold-primary); font-weight: 700; margin-bottom: 10px;">${fmt(juntuan)}</div>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; font-size: 11px;">
          <div><span style="color: var(--text-muted);">Thống soái：</span><span style="color: var(--text-primary);">${fmt(tongshuai)}</span></div>
          <div><span style="color: var(--text-muted);">Phó tướng：</span><span style="color: var(--text-primary);">${fmt(fujiang)}</span></div>
          <div><span style="color: var(--text-muted);">Sĩ khí：</span><span style="color: var(--jade-green);">${shiqi} (${fmt(getShiqiDesc(shiqi))})</span></div>

          <div><span style="color: var(--text-muted);">Lương bổng：</span><span style="color:${liangxiangColor};">${fmt(liangxiangZhuangtai)}</span></div>
          <div><span style="color: var(--text-muted);">Doanh trại：</span><span style="color: var(--text-primary);">${fmt(zhudi)}</span></div>
          <div><span style="color: var(--text-muted);">Trạng thái：</span><span style="color: var(--text-primary);">${fmt(zhuangtai)}</span></div>

          <div><span style="color: var(--text-muted);">Thực biên：</span><span style="color: var(--text-primary);">${shiji.toLocaleString()} người</span></div>
          <div><span style="color: var(--text-muted);">Đầy đủ：</span><span style="color: var(--text-primary);">${manbian ? manbian.toLocaleString()+' người' : 'Chưa rõ'}</span></div>
          <div><span style="color: var(--text-muted);">Tỷ lệ đầy đủ：</span><span style="color: var(--text-primary);">${fillRate === null ? '—' : (fillRate + '%')}</span></div>

          <div><span style="color: var(--text-muted);">Lương thảo：</span><span style="color: var(--text-primary);">${liangcaoDays} ngày</span></div>
          <div><span style="color: var(--text-muted);">Hoàn hảo：</span><span style="color: var(--text-primary);">${zhuangbeiOk}</span></div>
          <div><span style="color: var(--text-muted);">Đặc tính：</span><span style="color: var(--text-primary);">${texing}</span></div>
        </div>

        <div style="margin-bottom: 10px;">
          <div class="info-label">Ghi chép tham chiến</div>
          <div class="tags-container" style="margin-top:6px;">${canzhanTags}</div>
        </div>

        ${bingzhongHtml}
      </div>
    `;
  });
}
document.getElementById('zhengfu-jundui').innerHTML = junduiBianzhiHtml;


// ========== 2) Trại lính lẻ (Mô đun mới) ==========
const sanbingYing = _.get(zhengfu, 'Trại_Lính_Lẻ', {});
let sanbingHtml = '';
if (Object.keys(sanbingYing).length === 0) {
  sanbingHtml = '<div style="color: var(--text-muted);">Tạm không có lính lẻ</div>';
} else {
  Object.entries(sanbingYing).forEach(([batch, data]) => {
    sanbingHtml += `
      <div class="troop-card">
        <div class="troop-name">${fmt(batch)}</div>
        <div class="troop-stats">
          <div class="troop-stat"><div class="troop-stat-label">Số lượng</div><div class="troop-stat-value">${asNum(_.get(data,'Số_Lượng',0),0).toLocaleString()}</div></div>
          <div class="troop-stat"><div class="troop-stat-label">Độ huấn luyện</div><div class="troop-stat-value">${fmt(_.get(data,'Độ_Huấn_Luyện','Chưa rõ'))}</div></div>
          <div class="troop-stat"><div class="troop-stat-label">Nguồn gốc</div><div class="troop-stat-value">${fmt(_.get(data,'Nguồn_Gốc','Chưa rõ'))}</div></div>
        </div>
      </div>
    `;
  });
}
document.getElementById('zhengfu-sanbing').innerHTML = sanbingHtml;


// ========== 3) Danh sách tướng lĩnh (Thích ứng cấu trúc thay đổi lớn) ==========
const jianglingCe = _.get(zhengfu, 'Danh_Sách_Tướng_Lĩnh', {});
let jianglingHtml = '';

if (Object.keys(jianglingCe).length === 0) {
  jianglingHtml = '<div style="color: var(--text-muted);">Tạm không có tướng lĩnh</div>';
} else {
  Object.entries(jianglingCe).forEach(([name, data]) => {
    const age = _.get(data, 'Tuổi', 'Chưa rõ');
    const origin = _.get(data, 'Lai_Lịch', 'Chờ khởi tạo');

    const lvlCmd = _.get(data, 'Cấp_Độ_Thống_Ngự', 'D');
    const lvlWar = _.get(data, 'Cấp_Độ_Võ_Nghệ', 'D');

    const exp = asNum(_.get(data, 'Kinh_Nghiệm_Hiện_Tại', 0), 0);
    const needCmd = _.get(data, '_Cần_Thăng_Cấp_Thống_Ngự', 100);
    const needWar = _.get(data, '_Cần_Thăng_Cấp_Võ_Nghệ', 100);

    const loyal = asNum(_.get(data, 'Độ_Trung_Thành', 50), 50);
    const task = _.get(data, 'Nhiệm_Vụ_Hiện_Tại', 'Nhàn rỗi');
    const health = _.get(data, 'Trạng_Thái_Sức_Khỏe', 'Khỏe mạnh');

    const injuredAt = asNum(_.get(data, 'Thời_Gian_Bị_Thương', 0), 0);
    const recoverDays = asNum(_.get(data, 'Số_Ngày_Cần_Hồi_Phục', 0), 0);

    const troop = _.get(data, 'Bộ_Đội_Thống_Lĩnh', 'Không');
    const comment = _.get(data, 'Nhận_Xét_Ngắn', 'Chờ khởi tạo');

    const specTroop = _.get(data, 'Binh_Chủng_Sở_Trường', 'Chờ khởi tạo');
    const specTactic = _.get(data, 'Chiến_Thuật_Sở_Trường', 'Chờ khởi tạo');

    const traits = _.get(data, 'Đặc_Tính', {});
    const traitTags = Object.keys(traits || {}).length
      ? Object.entries(traits).map(([k,v]) => `<span class="tag" title="${fmt(v)}">${fmt(k)}</span>`).join('')
      : '<span class="tag tag-empty">Tạm không có</span>';

    // Màu độ trung thành
    let loyalColor = 'var(--jade-green)';
    if (loyal < 40) loyalColor = '#ffb2b2';
    else if (loyal < 60) loyalColor = 'var(--gold-primary)';

    // Màu sức khỏe
    const healthColor = (health === 'Khỏe mạnh' || health === 'Bình thường') ? 'var(--jade-green)' : '#ffb2b2';

    // Thanh kinh nghiệm (chú ý Infinity)
    const pct = (need) => {
      const n = Number(need);
      if (!Number.isFinite(n) || n <= 0) return 100;
      return clamp01(Math.round((exp / n) * 100));
    };

    jianglingHtml += `
      <div class="troop-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div class="troop-name" style="margin-bottom:0;">${fmt(name)}</div>
          <div style="display:flex;gap:6px;align-items:center;">
            <span class="list-badge" style="border-color:var(--gold-primary);color:var(--gold-primary);">Thống ngự ${fmt(lvlCmd)}</span>
            <span class="list-badge" style="border-color:var(--jade-green);color:var(--jade-green);">Võ nghệ ${fmt(lvlWar)}</span>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:8px;font-size:11px;">
          <div><span style="color:var(--text-muted);">Tuổi：</span><span style="color:var(--text-primary);">${age}</span></div>
          <div><span style="color:var(--text-muted);">Trung thành：</span><span style="color:${loyalColor};">${loyal}</span></div>
          <div><span style="color:var(--text-muted);">Sức khỏe：</span><span style="color:${healthColor};">${health}</span></div>

          <div style="grid-column: span 2;"><span style="color:var(--text-muted);">Nhiệm vụ：</span><span style="color:var(--text-primary);">${task}</span></div>
          <div><span style="color:var(--text-muted);">Thống lĩnh：</span><span style="color:var(--text-primary);">${troop}</span></div>
        </div>

        ${injuredAt > 0 && recoverDays > 0 ? `
          <div style="font-size:10px;color:var(--gold-primary);margin-bottom:8px;">
            Đang bị thương：Bị thương vào ngày thứ ${injuredAt} · Dự kiến hồi phục ${recoverDays} ngày
          </div>
        ` : ''}

        <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">
          Lai lịch：${origin}
        </div>
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">
          Sở trường：${specTroop} · ${specTactic}
        </div>

        <div style="margin-bottom:8px;">
          <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px;">Kinh nghiệm：${exp} / Thống ngự cần ${needCmd} · Võ nghệ cần ${needWar}</div>
          <div style="background: rgba(0,0,0,0.3); border-radius: 4px; height: 8px; overflow: hidden;">
            <div style="width:${pct(needCmd)}%;height:100%;background:linear-gradient(90deg,var(--gold-primary),#ffd1a6);"></div>
          </div>
          <div style="background: rgba(0,0,0,0.3); border-radius: 4px; height: 8px; overflow: hidden; margin-top:6px;">
            <div style="width:${pct(needWar)}%;height:100%;background:linear-gradient(90deg,var(--jade-green),#a9e6d8);"></div>
          </div>
        </div>

        <div class="info-label">Đặc tính</div>
        <div class="tags-container" style="margin-top:6px;margin-bottom:10px;">${fmt(traitTags)}</div>

        ${comment && comment !== 'Chờ khởi tạo' ? `<div style="font-size:10px;color:var(--text-muted);font-style:italic;">"${comment}"</div>` : ''}
      </div>
    `;
  });
}
document.getElementById('zhengfu-jiangling').innerHTML = jianglingHtml;

// ========== 4) Kho quân bị (Cơ bản không đổi) ==========
const junbeiKu = _.get(zhengfu, 'Kho_Quân_Bị', {});
let junbeiHtml = `
  <div class="storage-list">
    <div class="storage-item"><span class="storage-name">Trang bị thô sơ</span><span class="storage-count">${asNum(_.get(junbeiKu, 'Số_Lượng_Trang_Bị_Thô_Sơ', 0),0)}</span></div>
    <div class="storage-item"><span class="storage-name">Trang bị tiêu chuẩn</span><span class="storage-count">${asNum(_.get(junbeiKu, 'Số_Lượng_Trang_Bị_Tiêu_Chuẩn', 0),0)}</span></div>
    <div class="storage-item"><span class="storage-name">Trang bị tinh nhuệ</span><span class="storage-count">${asNum(_.get(junbeiKu, 'Số_Lượng_Trang_Bị_Tinh_Nhuệ', 0),0)}</span></div>
    <div class="storage-item"><span class="storage-name">Chiến mã</span><span class="storage-count">${asNum(_.get(junbeiKu, 'Số_Lượng_Chiến_Mã', 0),0)} Con</span></div>
    <div class="storage-item"><span class="storage-name">Lương thảo quân dụng</span><span class="storage-count">${asNum(_.get(junbeiKu, 'Lương_Thảo_Quân_Dụng', 0),0).toLocaleString()} Cân</span></div>
    <div class="storage-item"><span class="storage-name">Dự trữ quân lương</span><span class="storage-count">${asNum(_.get(junbeiKu, 'Dự_Trữ_Quân_Lương', 0),0).toLocaleString()} Lượng</span></div>
  </div>
`;
const gongchengQixie = _.get(junbeiKu, 'Khí_Cụ_Công_Thành', {});
if (Object.keys(gongchengQixie).length > 0) {
  junbeiHtml += '<div style="margin-top: 12px;"><div class="info-label">Khí cụ công thành</div><div class="tags-container" style="margin-top: 6px;">';
  Object.entries(gongchengQixie).forEach(([qxName, count]) => {
    junbeiHtml += `<span class="tag">${qxName} ×${asNum(count,0)}</span>`;
  });
  junbeiHtml += '</div></div>';
}
document.getElementById('zhengfu-junbei').innerHTML = junbeiHtml;


// ========== 5) Sổ sách huấn luyện (Cơ bản không đổi) ==========
const xunlianTaizhang = _.get(zhengfu, 'Sổ_Sách_Huấn_Luyện', {});
let xunlianHtml = '';
if (Object.keys(xunlianTaizhang).length === 0) {
  xunlianHtml = '<div style="color: var(--text-muted);">Tạm không có bộ đội đang huấn luyện</div>';
} else {
  Object.entries(xunlianTaizhang).forEach(([budui, data]) => {
    const jieduan = _.get(data, 'Giai_Đoạn_Hiện_Tại', 'Chưa rõ');
    const yixunlian = asNum(_.get(data, 'Số_Ngày_Đã_Huấn_Luyện', 0), 0);
    const suoxu = asNum(_.get(data, 'Số_Ngày_Cần_Thiết', 30), 30);
    const duxun = _.get(data, 'Tướng_Lĩnh_Giám_Sát', 'Chờ khởi tạo');
    const wancheng = _.get(data, 'Ngày_Dự_Kiến_Hoàn_Thành', 'Chưa rõ');
    const jindu = clamp01(Math.round((yixunlian / Math.max(1,suoxu)) * 100));

    xunlianHtml += `
      <div class="troop-card">
        <div class="troop-name">${fmt(budui)}</div>
        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">
          ${jieduan} | Giám sát：${duxun} | Dự kiến hoàn thành：${wancheng}
        </div>
        <div style="background: rgba(0,0,0,0.3); border-radius: 4px; height: 8px; overflow: hidden;">
          <div style="width: ${jindu}%; height: 100%; background: linear-gradient(90deg, var(--jade-green), var(--gold-primary)); transition: width 0.3s;"></div>
        </div>
        <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px; text-align: right;">${yixunlian}/${suoxu} ngày (${jindu}%)</div>
      </div>
    `;
  });
}
document.getElementById('zhengfu-xunlian').innerHTML = xunlianHtml;


// ========== 6) Trại tù binh (Thích ứng cấu trúc thay đổi lớn: _Số_Ngay_Đã_Giam_Giữ / _Ý_Chí / Thời gian vào trại v.v...) ==========
const fuluYing = _.get(zhengfu, 'Trại_Tù_Binh', {});
let fuluHtml = '';
if (Object.keys(fuluYing).length === 0) {
  fuluHtml = '<div style="color: var(--text-muted);">Tạm không có tù binh</div>';
} else {
  const curDay = asNum(_.get(all_variables, 'stat_data.Thời_Gian.Số_Ngày_Đã_Trôi_Qua', 0), 0);

  Object.entries(fuluYing).forEach(([pici, data]) => {
    const cnt = asNum(_.get(data, 'Số_Lượng_Tù_Binh', 0), 0);
    const yuanBingzhong = _.get(data, 'Binh_Chủng_Gốc', 'Chờ khởi tạo');
    const yuanXunlian = _.get(data, 'Độ_Huấn_Luyện_Gốc', 'Chờ khởi tạo');
    const laiyuan = _.get(data, 'Thế_Lực_Nguồn', 'Chờ khởi tạo');
    const chuzhi = _.get(data, 'Ý_Định_Xử_Lý', 'Chờ khởi tạo');
    const bili = _.get(data, 'Tỷ_Lệ_Có_Thể_Thu_Nhận', 'Chờ khởi tạo');
    const dailyCost = asNum(_.get(data, 'Tiêu_Hao_Hàng_Ngày', 0), 0);

    // Ngày giam giữ: Ưu tiên lấy _Số_Ngay_Đã_Giam_Giữ từ transform, nếu không dùng Thời gian - Thời gian vào trại
    let days = asNum(_.get(data, '_Số_Ngay_Đã_Giam_Giữ', NaN), NaN);
    if (!Number.isFinite(days)) {
      const inDay = asNum(_.get(data, 'Thời_Gian_Vào_Trại', 0), 0);
      days = Math.max(curDay - inDay, 0);
    }

    const will = asNum(_.get(data, '_Ý_Chí', NaN), NaN);
    const willShow = Number.isFinite(will) ? will : '--';

    // Màu ý chí
    let willColor = 'var(--jade-green)';
    if (Number.isFinite(will)) {
      if (will < 30) willColor = '#ffb2b2';
      else if (will < 60) willColor = 'var(--gold-primary)';
    } else {
      willColor = 'var(--text-muted)';
    }

    const vip = _.get(data, 'Tù_Binh_Quan_Trọng', {});
    const vipTags = Object.keys(vip || {}).length
      ? Object.entries(vip).map(([k,v]) => `<span class="tag" title="${fmt(v)}">${fmt(k)}</span>`).join('')
      : '<span class="tag tag-empty">Không</span>';

    fuluHtml += `
      <div class="troop-card">
        <div class="troop-name">${pici}</div>

        <div class="troop-stats">
          <div class="troop-stat"><div class="troop-stat-label">Số lượng</div><div class="troop-stat-value">${cnt.toLocaleString()}</div></div>
          <div class="troop-stat"><div class="troop-stat-label">Binh chủng gốc</div><div class="troop-stat-value">${yuanBingzhong}</div></div>
          <div class="troop-stat"><div class="troop-stat-label">Độ huấn luyện gốc</div><div class="troop-stat-value">${yuanXunlian}</div></div>
        </div>

        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:10px;font-size:11px;">
          <div><span style="color:var(--text-muted);">Nguồn gốc：</span><span style="color:var(--text-primary);">${laiyuan}</span></div>
          <div><span style="color:var(--text-muted);">Giam giữ：</span><span style="color:var(--text-primary);">${days} ngày</span></div>
          <div><span style="color:var(--text-muted);">Ý chí：</span><span style="color:${willColor};">${willShow}</span></div>

          <div><span style="color:var(--text-muted);">Tiêu hao：</span><span style="color:var(--text-primary);">${dailyCost}</span></div>
          <div style="grid-column: span 2;"><span style="color:var(--text-muted);">Thu biên：</span><span style="color:var(--text-primary);">${bili}</span></div>
        </div>

        <div style="font-size:11px;color:var(--text-muted);margin-top:10px;">Ý định xử lý：${chuzhi}</div>

        <div style="margin-top:10px;">
          <div class="info-label">Tù binh quan trọng</div>
          <div class="tags-container" style="margin-top:6px;">${vipTags}</div>
        </div>
      </div>
    `;
  });
}
document.getElementById('zhengfu-fulu').innerHTML = fuluHtml;


// ========== 7) Nhật ký chiến dịch (Cấu trúc không đổi) ==========
const zhanyiZhi = _.get(zhengfu, 'Nhật_Ký_Chiến_Dịch', {});
let zhanyiHtml = '';
if (Object.keys(zhanyiZhi).length === 0) {
  zhanyiHtml = '<div style="color: var(--text-muted);">Tạm không có nhật ký chiến dịch</div>';
} else {
  Object.entries(zhanyiZhi).forEach(([zhanyiName, data]) => {
    const jieguo = _.get(data, 'Kết_Quả_Trận_Đấu', 'Chưa rõ');
    let jieguoColor = 'var(--text-muted)';
    // Logic so sánh với tiếng Việt
    if (['Toàn thắng', 'Tàn sát'].includes(jieguo)) jieguoColor = 'var(--jade-green)';
    else if (['Thắng lợi'].includes(jieguo)) jieguoColor = '#a9e6d8';
    else if (['Thắng thảm', 'Giằng co'].includes(jieguo)) jieguoColor = 'var(--gold-primary)';
    else if (['Thảm bại', 'Tan tác', 'Thua trận', 'Thua tiếc'].includes(jieguo)) jieguoColor = '#ffb2b2';

    zhanyiHtml += `
      <div class="troop-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div class="troop-name" style="margin-bottom:0;">${fmt(zhanyiName)}</div>
          <span class="list-badge" style="color:${jieguoColor};border-color:${jieguoColor};">${jieguo}</span>
        </div>
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">
          ${_.get(data,'Thời_Gian','Chưa rõ')} · ${_.get(data,'Địa_Điểm','Chưa rõ')}
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px;">
          <div><span style="color: var(--text-muted);">Binh lực phe ta：</span><span style="color: var(--jade-green);">${asNum(_.get(data,'Binh_Lực_Phe_Ta.Số_Lượng',0),0).toLocaleString()} (${_.get(data,'Binh_Lực_Phe_Ta.Mô_Tả','')})</span></div>
          <div><span style="color: var(--text-muted);">Binh lực phe địch：</span><span style="color: #ffb2b2;">${asNum(_.get(data,'Binh_Lực_Phe_Địch.Số_Lượng',0),0).toLocaleString()} (${_.get(data,'Binh_Lực_Phe_Địch.Mô_Tả','')})</span></div>
          <div><span style="color: var(--text-muted);">Tổn thất phe ta：</span><span style="color: var(--text-primary);">${asNum(_.get(data,'Tổn_Thất_Phe_Ta.Số_Lượng',0),0).toLocaleString()} (${_.get(data,'Tổn_Thất_Phe_Ta.Mô_Tả','')})</span></div>
          <div><span style="color: var(--text-muted);">Tổn thất phe địch：</span><span style="color: var(--text-primary);">${asNum(_.get(data,'Tổn_Thất_Phe_Địch.Số_Lượng',0),0).toLocaleString()} (${_.get(data,'Tổn_Thất_Phe_Địch.Mô_Tả','')})</span></div>
        </div>

        ${asNum(_.get(data,'Chiến_Lợi_Phẩm.Số_Lượng',0),0) > 0 ? `
          <div style="font-size: 11px; margin-top: 6px;">
            <span style="color: var(--text-muted);">Chiến lợi phẩm：</span>
            <span style="color: var(--gold-primary);">${_.get(data,'Chiến_Lợi_Phẩm.Mô_Tả','Không')} (${asNum(_.get(data,'Chiến_Lợi_Phẩm.Số_Lượng',0),0).toLocaleString()})</span>
          </div>` : ''}

        ${_.get(data,'Ảnh_Hưởng','Không') !== 'Không' ? `<div style="font-size:10px;color:var(--text-muted);margin-top:4px;font-style:italic;">${_.get(data,'Ảnh_Hưởng','')}</div>` : ''}
      </div>
    `;
  });
}
document.getElementById('zhengfu-zhanyi').innerHTML = zhanyiHtml;


// ========== 8) Tổng quan chinh phục + Huy hiệu thống kê mô-đun (Thích ứng cấu trúc mới + Trại lính lẻ mới) ==========
(function(){
  const $set = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.textContent = val;
  };

  const armies = Object.keys(junduiBianzhi || {}).length;

  // Tổng binh lực: Ưu tiên dùng _Quân_Số_Thực_Tế để tính tổng
  let soldiers = 0;
  Object.values(junduiBianzhi || {}).forEach(group => {
    let n = asNum(_.get(group, '_Quân_Số_Thực_Tế', NaN), NaN);
    if (!Number.isFinite(n)){
      n = 0;
      const bz = _.get(group, 'Biên_Chế', {});
      Object.values(bz || {}).forEach(info => n += asNum(_.get(info, 'Số_Lượng', 0), 0));
    }
    soldiers += n;
  });

  const generals = Object.keys(jianglingCe || {}).length;

  const equipTotal =
    asNum(_.get(junbeiKu, 'Số_Lượng_Trang_Bị_Thô_Sơ', 0), 0) +
    asNum(_.get(junbeiKu, 'Số_Lượng_Trang_Bị_Tiêu_Chuẩn', 0), 0) +
    asNum(_.get(junbeiKu, 'Số_Lượng_Trang_Bị_Tinh_Nhuệ', 0), 0);

  const trainingCount = Object.keys(xunlianTaizhang || {}).length;

  let prisoners = 0;
  Object.values(fuluYing || {}).forEach(batch => {
    prisoners += asNum(_.get(batch, 'Số_Lượng_Tù_Binh', 0), 0);
  });

  const campaigns = Object.keys(zhanyiZhi || {}).length;

  // Thống kê Trại lính lẻ
  let sanbingTotal = 0;
  Object.values(sanbingYing || {}).forEach(batch => {
    sanbingTotal += asNum(_.get(batch, 'Số_Lượng', 0), 0);
  });

  // Bảng tổng quan
  $set('zhengfu-m-armies', armies);
  $set('zhengfu-m-soldiers', soldiers.toLocaleString());
  $set('zhengfu-m-generals', generals);
  $set('zhengfu-m-equip', equipTotal.toLocaleString());
  $set('zhengfu-m-prisoners', prisoners.toLocaleString());
  $set('zhengfu-m-campaigns', campaigns);

  // Huy hiệu thẻ mô-đun
  $set('zhengfu-count-armies', `${armies} quân đoàn`);
  $set('zhengfu-count-sanbing', `${sanbingTotal.toLocaleString()} người`);
  $set('zhengfu-count-generals', `${generals} tướng`);
  $set('zhengfu-count-equip', `${equipTotal.toLocaleString()} kiện`);
  $set('zhengfu-count-training', `${trainingCount} đội`);
  $set('zhengfu-count-prisoners', `${prisoners.toLocaleString()} người`);
  $set('zhengfu-count-campaigns', `${campaigns} mục`);
})();


// ===== Kết xuất hệ thống Vô Song =====
const wushuang = _.get(all_variables, 'stat_data.Vô_Song', {});
window.__wushuangCache = wushuang;

const body = _.get(wushuang,'Tố_Chất_Cơ_Thể',{}) || {};
const eq = _.get(wushuang,'Trang_Bị_Cá_Nhân',{}) || {};
const skills = _.get(wushuang,'Võ_Kỹ',{}) || {};
const kills = _.get(wushuang,'Ghi_Chép_Trảm_Tướng',{}) || {};

const setText = (id, v) => { const el=document.getElementById(id); if(el) el.textContent = (v ?? '--'); };

setText('ws-power', _.get(body,'Sức_Mạnh','--'));
setText('ws-speed', _.get(body,'Tốc_Độ','--'));
setText('ws-stamina', _.get(body,'Bền_Bỉ','--'));
setText('ws-injury', _.get(body,'Thương_Bệnh','Không'));

const equipSummary = [
  `Chính：${_.get(eq,'Vũ_Khí_Chính','Không')}`,
  `Phụ：${_.get(eq,'Vũ_Khí_Phụ','Không')}`,
  `Giáp：${_.get(eq,'Giáp_Trụ','Không')}`,
  `Thú：${_.get(eq,'Thú_Cưỡi','Không')}`,
].join(' · ');
setText('ws-equip-summary', equipSummary);

// Ghi chi tiết "Tố chất cơ thể" (Cho cửa sổ bật lên)
const wsBodyEl = document.getElementById('wushuang-body');
if (wsBodyEl){
  wsBodyEl.innerHTML = `
    <div class="person-basic-info" style="grid-template-columns:repeat(2,1fr);margin-bottom:14px;">
      <div class="person-stat"><div class="person-stat-label">Sức mạnh</div><div class="person-stat-value">${_.get(body,'Sức_Mạnh','--')}</div></div>
      <div class="person-stat"><div class="person-stat-label">Tốc độ</div><div class="person-stat-value">${_.get(body,'Tốc_Độ','--')}</div></div>
      <div class="person-stat"><div class="person-stat-label">Bền bỉ</div><div class="person-stat-value">${_.get(body,'Bền_Bỉ','--')}</div></div>
      <div class="person-stat"><div class="person-stat-label">Thương bệnh</div><div class="person-stat-value">${_.get(body,'Thương_Bệnh','Không')}</div></div>
    </div>
  `;
}

// Ghi chi tiết "Trang bị cá nhân" (Cho cửa sổ bật lên)
const wsEquipEl = document.getElementById('wushuang-equip');
if (wsEquipEl){
  wsEquipEl.innerHTML = `
    <div class="info-group"><div class="info-label">▸ Vũ khí chính</div><div class="info-value">${_.get(eq,'Vũ_Khí_Chính','Không')}</div></div>
    <div class="info-group"><div class="info-label">▸ Vũ khí phụ</div><div class="info-value">${_.get(eq,'Vũ_Khí_Phụ','Không')}</div></div>
    <div class="info-group"><div class="info-label">▸ Giáp trụ</div><div class="info-value">${_.get(eq,'Giáp_Trụ','Không')}</div></div>
    <div class="info-group"><div class="info-label">▸ Thú cưỡi</div><div class="info-value">${_.get(eq,'Thú_Cưỡi','Không')}</div></div>
  `;
}

// Danh sách võ kỹ
const skillEl = document.getElementById('wushuang-skill');
if (skillEl){
  const keys = Object.keys(skills);
  skillEl.innerHTML = keys.length ? keys.sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')).map(name=>{
    const d = skills[name] || {};
    return `
      <div class="list-item">
        <div class="list-header" onclick="toggleExpand(this)">
          <div class="list-name">${fmt(name)}</div>
          <div style="display:flex;gap:10px;align-items:center;">
            <span class="list-badge green">${_.get(d,'Loại','Chờ khởi tạo')}</span>
            <span class="list-badge">${_.get(d,'Độ_Thành_Thục','Sơ nhập')}</span>
            <span class="expand-icon">▼</span>
          </div>
        </div>
        <div class="list-content">
          <div class="content-inner">
            <div class="info-group"><div class="info-label">▸ Thuyết minh</div><div class="info-value">${_.get(d,'Thuyết_Minh','Chờ khởi tạo')}</div></div>
          </div>
        </div>
      </div>
    `;
  }).join('') : `<div class="empty-state">Tạm không có võ kỹ</div>`;
}

// Ghi chép trảm tướng
const killEl = document.getElementById('wushuang-kill');
if (killEl){
  const keys = Object.keys(kills);
  killEl.innerHTML = keys.length ? keys.sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')).map(name=>{
    const d = kills[name] || {};
    return `
      <div class="list-item">
        <div class="list-header" onclick="toggleExpand(this)">
          <div class="list-name">${fmt(name)}</div>
          <div style="display:flex;gap:10px;align-items:center;">
            <span class="list-badge">${_.get(d,'Kết_Quả','Chờ khởi tạo')}</span>
            <span class="expand-icon">▼</span>
          </div>
        </div>
        <div class="list-content">
          <div class="content-inner">
            <div class="person-basic-info" style="grid-template-columns:repeat(2,1fr);margin-bottom:14px;">
              <div class="person-stat"><div class="person-stat-label">Thời gian</div><div class="person-stat-value">${_.get(d,'Thời_Gian','Chờ khởi tạo')}</div></div>
              <div class="person-stat"><div class="person-stat-label">Đối thủ</div><div class="person-stat-value">${_.get(d,'Đối_Thủ','Chờ khởi tạo')}</div></div>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('') : `<div class="empty-state">Tạm không có ghi chép</div>`;
}

const wsSkillCount = Object.keys(skills || {}).length;
const wsKillCount  = Object.keys(kills  || {}).length;

const bSkills = document.getElementById('ws-count-skills');
if (bSkills) bSkills.textContent = `${wsSkillCount} mục`;

const bKills = document.getElementById('ws-count-kills');
if (bKills) bKills.textContent = `${wsKillCount} mục`;

// ===== Kết xuất Quyền Thuật =====
const quanshu = _.get(all_variables, 'stat_data.Quyền_Thuật', {});
window.__quanshuCache = quanshu;

const office = _.get(quanshu,'Quan_Chức',{}) || {};
document.getElementById('qs-m-office').textContent = _.get(office,'Quan_Chức_Hiện_Tại','Không');
document.getElementById('qs-m-rank').textContent = _.get(office,'Phẩm_Cấp','Không');
document.getElementById('qs-b-office').textContent = _.get(office,'Phạm_Vi_Thực_Quyền','-');

const paixi = _.get(quanshu,'Quan_Hệ_Phe_Phái',{}) || {};
const chouma = _.get(quanshu,'Kho_Chiêu_Bài',{}) || {};
const min = _.get(quanshu,'Chính_Sách_Với_Dân',{}) || {};
const jun = _.get(quanshu,'Chính_Sách_Với_Quân',{}) || {};
const mimou = _.get(quanshu,'Mật_Mưu',{}) || {};

document.getElementById('qs-m-paixi').textContent = Object.keys(paixi).length;
document.getElementById('qs-m-chouma').textContent = Object.keys(chouma).length;
document.getElementById('qs-m-policy').textContent = Object.keys(min).length + Object.keys(jun).length;
document.getElementById('qs-m-mimou').textContent = Object.keys(mimou).length;

document.getElementById('qs-b-paixi').textContent = `${Object.keys(paixi).length} mục`;
document.getElementById('qs-b-chouma').textContent = `${Object.keys(chouma).length} mục`;
document.getElementById('qs-b-min').textContent = `${Object.keys(min).length} dòng`;
document.getElementById('qs-b-jun').textContent = `${Object.keys(jun).length} dòng`;
document.getElementById('qs-b-mimou').textContent = `${Object.keys(mimou).length} mục`;

// Chi tiết quan chức
document.getElementById('quanshu-office').innerHTML = `
  <div class="info-group"><div class="info-label">▸ Quan chức hiện tại</div><div class="info-value">${_.get(office,'Quan_Chức_Hiện_Tại','Không')}</div></div>
  <div class="info-group"><div class="info-label">▸ Phẩm cấp</div><div class="info-value">${_.get(office,'Phẩm_Cấp','Không')}</div></div>
  <div class="info-group"><div class="info-label">▸ Phạm vi thực quyền</div><div class="info-value">${_.get(office,'Phạm_Vi_Thực_Quyền','Không')}</div></div>
`;

// Thông dụng: Kết xuất record thành danh sách có thể gập
function renderRecordToList(record, getHeaderBadges, getInnerHtml){
  const keys = Object.keys(record || {});
  if (!keys.length) return `<div class="empty-state">Tạm không có nội dung</div>`;
  return keys.sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')).map(name=>{
    const d = record[name] || {};
    const badges = getHeaderBadges(name, d) || '';
    const inner = getInnerHtml(name, d) || '';
    return `
      <div class="list-item">
        <div class="list-header" onclick="toggleExpand(this)">
          <div class="list-name">${fmt(name)}</div>
          <div style="display:flex;gap:10px;align-items:center;">
            ${badges}
            <span class="expand-icon">▼</span>
          </div>
        </div>
        <div class="list-content">
          <div class="content-inner">${inner}</div>
        </div>
      </div>
    `;
  }).join('');
}

document.getElementById('quanshu-paixi').innerHTML = renderRecordToList(
  paixi,
  (name,d)=>`<span class="list-badge">${Number(_.get(d,'Thái_Độ',0))||0}</span>`,
  (name,d)=>`
    <div class="info-group"><div class="info-label">▸ Tranh chấp lợi ích</div><div class="info-value">${_.get(d,'Tranh_Chấp_Lợi_Ích','Chờ khởi tạo')}</div></div>
    <div class="info-group"><div class="info-label">▸ Nhân vật then chốt</div><div class="info-value">${_.get(d,'Nhân_Vật_Then_Chốt','Chờ khởi tạo')}</div></div>
  `
);

document.getElementById('quanshu-chouma').innerHTML = renderRecordToList(
  chouma,
  (name,d)=>`<span class="list-badge green">${_.get(d,'Loại','Chờ khởi tạo')}</span><span class="list-badge">${_.get(d,'Trạng_Thái','Chưa sử dụng')}</span>`,
  (name,d)=>`
    <div class="info-group"><div class="info-label">▸ Nhân vật liên quan</div><div class="info-value">${_.get(d,'Nhân_Vật_Liên_Quan','Chờ khởi tạo')}</div></div>
    <div class="info-group"><div class="info-label">▸ Giá trị</div><div class="info-value">${_.get(d,'Giá_Trị','Chờ khởi tạo')}</div></div>
  `
);

document.getElementById('quanshu-min').innerHTML = renderRecordToList(
  min,
  ()=>`<span class="list-badge">Chính sách</span>`,
  (name,d)=>`
    <div class="info-group"><div class="info-label">▸ Nội dung</div><div class="info-value">${_.get(d,'Nội_Dung','Chờ khởi tạo')}</div></div>
    <div class="info-group"><div class="info-label">▸ Hiệu quả</div><div class="info-value">${_.get(d,'Hiệu_Quả','Chờ khởi tạo')}</div></div>
    <div class="info-group"><div class="info-label">▸ Ảnh hưởng lòng dân</div><div class="info-value">${_.get(d,'Ảnh_Hưởng_Lòng_Dân','Chờ khởi tạo')}</div></div>
  `
);

document.getElementById('quanshu-jun').innerHTML = renderRecordToList(
  jun,
  ()=>`<span class="list-badge">Chính sách</span>`,
  (name,d)=>`
    <div class="info-group"><div class="info-label">▸ Nội dung</div><div class="info-value">${_.get(d,'Nội_Dung','Chờ khởi tạo')}</div></div>
    <div class="info-group"><div class="info-label">▸ Hiệu quả</div><div class="info-value">${_.get(d,'Hiệu_Quả','Chờ khởi tạo')}</div></div>
    <div class="info-group"><div class="info-label">▸ Ảnh hưởng lòng quân</div><div class="info-value">${_.get(d,'Ảnh_Hưởng_Lòng_Quân','Chờ khởi tạo')}</div></div>
  `
);

document.getElementById('quanshu-mimou').innerHTML = renderRecordToList(
  mimou,
  ()=>`<span class="list-badge red">Mật mưu</span>`,
  (name,d)=>`
    <div class="info-group"><div class="info-label">▸ Mục tiêu</div><div class="info-value">${_.get(d,'Mục_Tiêu','Chờ khởi tạo')}</div></div>
    <div class="info-group"><div class="info-label">▸ Người tham gia</div><div class="info-value">${_.get(d,'Người_Tham_Gia','Chờ khởi tạo')}</div></div>
    <div class="info-group"><div class="info-label">▸ Tiến độ / Rủi ro</div><div class="info-value">${_.get(d,'Tiến_Độ','Chờ khởi tạo')} / ${_.get(d,'Rủi_Ro','Chờ khởi tạo')}</div></div>
  `
);

// ===== Kết xuất Thiên Mệnh =====
const tianming = _.get(all_variables, 'stat_data.Thiên_Mệnh', {});
window.__tianmingCache = tianming;

const tmVal = Number(_.get(tianming,'Giá_Trị_Thiên_Mệnh',0)) || 0;
document.getElementById('tm-m-value').textContent = tmVal;
document.getElementById('tm-b-value').textContent = tmVal;

const xc = _.get(tianming,'Tuyên_Bố_Chủ_Quyền',{}) || {};
const xr = _.get(tianming,'Điềm_Lành_Và_Điềm_Dữ',{}) || {};
const cs = _.get(tianming,'Truyền_Thuyết_Dân_Gian',{}) || {};
const cd = _.get(tianming,'Điều_Kiện_Xưng_Đế',{}) || {};
const nh = _.get(tianming,'Niên_Hiệu_Và_Quốc_Hiệu',{}) || {};

document.getElementById('tm-m-xuancheng').textContent = Object.keys(xc).length;
document.getElementById('tm-m-xiangrui').textContent = Object.keys(xr).length;
document.getElementById('tm-m-chuanshuo').textContent = Object.keys(cs).length;
document.getElementById('tm-m-eval').textContent = _.get(cd,'Đánh_Giá_Tổng_Hợp','Chờ khởi tạo');

document.getElementById('tm-b-xuancheng').textContent = `${Object.keys(xc).length} mục`;
document.getElementById('tm-b-xiangrui').textContent = `${Object.keys(xr).length} mục`;
document.getElementById('tm-b-chuanshuo').textContent = `${Object.keys(cs).length} mục`;
document.getElementById('tm-b-chengdi').textContent = _.get(cd,'Đánh_Giá_Tổng_Hợp','—');
document.getElementById('tm-b-nianhao').textContent = `${_.get(nh,'Quốc_Hiệu_Dự_Định','—')}/${_.get(nh,'Niên_Hiệu_Dự_Định','—')}`;

document.getElementById('tianming-value').innerHTML = `
  <div class="info-group"><div class="info-label">▸ Giá trị thiên mệnh</div><div class="info-value">${tmVal}</div></div>
`;

document.getElementById('tianming-xuancheng').innerHTML = renderRecordToList(
  xc,
  (name,d)=>`<span class="list-badge">${fmt(_.get(d,'Trạng_Thái','Tiềm năng'))}</span><span class="list-badge green">${fmt(_.get(d,'Độ_Chấp_Nhận','Không ai công nhận'))}</span>`,
  (name,d)=>`
    <div class="info-group"><div class="info-label">▸ Mục tiêu</div><div class="info-value">${fmt(_.get(d,'Mục_Tiêu','Chờ khởi tạo'))}</div></div>
    <div class="info-group"><div class="info-label">▸ Căn cứ</div><div class="info-value">${fmt(_.get(d,'Căn_Cứ','Chờ khởi tạo'))}</div></div>
  `
);

document.getElementById('tianming-xiangrui').innerHTML = renderRecordToList(
  xr,
  (name,d)=>`<span class="list-badge ${String(_.get(d,'Tính_Chất','')).includes('Dữ') ? 'red' : 'green'}">${fmt(_.get(d,'Tính_Chất','Chờ khởi tạo'))}</span>`,
  (name,d)=>`
    <div class="info-group"><div class="info-label">▸ Thời gian</div><div class="info-value">${fmt(_.get(d,'Thời_Gian','Chờ khởi tạo'))}</div></div>
    <div class="info-group"><div class="info-label">▸ Nội dung</div><div class="info-value">${fmt(_.get(d,'Nội_Dung','Chờ khởi tạo'))}</div></div>
    <div class="info-group"><div class="info-label">▸ Phạm vi lan truyền / Có phải do người làm</div><div class="info-value">${fmt(_.get(d,'Phạm_Vi_Lan_Truyền','Chờ khởi tạo'))} / ${fmt(_.get(d,'Có_Phải_Do_Người_Làm',false) ? 'Có' : 'Không')}</div></div>
  `
);

document.getElementById('tianming-chuanshuo').innerHTML = renderRecordToList(
  cs,
  ()=>`<span class="list-badge">Truyền thuyết</span>`,
  (name,d)=>`
    <div class="info-group"><div class="info-label">▸ Nội dung</div><div class="info-value">${fmt(_.get(d,'Nội_Dung','Chờ khởi tạo'))}</div></div>
    <div class="info-group"><div class="info-label">▸ Nguồn gốc / Sức ảnh hưởng</div><div class="info-value">${_.get(d,'Nguồn_Gốc','Chờ khởi tạo')} / ${_.get(d,'Sức_Ảnh_Hưởng','Chờ khởi tạo')}</div></div>
  `
);

const extra = _.get(cd,'Điều_Kiện_Bổ_Sung',{}) || {};
const extraTags = Object.keys(extra).length
  ? Object.entries(extra).map(([k,v])=>`<span class="tag" title="${v ? 'Đã đạt được' : 'Chưa đạt được'}">${k}${v ? ' ✓' : ''}</span>`).join('')
  : `<span class="tag tag-empty">Tạm không có</span>`;

document.getElementById('tianming-chengdi').innerHTML = `
  <div class="person-basic-info" style="grid-template-columns:repeat(2,1fr);margin-bottom:14px;">
    <div class="person-stat"><div class="person-stat-label">Số châu chiếm đóng</div><div class="person-stat-value">${Number(_.get(cd,'Số_Châu_Chiếm_Đóng',0))||0}</div></div>
    <div class="person-stat"><div class="person-stat-label">Sở hữu vạn binh</div><div class="person-stat-value">${_.get(cd,'Sở_Hữu_Vạn_Binh',false) ? 'Có' : 'Không'}</div></div>
    <div class="person-stat"><div class="person-stat-label">Văn võ bá quan đầy đủ</div><div class="person-stat-value">${_.get(cd,'Văn_Võ_Bá_Quan_Đầy_Đủ',false) ? 'Có' : 'Không'}</div></div>
    <div class="person-stat"><div class="person-stat-label">Thiên mệnh điềm lành ủng hộ</div><div class="person-stat-value">${_.get(cd,'Thiên_Mệnh_Điềm_Lành_Ủng_Hộ',false) ? 'Có' : 'Không'}</div></div>
    <div class="person-stat"><div class="person-stat-label">Được dâng sớ mời lên ngôi</div><div class="person-stat-value">${_.get(cd,'Được_Dâng_Sớ_Mời_Lên_Ngôi',false) ? 'Có' : 'Không'}</div></div>
    <div class="person-stat"><div class="person-stat-label">Đánh giá tổng hợp</div><div class="person-stat-value" style="font-size:12px;">${_.get(cd,'Đánh_Giá_Tổng_Hợp','Chờ khởi tạo')}</div></div>
  </div>
  <div class="info-group"><div class="info-label">▸ Điều kiện bổ sung</div><div class="tags-container" style="margin-top:6px;">${extraTags}</div></div>
`;

document.getElementById('tianming-nianhao').innerHTML = `
  <div class="info-group"><div class="info-label">▸ Quốc hiệu dự định</div><div class="info-value">${fmt(_.get(nh,'Quốc_Hiệu_Dự_Định','Chờ khởi tạo'))}</div></div>
  <div class="info-group"><div class="info-label">▸ Niên hiệu dự định</div><div class="info-value">${fmt(_.get(nh,'Niên_Hiệu_Dự_Định','Chờ khởi tạo'))}</div></div>
`;

// ===== Kết xuất Tài chính =====
const caizheng = _.get(all_variables, 'stat_data.Tài_Chính', {});
window.__caizhengCache = caizheng;

const czSilver = Number(_.get(caizheng,'Phủ_Khố.Ngân_Lượng',0)) || 0;
const czCopper = Number(_.get(caizheng,'Phủ_Khố.Quan_Tiền',0)) || 0;

const incomeMap = _.get(caizheng, 'Chi_Tiết_Thu_Nhập', {}) || {};
const expenseMap = _.get(caizheng, 'Chi_Tiết_Chi_Tiêu', {}) || {};

let totalIncome = Number(_.get(caizheng, '_Thu_Chi_Hàng_Tháng.Tổng_Thu_Nhập', NaN));
let totalExpense = Number(_.get(caizheng, '_Thu_Chi_Hàng_Tháng.Tổng_Chi_Tieu', NaN));
if (!Number.isFinite(totalIncome)) totalIncome = _(incomeMap).values().sum();
if (!Number.isFinite(totalExpense)) totalExpense = _(expenseMap).values().sum();
const balance = totalIncome - totalExpense;

const $txt = (id, v) => { const el=document.getElementById(id); if(el) el.textContent=v; };
$txt('cz-silver', czSilver.toLocaleString());
$txt('cz-copper', czCopper.toLocaleString());
$txt('cz-income-total', totalIncome.toLocaleString());
$txt('cz-expense-total', totalExpense.toLocaleString());
$txt('cz-counts', `${Object.keys(_.get(caizheng,'Thương_Lộ',{})||{}).length} / ${Object.keys(_.get(caizheng,'Thương_Đội',{})||{}).length} / ${Object.keys(_.get(caizheng,'Sản_Nghiệp',{})||{}).length}`);

const balEl = document.getElementById('cz-balance');
if (balEl){
  balEl.textContent = balance.toLocaleString();
  balEl.classList.remove('metric-positive','metric-negative');
  balEl.classList.add(balance >= 0 ? 'metric-positive' : 'metric-negative');
}

// Thu / Chi (Dùng storage-list)
const incomeEl = document.getElementById('cz-income-list');
if (incomeEl){
  const entries = Object.entries(incomeMap).sort((a,b)=>(Number(b[1])||0)-(Number(a[1])||0));
  incomeEl.innerHTML = entries.length ? entries.map(([k,v])=>`
    <div class="storage-item">
      <span class="storage-name">${fmt(k)}</span>
      <span class="storage-count">${(Number(v)||0).toLocaleString()}</span>
    </div>
  `).join('') : `<div class="empty-state">Tạm không có thu nhập</div>`;
}

const expenseEl = document.getElementById('cz-expense-list');
if (expenseEl){
  const entries = Object.entries(expenseMap).sort((a,b)=>(Number(b[1])||0)-(Number(a[1])||0));
  expenseEl.innerHTML = entries.length ? entries.map(([k,v])=>`
    <div class="storage-item">
      <span class="storage-name">${fmt(k)}</span>
      <span class="storage-count" style="color:#ffb2b2;">${(Number(v)||0).toLocaleString()}</span>
    </div>
  `).join('') : `<div class="empty-state">Tạm không có chi tiêu</div>`;
}
// Thương lộ
const routeEl = document.getElementById('cz-route-list');
if (routeEl){
  const routes = _.get(caizheng, 'Thương_Lộ', {}) || {};
  const keys = Object.keys(routes);
  routeEl.innerHTML = keys.length ? keys.sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')).map(name=>{
    const d = routes[name] || {};
    return `
      <div class="list-item">
        <div class="list-header" onclick="toggleExpand(this)">
          <div class="list-name">${fmt(name)}</div>
          <div style="display:flex;gap:10px;align-items:center;">
            <span class="list-badge green">${_.get(d,'Độ_An_Toàn','Chờ khởi tạo')}</span>
            <span class="list-badge">${_.get(d,'Lợi_Nhuận_Dự_Kiến','--')}</span>
            <span class="expand-icon">▼</span>
          </div>
        </div>
        <div class="list-content">
          <div class="content-inner">
            <div class="info-group"><div class="info-label">▸ Khởi đầu - Kết thúc</div><div class="info-value">${_.get(d,'Điểm_Khởi_Đầu','--')} → ${_.get(d,'Điểm_Kết_Thúc','--')}</div></div>
            <div class="info-group"><div class="info-label">▸ Hàng hóa chính</div><div class="info-value">${_.get(d,'Hàng_Hóa_Chính','--')}</div></div>
          </div>
        </div>
      </div>
    `;
  }).join('') : `<div class="empty-state">Tạm không có thương lộ</div>`;
}

// Thương đội
const caravanEl = document.getElementById('cz-caravan-list');
if (caravanEl){
  const caravans = _.get(caizheng, 'Thương_Đội', {}) || {};
  const keys = Object.keys(caravans);
  caravanEl.innerHTML = keys.length ? keys.sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')).map(name=>{
    const d = caravans[name] || {};
    const goods = _.get(d,'Hàng_Hóa',{}) || {};
    const goodsTags = Object.keys(goods).length
      ? Object.entries(goods).map(([gn,gv])=>`<span class="tag">${gn} ×${Number(_.get(gv,'Số_Lượng',0))||0}（Giá nhập ${Number(_.get(gv,'Giá_Nhập',0))||0}）</span>`).join('')
      : `<span class="tag tag-empty">Tạm không có hàng hóa</span>`;
    return `
      <div class="list-item">
        <div class="list-header" onclick="toggleExpand(this)">
          <div class="list-name">${fmt(name)}</div>
          <div style="display:flex;gap:10px;align-items:center;">
            <span class="list-badge">${_.get(d,'Trạng_Thái','Chờ khởi tạo')}</span>
            <span class="list-badge green">${Number(_.get(d,'Số_Lượng_Người',0))||0} người</span>
            <span class="expand-icon">▼</span>
          </div>
        </div>
        <div class="list-content">
          <div class="content-inner">
            <div class="person-basic-info" style="grid-template-columns:repeat(2,1fr);margin-bottom:14px;">
              <div class="person-stat"><div class="person-stat-label">Hộ vệ</div><div class="person-stat-value">${Number(_.get(d,'Hộ_Vệ',0))||0}</div></div>
              <div class="person-stat"><div class="person-stat-label">Tuyến đường</div><div class="person-stat-value" style="font-size:12px;">${_.get(d,'Vị_Trí_Hiện_Tại','--')} → ${_.get(d,'Điểm_Đến','--')}</div></div>
            </div>
            <div class="info-group"><div class="info-label">▸ Hàng hóa</div><div class="tags-container" style="margin-top:6px;">${fmt(goodsTags)}</div></div>
          </div>
        </div>
      </div>
    `;
  }).join('') : `<div class="empty-state">Tạm không có thương đội</div>`;
}

// Sản nghiệp
const indEl = document.getElementById('cz-industry-list');
if (indEl){
  const inds = _.get(caizheng, 'Sản_Nghiệp', {}) || {};
  const keys = Object.keys(inds);
  indEl.innerHTML = keys.length ? keys.sort((a,b)=>a.localeCompare(b,'zh-Hans-CN')).map(name=>{
    const d = inds[name] || {};
    const out = Number(_.get(d,'Sản_Lượng_Hàng_Tháng',0))||0;
    const cost = Number(_.get(d,'Chi_Phí_Vận_Hành',0))||0;
    return `
      <div class="list-item">
        <div class="list-header" onclick="toggleExpand(this)">
          <div class="list-name">${fmt(name)}</div>
          <div style="display:flex;gap:10px;align-items:center;">
            <span class="list-badge green">${_.get(d,'Loại','Chờ khởi tạo')}</span>
            <span class="list-badge">Lãi ròng ${ (out - cost).toLocaleString() }</span>
            <span class="expand-icon">▼</span>
          </div>
        </div>
        <div class="list-content">
          <div class="content-inner">
            <div class="person-basic-info" style="grid-template-columns:repeat(3,1fr);margin-bottom:14px;">
              <div class="person-stat"><div class="person-stat-label">Vị trí</div><div class="person-stat-value">${_.get(d,'Vị_Trí','--')}</div></div>
              <div class="person-stat"><div class="person-stat-label">Sản lượng hàng tháng</div><div class="person-stat-value">${out.toLocaleString()}</div></div>
              <div class="person-stat"><div class="person-stat-label">Chi phí vận hành</div><div class="person-stat-value">${cost.toLocaleString()}</div></div>
            </div>
            <div class="info-group"><div class="info-label">▸ Mô tả</div><div class="info-value">${_.get(d,'Mô_Tả','--')}</div></div>
          </div>
        </div>
      </div>
    `;
  }).join('') : `<div class="empty-state">Tạm không có sản nghiệp</div>`;
}



    }

/* ===== Tự động điền vào khung nhập liệu của Tavern (Mặc định thêm vào sau, không ghi đè) ===== */

function getSendTextarea(){
  return document.querySelector('textarea#send_textarea')
      || document.querySelector('#send_textarea');
}

/**
 * @param {string} text
 * @param {{mode?: 'append'|'overwrite'}} opts
 */
function fillSendTextarea(text, opts = {}) {
  if (!text) return;

  const mode = opts.mode || 'append';
  const textarea = getSendTextarea();
  if (!textarea) return;

  const cur = textarea.value || '';
  let next = String(text).trim();

  if (mode === 'append') {
    const trimmedCur = cur.replace(/\s*$/g, '');
    next = trimmedCur ? (trimmedCur + '\n' + next) : next;
  }

  textarea.value = next;

  textarea.dispatchEvent(new Event('input',  { bubbles: true }));
  textarea.dispatchEvent(new Event('change', { bubbles: true }));
  if (window.$) $('#send_textarea').trigger('input').trigger('change');

  textarea.focus();
  try { textarea.setSelectionRange(next.length, next.length); } catch(e){}

  const openModal = document.querySelector('.modal-overlay.active');
  if (openModal) openModal.classList.remove('active');
}

function autoFillToChat(elementId) {
  setTimeout(function() {
    const el = document.getElementById(elementId);
    if (!el) return;
    fillSendTextarea((el.textContent || '').trim(), { mode: 'append' }); // Quan trọng: Thêm vào sau
  }, 0);
}

    window.switchPage = switchPage;
    window.openWushuangModule = openWushuangModule;
    window.openQuanshuModule = openQuanshuModule;
window.openTianmingModule = openTianmingModule;

window.openQuanshuEdit = openQuanshuEdit;
window.openTianmingEdit = openTianmingEdit;

window.generateQsOfficePatch = generateQsOfficePatch;
window.generateQsPaixiPatch = generateQsPaixiPatch;
window.generateQsPaixiDeletePatch = generateQsPaixiDeletePatch;
window.generateQsChoumaPatch = generateQsChoumaPatch;
window.generateQsChoumaDeletePatch = generateQsChoumaDeletePatch;
window.generateQsMinPatch = generateQsMinPatch;
window.generateQsMinDeletePatch = generateQsMinDeletePatch;
window.generateQsJunPatch = generateQsJunPatch;
window.generateQsJunDeletePatch = generateQsJunDeletePatch;
window.generateQsMimouPatch = generateQsMimouPatch;
window.generateQsMimouDeletePatch = generateQsMimouDeletePatch;

window.generateTmValuePatch = generateTmValuePatch;
window.generateTmXuanchengPatch = generateTmXuanchengPatch;
window.generateTmXuanchengDeletePatch = generateTmXuanchengDeletePatch;
window.generateTmXiangruiPatch = generateTmXiangruiPatch;
window.generateTmXiangruiDeletePatch = generateTmXiangruiDeletePatch;
window.generateTmChuanshuoPatch = generateTmChuanshuoPatch;
window.generateTmChuanshuoDeletePatch = generateTmChuanshuoDeletePatch;
window.generateTmChengdiPatch = generateTmChengdiPatch;
window.generateTmExtraDeletePatch = generateTmExtraDeletePatch;
window.generateTmNianhaoPatch = generateTmNianhaoPatch;
    window.openCaizhengModal = openCaizhengModal;
window.openWushuangModal = openWushuangModal;
    window.openWushuangModal = openWushuangModal;
window.generateWsBodyPatch = generateWsBodyPatch;
window.generateWsEquipPatch = generateWsEquipPatch;
window.generateWsSkillPatch = generateWsSkillPatch;
window.generateWsSkillDeletePatch = generateWsSkillDeletePatch;
window.generateWsKillPatch = generateWsKillPatch;
window.generateWsKillDeletePatch = generateWsKillDeletePatch;
    window.openCaizhengModal = openCaizhengModal;
window.generateCzTreasuryPatch = generateCzTreasuryPatch;
window.generateCzIncomePatch = generateCzIncomePatch;
window.generateCzExpensePatch = generateCzExpensePatch;
window.generateCzIncomeDeletePatch = generateCzIncomeDeletePatch;
window.generateCzExpenseDeletePatch = generateCzExpenseDeletePatch;
window.generateCzRoutePatch = generateCzRoutePatch;
window.generateCzRouteDeletePatch = generateCzRouteDeletePatch;
window.generateCzCaravanPatch = generateCzCaravanPatch;
window.generateCzCaravanDeletePatch = generateCzCaravanDeletePatch;
window.generateCzIndustryPatch = generateCzIndustryPatch;
window.generateCzIndustryDeletePatch = generateCzIndustryDeletePatch;
    
    window.openHongyanModal = openHongyanModal;
    window.bindZichanCollapsibleSubsections = bindZichanCollapsibleSubsections;
    window.bindHeaderEasterEgg = bindHeaderEasterEgg;
    window.populateDiscardOptions = populateDiscardOptions;
window.generateDiscardSystemPatch = generateDiscardSystemPatch;
window.generateDiscardMingmianPatch = generateDiscardMingmianPatch;
window.generateDiscardBookPatch = generateDiscardBookPatch;
    window.openRenmaiProfile = openRenmaiProfile;
    window.openZhengfuModule = openZhengfuModule;
    window.toggleExpand = toggleExpand; 
    window.toggleRenmaiPinned = toggleRenmaiPinned;
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.switchTab = switchTab;
    window.generateRenmaiPatch = generateRenmaiPatch;
    window.generateRenmaiDeletePatch = generateRenmaiDeletePatch;
    window.generateDashiPatch = generateDashiPatch;
        window.generateDashiDeletePatch = generateDashiDeletePatch;
    window.autoFillToChat = autoFillToChat;
    window.fillSendTextarea = fillSendTextarea;
    

 async function init() {
  await waitGlobalInitialized('Mvu');
  populateCharacterData();
  bindHeaderEasterEgg();
  bindZichanCollapsibleSubsections();
  
  eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, () => { populateCharacterData(); });
}

    $(errorCatched(init));
  </script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-title">Vạn Dân Quy Tâm</div>
      <div class="header-subtitle" id="header-date">Năm Thuận An thứ 83</div>
    </div>

<div class="nav-tabs">
  <button class="nav-tab active" data-page="page-dashi" onclick="switchPage('page-dashi')">Đại Thế</button>
  <button class="nav-tab" data-page="page-renmai" onclick="switchPage('page-renmai')">Nhân Mạch</button>
  <button class="nav-tab" data-page="page-zichan" onclick="switchPage('page-zichan')">Tài Sản</button>
  <button class="nav-tab" data-page="page-jiyao" onclick="switchPage('page-jiyao')">Kỷ Yếu</button>
  <button class="nav-tab" data-page="page-zhengfu" onclick="switchPage('page-zhengfu')">Chinh Phục</button>

  <button class="nav-tab" data-page="page-guixin" onclick="switchPage('page-guixin')">Quy Tâm</button>
  <button class="nav-tab" data-page="page-wushuang" onclick="switchPage('page-wushuang')">Vô Song</button>
  <button class="nav-tab" data-page="page-quanshu" onclick="switchPage('page-quanshu')">Quyền Thuật</button>
  <button class="nav-tab" data-page="page-caizheng" onclick="switchPage('page-caizheng')">Tài Chính</button>
  <button class="nav-tab" data-page="page-tianming" onclick="switchPage('page-tianming')">Thiên Mệnh</button>
</div>

<div id="page-dashi" class="page active">
  <div class="section-title"><span>Thiên hạ đại thế</span></div>

  <div class="info-group" style="margin-bottom: 16px;">
    <div class="info-label">▸ Tin đồn</div>
    <div class="info-value" id="dashi-xiaodao">Tạm không có tin tức</div>
  </div>

  <div class="subsection-title">▸ Động thái thế lực</div>
  <div id="dashi-list" class="list-container"></div>
</div>


<div id="page-renmai" class="page">
<div class="section-title">
  <span>Quan hệ nhân mạch</span>
  <div style="display:flex; gap:8px; align-items:center;">
    <button class="section-btn" onclick="openHongyanModal()">Hồng nhan tri kỷ</button>
  </div>
</div>
  <div id="renmai-list" class="list-container"></div>
</div>

<div id="page-zichan" class="page">
  <div class="section-title">
    <span>Tài vật</span>
  </div>

  <div class="asset-grid">
    <div class="asset-card">
      <div class="asset-icon">🪙</div>
      <div class="asset-value" id="asset-silver">0</div>
      <div class="asset-label">Ngân lượng</div>
    </div>
    <div class="asset-card">
      <div class="asset-icon">🪙</div>
      <div class="asset-value" id="asset-copper">0</div>
      <div class="asset-label">Quan tiền</div>
    </div>
  </div>

  <div class="subsection" data-collapsible="1">
    <div class="subsection-title">▸ Tài sản công khai</div>
    <div id="mingmian-list" class="list-container"></div>
  </div>

  <div class="subsection" data-collapsible="1">
    <div class="subsection-title">▸ Không gian hệ thống</div>
    <div id="xitong-storage" class="storage-list"></div>

    <div style="margin-top: 12px;">
      <div class="info-label">Sách đã nhận</div>
      <div id="books-list" class="tags-container" style="margin-top: 6px;"></div>
    </div>
  </div>

  <div class="subsection" data-collapsible="1">
    <div class="subsection-title">▸ Điền sản</div>
    <div id="budongchan-list" class="list-container"></div>
  </div>

  <div class="subsection" data-collapsible="1">
    <div class="subsection-title">▸ Quân đội dưới trướng</div>
    <div id="jundui-list"></div>
  </div>
</div>

    <div id="page-jiyao" class="page">
      <div class="section-title">Kỷ yếu cá nhân</div>
      <div class="profile-card">
        <div class="profile-header"><div class="profile-identity" id="jiyao-identity">--</div><div class="profile-fame" id="jiyao-fame">--</div></div>

        <div class="person-basic-info" style="margin-bottom: 16px;">
          <div class="person-stat"><div class="person-stat-label">Vị trí hiện tại</div><div class="person-stat-value" id="jiyao-location" style="font-size:12px;">--</div></div>
          <div class="person-stat"><div class="person-stat-label">Trạng thái sức khỏe</div><div class="person-stat-value" id="jiyao-health">--</div></div>
          <div class="person-stat"><div class="person-stat-label">Chức vụ quan phương</div><div class="person-stat-value" id="jiyao-office">--</div></div>
          <div class="person-stat"><div class="person-stat-label">Thế lực trực thuộc</div><div class="person-stat-value" id="jiyao-faction">--</div></div>
        </div>

        <div class="profile-stats">
          <div class="profile-stat"><div class="profile-stat-value" id="jiyao-troops">0</div><div class="profile-stat-label">Số quân sở hữu</div></div>
          <div class="profile-stat"><div class="profile-stat-value" id="jiyao-governance">--</div><div class="profile-stat-label">Cai trị</div></div>
          <div class="profile-stat"><div class="profile-stat-value" id="jiyao-hearts">--</div><div class="profile-stat-label">Lòng dân</div></div>
        </div>
      </div>
      <div class="subsection"><div class="subsection-title">▸ Danh hiệu</div><div id="jiyao-titles" class="tags-container"></div></div>
    </div>
<div id="page-zhengfu" class="page">
  <div class="section-title"><span>Hệ thống chinh phục</span></div>

  <div class="zhengfu-overview">
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Quân đoàn</div>
      <div class="zhengfu-metric-value" id="zhengfu-m-armies">0</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Tổng binh lực</div>
      <div class="zhengfu-metric-value" id="zhengfu-m-soldiers">0</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Tướng lĩnh</div>
      <div class="zhengfu-metric-value" id="zhengfu-m-generals">0</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Trang bị</div>
      <div class="zhengfu-metric-value" id="zhengfu-m-equip">0</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Tù binh</div>
      <div class="zhengfu-metric-value" id="zhengfu-m-prisoners">0</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Chiến dịch</div>
      <div class="zhengfu-metric-value" id="zhengfu-m-campaigns">0</div>
    </div>
  </div>

  <div class="zhengfu-modules">
  <div class="zhengfu-module-card" onclick="openZhengfuModule('jundui')">
    <div class="zhengfu-module-title">⚔ Biên chế quân đội</div>
    <div class="zhengfu-module-sub">Đầy đủ / Thực biên / Hậu cần / Tham chiến</div>
    <div class="zhengfu-module-badge" id="zhengfu-count-armies">0 quân đoàn</div>
  </div>

  <div class="zhengfu-module-card" onclick="openZhengfuModule('sanbing')">
    <div class="zhengfu-module-title">🪖 Trại lính lẻ</div>
    <div class="zhengfu-module-sub">Số lượng / Huấn luyện / Nguồn gốc</div>
    <div class="zhengfu-module-badge" id="zhengfu-count-sanbing">0 người</div>
  </div>

  <div class="zhengfu-module-card" onclick="openZhengfuModule('jiangling')">
    <div class="zhengfu-module-title">🎖 Danh sách tướng lĩnh</div>
    <div class="zhengfu-module-sub">Thống ngự/Võ nghệ / Nhiệm vụ / Sức khỏe</div>
    <div class="zhengfu-module-badge green" id="zhengfu-count-generals">0 tướng</div>
  </div>

  <div class="zhengfu-module-card" onclick="openZhengfuModule('junbei')">
    <div class="zhengfu-module-title">🛡 Kho quân bị</div>
    <div class="zhengfu-module-sub">Trang bị / Chiến mã / Lương thảo / Quân lương</div>
    <div class="zhengfu-module-badge" id="zhengfu-count-equip">0 kiện</div>
  </div>

  <div class="zhengfu-module-card" onclick="openZhengfuModule('xunlian')">
    <div class="zhengfu-module-title">📋 Sổ sách huấn luyện</div>
    <div class="zhengfu-module-sub">Giai đoạn / Tiến độ / Giám sát / Ngày hoàn thành</div>
    <div class="zhengfu-module-badge" id="zhengfu-count-training">0 đội</div>
  </div>

  <div class="zhengfu-module-card" onclick="openZhengfuModule('fulu')">
    <div class="zhengfu-module-title">⛓ Trại tù binh</div>
    <div class="zhengfu-module-sub">Ý chí / Giam giữ / Nguồn gốc / Thu biên</div>
    <div class="zhengfu-module-badge red" id="zhengfu-count-prisoners">0 người</div>
  </div>

  <div class="zhengfu-module-card" onclick="openZhengfuModule('zhanyi')">
    <div class="zhengfu-module-title">📜 Nhật ký chiến dịch</div>
    <div class="zhengfu-module-sub">Kết quả / Tổn thất / Chiến lợi phẩm / Ảnh hưởng</div>
    <div class="zhengfu-module-badge" id="zhengfu-count-campaigns">0 mục</div>
  </div>
</div>


  <div class="zhengfu-hidden">
  <div id="zhengfu-jundui"></div>
  <div id="zhengfu-sanbing"></div>
  <div id="zhengfu-jiangling"></div>
  <div id="zhengfu-junbei"></div>
  <div id="zhengfu-xunlian"></div>
  <div id="zhengfu-fulu"></div>
  <div id="zhengfu-zhanyi"></div>
</div>
</div>

<div id="page-wushuang" class="page">
  <div class="section-title">
    <span>Vô Song</span>
  </div>

  <div class="zhengfu-overview">
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Sức mạnh</div>
      <div class="zhengfu-metric-value" id="ws-power">--</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Tốc độ</div>
      <div class="zhengfu-metric-value" id="ws-speed">--</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Bền bỉ</div>
      <div class="zhengfu-metric-value" id="ws-stamina">--</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Thương bệnh</div>
      <div class="zhengfu-metric-value" id="ws-injury">Không</div>
    </div>
    <div class="zhengfu-metric" style="grid-column: span 2;">
      <div class="zhengfu-metric-label">Trang bị cá nhân</div>
      <div class="zhengfu-metric-value" id="ws-equip-summary">--</div>
    </div>
  </div>

  <div class="zhengfu-modules">
    <div class="zhengfu-module-card" onclick="openWushuangModule('body')">
      <div class="zhengfu-module-title">💪 Tố chất cơ thể</div>
      <div class="zhengfu-module-sub">Sức mạnh / Tốc độ / Bền bỉ / Thương bệnh</div>
      <div class="zhengfu-module-badge" id="ws-count-body">4 hạng mục</div>
    </div>

    <div class="zhengfu-module-card" onclick="openWushuangModule('equip')">
      <div class="zhengfu-module-title">🧰 Trang bị cá nhân</div>
      <div class="zhengfu-module-sub">Vũ khí chính / Vũ khí phụ / Giáp trụ / Thú cưỡi</div>
      <div class="zhengfu-module-badge" id="ws-count-equip">4 món</div>
    </div>

    <div class="zhengfu-module-card" onclick="openWushuangModule('skill')">
      <div class="zhengfu-module-title">🥋 Võ kỹ</div>
      <div class="zhengfu-module-sub">Loại / Độ thành thục / Thuyết minh</div>
      <div class="zhengfu-module-badge" id="ws-count-skills">0 hạng mục</div>
    </div>

    <div class="zhengfu-module-card" onclick="openWushuangModule('kill')">
      <div class="zhengfu-module-title">⚔ Ghi chép trảm tướng</div>
      <div class="zhengfu-module-sub">Thời gian / Đối thủ / Kết quả</div>
      <div class="zhengfu-module-badge" id="ws-count-kills">0 mục</div>
    </div>
  </div>

  <div class="zhengfu-hidden">
    <div id="wushuang-body"></div>
    <div id="wushuang-equip"></div>
    <div id="wushuang-skill"></div>
    <div id="wushuang-kill"></div>
  </div>
</div>

<div id="page-quanshu" class="page">
  <div class="section-title">
    <span>Quyền thuật</span>
  </div>

  <div class="zhengfu-overview">
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Quan chức</div>
      <div class="zhengfu-metric-value" id="qs-m-office">Không</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Phẩm cấp</div>
      <div class="zhengfu-metric-value" id="qs-m-rank">Không</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Phe phái</div>
      <div class="zhengfu-metric-value" id="qs-m-paixi">0</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Chiêu bài</div>
      <div class="zhengfu-metric-value" id="qs-m-chouma">0</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Chính sách</div>
      <div class="zhengfu-metric-value" id="qs-m-policy">0</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Mật mưu</div>
      <div class="zhengfu-metric-value" id="qs-m-mimou">0</div>
    </div>
  </div>

  <div class="zhengfu-modules">
    <div class="zhengfu-module-card" onclick="openQuanshuModule('office')">
      <div class="zhengfu-module-title">🏛 Quan chức</div>
      <div class="zhengfu-module-sub">Quan chức hiện tại / Phẩm cấp / Phạm vi thực quyền</div>
      <div class="zhengfu-module-badge" id="qs-b-office">—</div>
    </div>

    <div class="zhengfu-module-card" onclick="openQuanshuModule('paixi')">
      <div class="zhengfu-module-title">🧩 Quan hệ phe phái</div>
      <div class="zhengfu-module-sub">Thái độ / Tranh chấp lợi ích / Nhân vật then chốt</div>
      <div class="zhengfu-module-badge" id="qs-b-paixi">0 hạng mục</div>
    </div>

    <div class="zhengfu-module-card" onclick="openQuanshuModule('chouma')">
      <div class="zhengfu-module-title">🪙 Kho chiêu bài</div>
      <div class="zhengfu-module-sub">Loại / Nhân vật liên quan / Trạng thái</div>
      <div class="zhengfu-module-badge" id="qs-b-chouma">0 hạng mục</div>
    </div>

    <div class="zhengfu-module-card" onclick="openQuanshuModule('min')">
      <div class="zhengfu-module-title">📜 Chính sách với dân</div>
      <div class="zhengfu-module-sub">Nội dung / Hiệu quả / Ảnh hưởng lòng dân</div>
      <div class="zhengfu-module-badge" id="qs-b-min">0 điều</div>
    </div>

    <div class="zhengfu-module-card" onclick="openQuanshuModule('jun')">
      <div class="zhengfu-module-title">⚔ Chính sách với quân</div>
      <div class="zhengfu-module-sub">Nội dung / Hiệu quả / Ảnh hưởng lòng quân</div>
      <div class="zhengfu-module-badge" id="qs-b-jun">0 điều</div>
    </div>

    <div class="zhengfu-module-card" onclick="openQuanshuModule('mimou')">
      <div class="zhengfu-module-title">🕯 Mật mưu</div>
      <div class="zhengfu-module-sub">Mục tiêu / Người tham gia / Tiến độ / Rủi ro</div>
      <div class="zhengfu-module-badge" id="qs-b-mimou">0 hạng mục</div>
    </div>
  </div>

  <div class="zhengfu-hidden">
    <div id="quanshu-office"></div>
    <div id="quanshu-paixi"></div>
    <div id="quanshu-chouma"></div>
    <div id="quanshu-min"></div>
    <div id="quanshu-jun"></div>
    <div id="quanshu-mimou"></div>
  </div>
</div>

<div id="page-caizheng" class="page">
  <div class="section-title">
    <span>Tài chính</span>
  </div>

  <div class="zhengfu-overview">
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Phủ khố ngân lượng</div>
      <div class="zhengfu-metric-value" id="cz-silver">0</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Phủ khố quan tiền</div>
      <div class="zhengfu-metric-value" id="cz-copper">0</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Tổng thu nhập</div>
      <div class="zhengfu-metric-value" id="cz-income-total">0</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Tổng chi tiêu</div>
      <div class="zhengfu-metric-value" id="cz-expense-total">0</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Kết dư tháng</div>
      <div class="zhengfu-metric-value" id="cz-balance">0</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Thương lộ / Thương đội / Sản nghiệp</div>
      <div class="zhengfu-metric-value" id="cz-counts">0 / 0 / 0</div>
    </div>
  </div>

  <div class="subsection">
    <div class="subsection-title">▸ Chi tiết thu nhập</div>
    <div id="cz-income-list" class="storage-list"></div>
  </div>

  <div class="subsection">
    <div class="subsection-title">▸ Chi tiết chi tiêu</div>
    <div id="cz-expense-list" class="storage-list"></div>
  </div>

  <div class="subsection">
    <div class="subsection-title">▸ Thương lộ</div>
    <div id="cz-route-list" class="list-container"></div>
  </div>

  <div class="subsection">
    <div class="subsection-title">▸ Thương đội</div>
    <div id="cz-caravan-list" class="list-container"></div>
  </div>

  <div class="subsection">
    <div class="subsection-title">▸ Sản nghiệp</div>
    <div id="cz-industry-list" class="list-container"></div>
  </div>
</div>

<div id="page-tianming" class="page">
  <div class="section-title">
    <span>Thiên mệnh</span>
  </div>

  <div class="zhengfu-overview">
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Giá trị thiên mệnh</div>
      <div class="zhengfu-metric-value" id="tm-m-value">0</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Tuyên bố chủ quyền</div>
      <div class="zhengfu-metric-value" id="tm-m-xuancheng">0</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Điềm lành điềm dữ</div>
      <div class="zhengfu-metric-value" id="tm-m-xiangrui">0</div>
    </div>
    <div class="zhengfu-metric">
      <div class="zhengfu-metric-label">Truyền thuyết dân gian</div>
      <div class="zhengfu-metric-value" id="tm-m-chuanshuo">0</div>
    </div>
    <div class="zhengfu-metric" style="grid-column: span 2;">
      <div class="zhengfu-metric-label">Đánh giá xưng đế</div>
      <div class="zhengfu-metric-value" id="tm-m-eval">Chờ khởi tạo</div>
    </div>
  </div>
  <div class="zhengfu-modules">
    <div class="zhengfu-module-card" onclick="openTianmingModule('value')">
      <div class="zhengfu-module-title">🌟 Giá trị thiên mệnh</div>
      <div class="zhengfu-module-sub">0~100 / Thể hiện xu thế chung</div>
      <div class="zhengfu-module-badge" id="tm-b-value">0</div>
    </div>

    <div class="zhengfu-module-card" onclick="openTianmingModule('xuancheng')">
      <div class="zhengfu-module-title">📣 Tuyên bố chủ quyền</div>
      <div class="zhengfu-module-sub">Mục tiêu / Căn cứ / Độ chấp nhận / Trạng thái</div>
      <div class="zhengfu-module-badge" id="tm-b-xuancheng">0 hạng mục</div>
    </div>

    <div class="zhengfu-module-card" onclick="openTianmingModule('xiangrui')">
      <div class="zhengfu-module-title">🪶 Điềm lành và điềm dữ</div>
      <div class="zhengfu-module-sub">Sự kiện / Tính chất / Phạm vi lan truyền / Có phải do người làm</div>
      <div class="zhengfu-module-badge" id="tm-b-xiangrui">0 hạng mục</div>
    </div>

    <div class="zhengfu-module-card" onclick="openTianmingModule('chuanshuo')">
      <div class="zhengfu-module-title">📖 Truyền thuyết dân gian</div>
      <div class="zhengfu-module-sub">Nội dung / Nguồn gốc / Sức ảnh hưởng</div>
      <div class="zhengfu-module-badge" id="tm-b-chuanshuo">0 hạng mục</div>
    </div>

    <div class="zhengfu-module-card" onclick="openTianmingModule('chengdi')">
      <div class="zhengfu-module-title">👑 Điều kiện xưng đế</div>
      <div class="zhengfu-module-sub">Số châu / Vạn binh / Ủng hộ / Khuyên tiến / Đánh giá</div>
      <div class="zhengfu-module-badge" id="tm-b-chengdi">—</div>
    </div>

    <div class="zhengfu-module-card" onclick="openTianmingModule('nianhao')">
      <div class="zhengfu-module-title">🏷 Niên hiệu và quốc hiệu</div>
      <div class="zhengfu-module-sub">Quốc hiệu dự định / Niên hiệu dự định</div>
      <div class="zhengfu-module-badge" id="tm-b-nianhao">—</div>
    </div>
  </div>

  <div class="zhengfu-hidden">
    <div id="tianming-value"></div>
    <div id="tianming-xuancheng"></div>
    <div id="tianming-xiangrui"></div>
    <div id="tianming-chuanshuo"></div>
    <div id="tianming-chengdi"></div>
    <div id="tianming-nianhao"></div>
  </div>
</div>

<div id="page-guixin" class="page">
  <div class="section-title">
    <span>Hệ thống vạn dân quy tâm</span>
    <div style="display:flex; gap:8px; align-items:center;">
      <button class="section-btn guixin-mini-btn" type="button" onclick="openModal('modal-guixin-income')">Chi tiết thu nhập</button>
      <button class="section-btn" onclick="openModal('modal-guixin')">Xem quy tắc</button>
    </div>
  </div>


  <div class="subsection" style="margin-top:16px;">
  <div class="subsection-title">▸ Lãnh địa cai trị</div>
  <div id="guixin-zhili-list" class="list-container"></div>
</div>
</div>



  <div id="modal-guixin" class="modal-overlay" onclick="if(event.target===this)closeModal('modal-guixin')">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal('modal-guixin')">×</button>
      <div class="modal-title">Quy tắc hệ thống vạn dân quy tâm</div>
      <div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;text-align:center;">Tụ lòng dân, được thiên hạ. Dân số càng nhiều, vật tư càng phong phú.</div>

      <div class="tab-switch guixin-tabs">
        <button class="tab-btn active" data-tab="tab-population" onclick="switchTab('guixin-tabs','tab-population')">Tính đầu người</button>
        <button class="tab-btn" data-tab="tab-daily" onclick="switchTab('guixin-tabs','tab-daily')">Lợi ích hàng ngày</button>
        <button class="tab-btn" data-tab="tab-milestone" onclick="switchTab('guixin-tabs','tab-milestone')">Cột mốc công nghệ</button>
        <button class="tab-btn" data-tab="tab-techlock" onclick="switchTab('guixin-tabs','tab-techlock')">Giới hạn kỹ thuật</button>
      </div>

      <div id="tab-population" class="tab-panel active">
        <div class="rule-block">
          <div class="rule-block-title">✓ Tính vào đầu người</div>
          <ul class="rule-list">
            <li>Bản thân nhân vật chính (luôn tính là 1)</li>
            <li>Gia quyến (thê thiếp, con cái)</li>
            <li>Kẻ hầu ký văn tự bán thân</li>
            <li>Tâm phúc, hộ vệ đã tuyên thệ hiệu trung</li>
            <li>Người làm thuê dài hạn (ký hợp đồng dài hạn, không phải tạm thời)</li>
            <li>Biên hộ tề dân trong lãnh địa (lãnh dân đã đăng ký, nộp thuế)</li>
          </ul>
        </div>
        <div class="rule-block">
          <div class="rule-block-title">✗ Không tính vào đầu người</div>
          <ul class="rule-list exclude">
            <li>Huynh đệ kết bái, đồng minh ngang hàng (không có quan hệ lệ thuộc)</li>
            <li>Người làm thuê tạm thời, ngắn hạn (quan hệ không lâu dài)</li>
            <li>Người qua đường, khách qua đường</li>
            <li>Tù binh chưa thu phục (trừ khi đã tuyên thệ hiệu trung)</li>
            <li>Thương nhân, quan lại có quan hệ hợp tác nhưng không lệ thuộc</li>
          </ul>
        </div>
        <div style="font-size: 11px; color: var(--text-muted); margin-top: 12px; padding: 10px; background: var(--bg-card); border-radius: 6px; border-left: 2px solid var(--gold-secondary);">
          <strong style="color: var(--gold-primary);">Nguyên tắc phán định：</strong>Phải đồng thời thỏa mãn hai điều kiện "quan hệ lệ thuộc" và "trung thành/lâu dài". Khi có nghi ngờ thì phán định nghiêm ngặt (không tính).
        </div>
      </div>

      <div id="tab-daily" class="tab-panel">
        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 14px; text-align: center;">
          Tự động kết toán vào rạng sáng mỗi ngày, vật tư được lưu vào không gian hệ thống (dung lượng vô hạn, không bao giờ hư hỏng)
          
 </div>
<div class="formula-grid">
  <div class="formula-item">
    <div class="formula-name">Gạo thượng hạng (Giống tốt hiện đại)</div>
    <div class="formula-calc">Số người × 2 Cân</div>
  </div>
  <div class="formula-item">
    <div class="formula-name">Thịt tươi (Heo/Bò/Dê)</div>
    <div class="formula-calc">Số người ÷ 2 Cân (làm tròn)</div>
  </div>
  <div class="formula-item">
    <div class="formula-name">Muối tinh thượng hạng</div>
    <div class="formula-calc">Số người ÷ 5 Lạng (làm tròn)</div>
  </div>
  <div class="formula-item">
    <div class="formula-name">Dầu ăn nguyên chất (Dầu đậu/Dầu cải)</div>
    <div class="formula-calc">Số người ÷ 10 Lạng (làm tròn)</div>
  </div>
  <div class="formula-item">
    <div class="formula-name">Vải thô bền</div>
    <div class="formula-calc">Số người ÷ 50 × 10 Thước</div>
  </div>
  <div class="formula-item">
    <div class="formula-name">Lụa thượng hạng</div>
    <div class="formula-calc">Số người ÷ 100 × 5 Thước</div>
  </div>
  <div class="formula-item">
    <div class="formula-name">Thức ăn chăn nuôi thượng hạng / Thức ăn tinh</div>
    <div class="formula-calc">Số người ÷ 200 Phần (Khẩu phần 1 ngày cho 5 con ngựa)</div>
  </div>
  <div class="formula-item">
    <div class="formula-name">Than củi không khói chất lượng cao</div>
    <div class="formula-calc">Số người ÷ 500 × 50 Cân</div>
  </div>
</div>
</div>

      <div id="tab-milestone" class="tab-panel">
        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 14px; text-align: center;">
          Phát một lần khi lần đầu đạt số người quy định, nghiêm ngặt giới hạn trong cây công nghệ phong kiến
        </div>
        <div id="milestone-list" class="milestone-list"></div>
      </div>

      <div id="tab-techlock" class="tab-panel">
        <div class="tech-lock-notice">
          <div class="tech-lock-title">⚠ Khóa công nghệ thời đại phong kiến</div>
          <div class="tech-lock-content">
            Hệ thống tuân thủ nghiêm ngặt trình độ công nghệ thời đại phong kiến, tất cả vật tư thưởng và sách kỹ thuật đều nằm trong khuôn khổ này.
          </div>
        </div>
        <div class="rule-block">
          <div class="rule-block-title" style="color: var(--jade-green);">✓ Công nghệ cho phép</div>
          <ul class="rule-list">
            <li>Kỹ thuật nông nghiệp (chọn giống, ghép cành, tưới tiêu thủy lợi)</li>
            <li>Thủ công nghiệp (dệt, gốm, mộc)</li>
            <li>Binh khí lạnh (đao kiếm, cung nỏ, giáp trụ)</li>
            <li>Luyện kim truyền thống (phương pháp tưới thép, xào thép, thép trăm luyện)</li>
            <li>Y học cổ truyền (thảo dược, châm cứu, phòng dịch)</li>
            <li>Kiến trúc truyền thống (tường thành, ông thành, tháp canh)</li>
          </ul>
        </div>
        <div class="rule-block">
          <div class="rule-block-title" style="color: #e88080;">✗ Công nghệ bị cấm</div>
          <ul class="rule-list exclude">
            <li>Vũ khí hỏa dược (súng hỏa mai, đại bác, thuốc nổ)</li>
            <li>Thép hiện đại (luyện thép công nghiệp hóa)</li>
            <li>Xi măng, bê tông</li>
            <li>Máy hơi nước, động cơ đốt trong</li>
            <li>Điện lực và thiết bị điện</li>
            <li>Tất cả sản phẩm cận hiện đại</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
<div id="modal-guixin-income" class="modal-overlay" onclick="if(event.target===this)closeModal('modal-guixin-income')">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('modal-guixin-income')">×</button>
    <div class="modal-title">Quy tâm · Chi tiết thu nhập</div>

    <div class="guixin-panel" id="guixin-panel">
      <div class="guixin-title">Số người quy tâm hiện tại</div>
      <div class="guixin-count" id="guixin-count">1</div>
      <div class="guixin-label">Người</div>
      <div class="guixin-divider"></div>

      <div class="guixin-details" id="guixin-details">
        <div class="daily-rewards" style="margin-bottom: 20px;">
          <div class="daily-title">▸ Cấu thành dân số</div>
          <div class="reward-grid">
            <div class="reward-item"><span class="reward-name">Nhân vật chính</span><span class="reward-amount" id="guixin-zhujue">1</span></div>
            <div class="reward-item"><span class="reward-name">Gia quyến</span><span class="reward-amount" id="guixin-jiajuan">0</span></div>
            <div class="reward-item"><span class="reward-name">Kẻ hầu</span><span class="reward-amount" id="guixin-pucong">0</span></div>
            <div class="reward-item"><span class="reward-name">Hộ vệ</span><span class="reward-amount" id="guixin-huwei">0</span></div>
            <div class="reward-item" style="grid-column: span 2;"><span class="reward-name">Lãnh dân</span><span class="reward-amount" id="guixin-lingmin">0</span></div>
          </div>
        </div>

        <div class="daily-rewards">
          <div class="daily-title">▸ Sản lượng mỗi ngày</div>
          <div class="reward-grid">
            <div class="reward-item"><span class="reward-name">Gạo thượng hạng</span><span class="reward-amount" id="reward-rice">1 Cân</span></div>
            <div class="reward-item"><span class="reward-name">Thịt tươi</span><span class="reward-amount" id="reward-meat">0 Cân</span></div>
            <div class="reward-item"><span class="reward-name">Muối tinh thượng hạng</span><span class="reward-amount" id="reward-salt">0 Lạng</span></div>
            <div class="reward-item"><span class="reward-name">Dầu ăn</span><span class="reward-amount" id="reward-oil">0 Lạng</span></div>
            <div class="reward-item"><span class="reward-name">Vải thô bền</span><span class="reward-amount" id="reward-cloth">0 Thước</span></div>
            <div class="reward-item"><span class="reward-name">Lụa thượng hạng</span><span class="reward-amount" id="reward-silk">0 Thước</span></div>
            <div class="reward-item"><span class="reward-name">Thức ăn chăn nuôi thượng hạng</span><span class="reward-amount" id="reward-fodder">0 Phần</span></div>
            <div class="reward-item"><span class="reward-name">Than củi không khói</span><span class="reward-amount" id="reward-charcoal">0 Cân</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="btn-group" style="margin-top:18px;">
      <button class="btn" onclick="closeModal('modal-guixin-income')">Quay lại Quy tâm</button>
    </div>
  </div>
</div>

<div id="modal-renmai-profile" class="modal-overlay" onclick="if(event.target===this)closeModal('modal-renmai-profile')">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('modal-renmai-profile')">×</button>
    <div class="modal-title" id="renmai-profile-modal-title">Hồ sơ nhân vật</div>

    <div id="renmai-profile-content" class="renmai-profile"></div>

    <div class="btn-group renmai-profile-actions">
      <button class="btn" onclick="closeModal('modal-renmai-profile')">Quay lại danh sách nhân mạch</button>
    </div>
  </div>
</div>

<div id="modal-hongyan" class="modal-overlay" onclick="if(event.target===this)closeModal('modal-hongyan')">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('modal-hongyan')">×</button>
    <div class="modal-title">Hồng nhan tri kỷ</div>
    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;text-align:center;">
      Nhấn vào nhân vật để xem chi tiết
    </div>
    <div id="hongyan-list" class="list-container"></div>
  </div>
</div>

<div id="modal-wushuang-module" class="modal-overlay" onclick="if(event.target===this)closeModal('modal-wushuang-module')">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('modal-wushuang-module')">×</button>
    <div class="modal-title" id="wushuang-module-title">Chi tiết Vô Song</div>
    <div id="wushuang-module-body"></div>

    <div class="btn-group" style="margin-top: 18px;">
      <button class="btn" onclick="closeModal('modal-wushuang-module')">Quay lại Vô Song</button>
    </div>
  </div>
</div>

  <div id="modal-zhengfu-module" class="modal-overlay" onclick="if(event.target===this)closeModal('modal-zhengfu-module')">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('modal-zhengfu-module')">×</button>
    <div class="modal-title" id="zhengfu-module-title">Chi tiết mô-đun</div>
    <div id="zhengfu-module-body"></div>

    <div class="btn-group" style="margin-top: 18px;">
      <button class="btn" onclick="closeModal('modal-zhengfu-module')">Quay lại mô-đun Chinh phục</button>
    </div>
  </div>
</div>

<div id="easter-layer"></div>


<div id="modal-quanshu-module" class="modal-overlay" onclick="if(event.target===this)closeModal('modal-quanshu-module')">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('modal-quanshu-module')">×</button>
    <div class="modal-title" id="quanshu-module-title">Chi tiết mô-đun</div>
    <div id="quanshu-module-body"></div>

<div class="btn-group" style="margin-top: 18px;">
  <button class="btn" onclick="closeModal('modal-quanshu-module')">Quay lại Quyền thuật</button>
</div>
  </div>
</div>

<div id="modal-tianming-module" class="modal-overlay" onclick="if(event.target===this)closeModal('modal-tianming-module')">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('modal-tianming-module')">×</button>
    <div class="modal-title" id="tianming-module-title">Chi tiết mô-đun</div>
    <div id="tianming-module-body"></div>

<div class="btn-group" style="margin-top: 18px;">
  <button class="btn" onclick="closeModal('modal-tianming-module')">Quay lại Thiên mệnh</button>
</div>
  </div>
</div>

</body>
</html>